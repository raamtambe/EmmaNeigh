name: Build EmmaNeigh

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          cd desktop-app/python
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build Python executables
        run: |
          cd desktop-app/python
          pyinstaller --onefile --name signature_packets signature_packets.py
          pyinstaller --onefile --name execution_version execution_version.py
          pyinstaller --onefile --name checklist_parser checklist_parser.py
          pyinstaller --onefile --name incumbency_parser incumbency_parser.py
          pyinstaller --onefile --name sigblock_workflow sigblock_workflow.py
          pyinstaller --onefile --name document_collator document_collator.py

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install npm dependencies
        run: |
          cd desktop-app
          npm install

      - name: Prepare resources
        run: |
          mkdir -p desktop-app/resources/win
          cp desktop-app/python/dist/signature_packets.exe desktop-app/resources/win/
          cp desktop-app/python/dist/execution_version.exe desktop-app/resources/win/
          cp desktop-app/python/dist/checklist_parser.exe desktop-app/resources/win/
          cp desktop-app/python/dist/incumbency_parser.exe desktop-app/resources/win/
          cp desktop-app/python/dist/sigblock_workflow.exe desktop-app/resources/win/
          cp desktop-app/python/dist/document_collator.exe desktop-app/resources/win/
        shell: bash

      - name: Build Electron app
        run: |
          cd desktop-app
          npx electron-builder --win portable --publish never

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: EmmaNeigh-Windows
          path: desktop-app/dist/EmmaNeigh-Portable.exe

  build-mac:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          cd desktop-app/python
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build Python executables
        run: |
          cd desktop-app/python
          pyinstaller --onefile --name signature_packets signature_packets.py
          pyinstaller --onefile --name execution_version execution_version.py
          pyinstaller --onefile --name checklist_parser checklist_parser.py
          pyinstaller --onefile --name incumbency_parser incumbency_parser.py
          pyinstaller --onefile --name sigblock_workflow sigblock_workflow.py
          pyinstaller --onefile --name document_collator document_collator.py

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install npm dependencies
        run: |
          cd desktop-app
          npm install

      - name: Prepare resources
        run: |
          mkdir -p desktop-app/resources/mac
          cp desktop-app/python/dist/signature_packets desktop-app/resources/mac/
          cp desktop-app/python/dist/execution_version desktop-app/resources/mac/
          cp desktop-app/python/dist/checklist_parser desktop-app/resources/mac/
          cp desktop-app/python/dist/incumbency_parser desktop-app/resources/mac/
          cp desktop-app/python/dist/sigblock_workflow desktop-app/resources/mac/
          cp desktop-app/python/dist/document_collator desktop-app/resources/mac/
          chmod +x desktop-app/resources/mac/signature_packets
          chmod +x desktop-app/resources/mac/execution_version
          chmod +x desktop-app/resources/mac/checklist_parser
          chmod +x desktop-app/resources/mac/incumbency_parser
          chmod +x desktop-app/resources/mac/sigblock_workflow
          chmod +x desktop-app/resources/mac/document_collator

      - name: Build Electron app
        run: |
          cd desktop-app
          npx electron-builder --mac --publish never

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: EmmaNeigh-Mac
          path: desktop-app/dist/*.dmg

  create-release:
    needs: [build-windows, build-mac]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: EmmaNeigh-Windows
          path: ./artifacts

      - name: Download Mac artifact
        uses: actions/download-artifact@v4
        with:
          name: EmmaNeigh-Mac
          path: ./artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/*
          body: |
            ## EmmaNeigh v4.1.1 - Document Collation

            ### Downloads
            - **Windows**: Download `EmmaNeigh-Portable.exe` - just double-click to run
            - **Mac**: Download the `.dmg` file

            ### What's New in v4.1.1
            - **Collate Tab**: Merge track changes and comments from multiple document versions
              - Upload a base document and multiple commented versions
              - Integrates track changes (insertions/deletions) from all versions
              - Extracts and includes comment bubbles
              - Detects conflicts when different versions modify the same content
              - Generates summary table showing each author's contributions
              - 100% local processing - no LLM or cloud services required

            ### Previous Features
            - **Liability Disclaimer**: Terms of use modal on first launch (v4.1.0)
            - **User Profiles**: Click your name to set a display name (v4.1.0)
            - **Auto-Update**: App notifies you when updates are available (v4.1.0)
            - **Signature Blocks Tab**: Generate signature blocks from checklists and incumbency certificates
            - **Signature Packets Tab**: Extract and organize signature pages by signer
            - **Execution Version Tab**: Merge signed DocuSign pages back into originals

            ### How to Use

            **Collate Tab:**
            1. Upload your base document (.docx)
            2. Upload commented versions from different reviewers
            3. Click "Collate Documents"
            4. Review conflict flags and download merged document with summary

            **Signature Blocks Tab:**
            1. Upload your transaction checklist (.xlsx or .csv)
            2. Upload incumbency certificates (.pdf or .docx)
            3. Map each entity to its role and select the authorized signer
            4. Upload folder with unsigned documents
            5. Click "Generate Signature Blocks"
            6. Download ZIP or click "Create Signature Packets" to continue

            **Signature Packets Tab:**
            1. Drop a folder containing PDFs/DOCX onto the app
            2. Wait for processing
            3. Download your ZIP file with signature packets organized by signer

            **Execution Version Tab:**
            1. Select folder containing original unsigned agreements
            2. Select the signed PDF from DocuSign
            3. Click "Create Execution Versions"
            4. Download ZIP with executed documents

            ### Security
            - 100% local processing - no data leaves your machine
            - No internet connection required (except for update checks)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
