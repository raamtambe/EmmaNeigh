<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EmmaNeigh</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    @font-face {
      font-family: 'SF Pro';
      src: local('-apple-system'), local('BlinkMacSystemFont'), local('Segoe UI');
    }

    body {
      font-family: 'SF Pro', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0a0a0a;
      color: #fafafa;
      height: 100vh;
      overflow: hidden;
      -webkit-app-region: drag;
    }

    .container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      padding: 60px 40px 40px;
    }

    header {
      margin-bottom: 32px;
    }

    .logo {
      font-size: 13px;
      font-weight: 500;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: #666;
      margin-bottom: 8px;
    }

    h1 {
      font-size: 28px;
      font-weight: 600;
      letter-spacing: -0.02em;
    }

    .subtitle {
      font-size: 14px;
      color: #666;
      margin-top: 6px;
    }

    .drop-zone {
      flex: 1;
      border: 1px dashed #333;
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      cursor: pointer;
      -webkit-app-region: no-drag;
      min-height: 200px;
    }

    .drop-zone:hover {
      border-color: #444;
      background: rgba(255,255,255,0.02);
    }

    .drop-zone.active {
      border-color: #fff;
      background: rgba(255,255,255,0.05);
    }

    .drop-zone.disabled {
      pointer-events: none;
      opacity: 0.5;
    }

    .drop-icon {
      width: 48px;
      height: 48px;
      margin-bottom: 16px;
      opacity: 0.4;
    }

    .drop-text {
      font-size: 15px;
      color: #888;
      text-align: center;
    }

    .drop-text span {
      color: #fff;
      text-decoration: underline;
      text-underline-offset: 2px;
    }

    .drop-hint {
      font-size: 12px;
      color: #555;
      margin-top: 8px;
    }

    /* Processing State */
    .processing {
      flex: 1;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .processing.visible {
      display: flex;
    }

    .horse-container {
      width: 120px;
      height: 60px;
      margin-bottom: 24px;
      position: relative;
    }

    .horse {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      animation: gallop 0.4s ease-in-out infinite;
    }

    @keyframes gallop {
      0%, 100% { transform: translateX(-50%) translateY(0); }
      50% { transform: translateX(-50%) translateY(-6px); }
    }

    .horse svg {
      width: 80px;
      height: 50px;
      fill: #fff;
      opacity: 0.9;
    }

    .dust {
      position: absolute;
      bottom: 0;
      left: 20%;
      display: flex;
      gap: 4px;
    }

    .dust-particle {
      width: 4px;
      height: 4px;
      background: #444;
      border-radius: 50%;
      animation: dust 0.6s ease-out infinite;
    }

    .dust-particle:nth-child(2) { animation-delay: 0.1s; }
    .dust-particle:nth-child(3) { animation-delay: 0.2s; }

    @keyframes dust {
      0% { transform: translate(0, 0) scale(1); opacity: 0.6; }
      100% { transform: translate(-12px, -4px) scale(0.3); opacity: 0; }
    }

    .progress-text {
      font-size: 14px;
      color: #888;
      text-align: center;
    }

    .progress-bar {
      width: 200px;
      height: 2px;
      background: #222;
      border-radius: 1px;
      margin-top: 16px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: #fff;
      transition: width 0.3s ease;
    }

    /* Complete State */
    .complete {
      flex: 1;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .complete.visible {
      display: flex;
    }

    .check-icon {
      width: 48px;
      height: 48px;
      margin-bottom: 20px;
      color: #22c55e;
    }

    .complete h2 {
      font-size: 20px;
      font-weight: 500;
      margin-bottom: 8px;
    }

    .complete p {
      font-size: 14px;
      color: #666;
      margin-bottom: 24px;
    }

    .btn {
      padding: 12px 24px;
      font-size: 14px;
      font-weight: 500;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.15s ease;
      -webkit-app-region: no-drag;
    }

    .btn-primary {
      background: #fff;
      color: #000;
    }

    .btn-primary:hover {
      background: #e5e5e5;
    }

    .btn-secondary {
      background: transparent;
      color: #888;
      border: 1px solid #333;
      margin-top: 12px;
    }

    .btn-secondary:hover {
      border-color: #555;
      color: #fff;
    }

    /* Error State */
    .error {
      flex: 1;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .error.visible {
      display: flex;
    }

    .error-icon {
      width: 48px;
      height: 48px;
      margin-bottom: 20px;
      color: #ef4444;
    }

    .error h2 {
      font-size: 20px;
      font-weight: 500;
      margin-bottom: 8px;
    }

    .error p {
      font-size: 14px;
      color: #666;
      margin-bottom: 24px;
      text-align: center;
      max-width: 300px;
    }

    footer {
      margin-top: 24px;
      text-align: center;
    }

    footer p {
      font-size: 11px;
      color: #444;
    }

    /* Coming Soon */
    /* Tabs */
    .tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 24px;
      background: #111;
      padding: 4px;
      border-radius: 8px;
      -webkit-app-region: no-drag;
    }

    .tab {
      flex: 1;
      padding: 10px 16px;
      font-size: 13px;
      font-weight: 500;
      color: #666;
      background: transparent;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .tab:hover {
      color: #888;
    }

    .tab.active {
      background: #222;
      color: #fff;
    }

    /* Execution Version UI */
    .exec-inputs {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .input-section {
      border: 1px dashed #333;
      border-radius: 12px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      cursor: pointer;
      -webkit-app-region: no-drag;
      min-height: 100px;
    }

    .input-section:hover {
      border-color: #444;
      background: rgba(255,255,255,0.02);
    }

    .input-section.active {
      border-color: #fff;
      background: rgba(255,255,255,0.05);
    }

    .input-section.selected {
      border-color: #22c55e;
      border-style: solid;
    }

    .input-section.disabled {
      pointer-events: none;
      opacity: 0.5;
    }

    .input-icon {
      width: 32px;
      height: 32px;
      margin-bottom: 12px;
      opacity: 0.4;
    }

    .input-label {
      font-size: 14px;
      font-weight: 500;
      color: #fff;
      margin-bottom: 4px;
    }

    .input-hint {
      font-size: 12px;
      color: #555;
    }

    .input-selected {
      font-size: 12px;
      color: #22c55e;
      margin-top: 8px;
      word-break: break-all;
      text-align: center;
      max-width: 100%;
    }

    .exec-actions {
      margin-top: 16px;
      display: flex;
      justify-content: center;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Results summary */
    .result-summary {
      font-size: 13px;
      color: #888;
      margin-top: 8px;
      text-align: center;
    }

    /* Signature Blocks Tab Styles */
    .sigblock-step {
      margin-bottom: 16px;
    }

    .sigblock-step-header {
      font-size: 13px;
      font-weight: 500;
      color: #888;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .sigblock-step-header .step-number {
      width: 20px;
      height: 20px;
      background: #222;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      color: #666;
    }

    .sigblock-step-header.done .step-number {
      background: #22c55e;
      color: #fff;
    }

    .entity-mapping {
      background: #111;
      border-radius: 8px;
      padding: 12px;
      max-height: 200px;
      overflow-y: auto;
    }

    .entity-row {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 0;
      border-bottom: 1px solid #222;
    }

    .entity-row:last-child {
      border-bottom: none;
    }

    .entity-name {
      flex: 1;
      font-size: 13px;
      color: #fff;
    }

    .entity-arrow {
      color: #444;
      font-size: 14px;
    }

    .entity-select {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 6px;
      padding: 6px 10px;
      font-size: 12px;
      color: #fff;
      min-width: 140px;
      -webkit-app-region: no-drag;
    }

    .entity-select:focus {
      outline: none;
      border-color: #555;
    }

    .signer-select {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 6px;
      padding: 6px 10px;
      font-size: 12px;
      color: #888;
      min-width: 160px;
      -webkit-app-region: no-drag;
    }

    .sigblock-results {
      background: #111;
      border-radius: 8px;
      padding: 16px;
      margin-top: 12px;
    }

    .sigblock-result-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 0;
      font-size: 13px;
      color: #888;
    }

    .sigblock-result-item svg {
      width: 16px;
      height: 16px;
      color: #22c55e;
    }

    .btn-row {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-top: 16px;
    }

    .btn-flow {
      background: #22c55e;
      color: #000;
    }

    .btn-flow:hover {
      background: #16a34a;
    }

    .no-data-msg {
      font-size: 13px;
      color: #555;
      text-align: center;
      padding: 16px;
    }

    /* Modal Overlay */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      -webkit-app-region: no-drag;
    }

    .modal-overlay.hidden {
      display: none;
    }

    .modal {
      background: #111;
      border: 1px solid #333;
      border-radius: 16px;
      padding: 32px;
      max-width: 480px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal h2 {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 16px;
      color: #fff;
    }

    .modal-content {
      font-size: 13px;
      color: #999;
      line-height: 1.6;
      margin-bottom: 24px;
    }

    .modal-content p {
      margin-bottom: 12px;
    }

    .modal-content strong {
      color: #fff;
    }

    .modal-actions {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .modal-actions .btn {
      width: 100%;
      text-align: center;
    }

    /* Update banner */
    .update-banner {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 12px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      z-index: 900;
      -webkit-app-region: no-drag;
    }

    .update-banner.hidden {
      display: none;
    }

    .update-banner p {
      font-size: 13px;
      color: #888;
    }

    .update-banner .btn {
      padding: 8px 16px;
      font-size: 12px;
    }

    /* User info in header */
    .user-info {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: #666;
      -webkit-app-region: no-drag;
      cursor: pointer;
    }

    .user-info:hover {
      color: #888;
    }

    .user-avatar {
      width: 24px;
      height: 24px;
      background: #222;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    /* Collate Tab Styles */
    .file-list {
      background: #111;
      border-radius: 8px;
      padding: 8px;
      max-height: 120px;
      overflow-y: auto;
      margin-top: 8px;
    }

    .file-list-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 8px;
      font-size: 12px;
      color: #888;
      border-bottom: 1px solid #222;
    }

    .file-list-item:last-child {
      border-bottom: none;
    }

    .file-list-item .remove-btn {
      background: none;
      border: none;
      color: #666;
      cursor: pointer;
      padding: 2px 6px;
      font-size: 14px;
      -webkit-app-region: no-drag;
    }

    .file-list-item .remove-btn:hover {
      color: #ef4444;
    }

    .collate-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-top: 12px;
    }

    .stat-box {
      background: #111;
      border-radius: 8px;
      padding: 12px;
      text-align: center;
    }

    .stat-value {
      font-size: 24px;
      font-weight: 600;
      color: #fff;
    }

    .stat-label {
      font-size: 11px;
      color: #666;
      margin-top: 4px;
    }

    .stat-value.warning {
      color: #f59e0b;
    }

    .stat-value.error {
      color: #ef4444;
    }

    .conflict-list {
      background: #1a1a1a;
      border: 1px solid #ef4444;
      border-radius: 8px;
      padding: 12px;
      margin-top: 12px;
      max-height: 150px;
      overflow-y: auto;
    }

    .conflict-item {
      font-size: 12px;
      color: #f59e0b;
      padding: 6px 0;
      border-bottom: 1px solid #333;
    }

    .conflict-item:last-child {
      border-bottom: none;
    }

    /* Tab scrolling */
    #packetsTab,
    #executionTab,
    #sigblocksTab,
    #collateTab {
      overflow-y: auto;
      flex: 1;
      padding-bottom: 40px;
    }

    .tabs {
      flex-shrink: 0;
    }

    /* File count badge */
    .file-count {
      font-size: 12px;
      color: #22c55e;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <!-- Disclaimer Modal -->
  <div class="modal-overlay" id="disclaimerModal">
    <div class="modal">
      <h2>Terms of Use</h2>
      <div class="modal-content">
        <p><strong>DISCLAIMER:</strong> EmmaNeigh is provided "as is" without warranty of any kind, express or implied.</p>
        <p>By using this software, you acknowledge and agree that:</p>
        <p>1. This tool is intended to assist with document processing and signature management. It does not constitute legal advice.</p>
        <p>2. You are solely responsible for reviewing and verifying all output documents before use.</p>
        <p>3. The developers and publishers of EmmaNeigh shall not be liable for any damages, losses, or legal issues arising from the use of this software.</p>
        <p>4. All document processing occurs locally on your machine. No data is transmitted to external servers.</p>
        <p>5. You agree to use this software in compliance with all applicable laws and regulations.</p>
      </div>
      <div class="modal-actions">
        <button class="btn btn-primary" id="acceptDisclaimerBtn">I Accept</button>
        <button class="btn btn-secondary" id="declineDisclaimerBtn">Decline & Exit</button>
      </div>
    </div>
  </div>

  <!-- Update Banner -->
  <div class="update-banner hidden" id="updateBanner">
    <p id="updateMessage">A new version is available!</p>
    <button class="btn btn-primary" id="updateBtn">Update Now</button>
    <button class="btn btn-secondary" id="dismissUpdateBtn" style="margin-top: 0;">Later</button>
  </div>

  <div class="container">
    <header>
      <div class="header-row">
        <div class="logo">EmmaNeigh</div>
        <div class="user-info" id="userInfo">
          <div class="user-avatar">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
              <circle cx="12" cy="7" r="4"/>
            </svg>
          </div>
          <span id="userName">Guest</span>
        </div>
      </div>
      <div class="tabs">
        <button class="tab active" data-tab="packets">Signature Packets</button>
        <button class="tab" data-tab="execution">Execution Version</button>
        <button class="tab" data-tab="sigblocks">Signature Blocks</button>
        <button class="tab" data-tab="collate">Collate</button>
      </div>
    </header>

    <!-- Signature Packets Tab -->
    <div id="packetsTab">

    <!-- Drop Zone -->
    <div class="drop-zone" id="dropZone">
      <svg class="drop-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <path d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5"/>
      </svg>
      <p class="drop-text">Drop folder or PDFs here, or <span>browse</span></p>
      <p class="drop-hint">Accepts a folder or individual PDF files with signature pages</p>
      <p class="file-count" id="packetsFileCount"></p>
    </div>

    <!-- Processing -->
    <div class="processing" id="processing">
      <div class="horse-container">
        <div class="horse">
          <svg viewBox="0 0 100 62" xmlns="http://www.w3.org/2000/svg">
            <!-- Body -->
            <ellipse cx="50" cy="35" rx="28" ry="16"/>
            <!-- Neck -->
            <path d="M 70 28 Q 82 18 85 8 Q 90 16 84 28 Q 78 32 70 32 Z"/>
            <!-- Head -->
            <ellipse cx="88" cy="8" rx="11" ry="7"/>
            <!-- Ear -->
            <path d="M 94 2 L 97 -4 L 96 3 Z"/>
            <!-- Eye -->
            <circle cx="92" cy="6" r="1.5" fill="#0a0a0a"/>
            <!-- Mane -->
            <path d="M 84 10 Q 78 4 76 14 Q 72 8 70 18" fill="none" stroke="#fff" stroke-width="2.5" stroke-linecap="round"/>
            <!-- Tail -->
            <path d="M 22 35 Q 10 32 6 42 Q 12 38 14 46" fill="none" stroke="#fff" stroke-width="3" stroke-linecap="round"/>
            <!-- Front legs -->
            <g class="front-legs">
              <rect x="62" y="46" width="5" height="14" rx="2"/>
              <rect x="54" y="46" width="5" height="14" rx="2"/>
            </g>
            <!-- Back legs -->
            <g class="back-legs">
              <rect x="38" y="46" width="5" height="14" rx="2"/>
              <rect x="30" y="46" width="5" height="14" rx="2"/>
            </g>
          </svg>
        </div>
        <div class="dust">
          <div class="dust-particle"></div>
          <div class="dust-particle"></div>
          <div class="dust-particle"></div>
        </div>
      </div>
      <p class="progress-text" id="progressText">Processing...</p>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
      </div>
    </div>

    <!-- Complete -->
    <div class="complete" id="complete">
      <svg class="check-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
      </svg>
      <h2>Complete</h2>
      <p id="resultText">Created 0 signature packets</p>
      <button class="btn btn-primary" id="downloadBtn">Download ZIP</button>
      <button class="btn btn-secondary" id="resetBtn">Process Another</button>
    </div>

    <!-- Error -->
    <div class="error" id="error">
      <svg class="error-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z"/>
      </svg>
      <h2>Error</h2>
      <p id="errorText">Something went wrong</p>
      <button class="btn btn-secondary" id="retryBtn">Try Again</button>
    </div>
    </div><!-- End packetsTab -->

    <!-- Execution Version Tab -->
    <div id="executionTab" style="display: none;">
      <!-- Execution Inputs -->
      <div class="exec-inputs" id="execInputs">
        <p class="subtitle" style="margin-bottom: 8px;">Merge signed DocuSign pages back into original agreements</p>

        <div class="input-section" id="originalsInput">
          <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M2.25 12.75V12A2.25 2.25 0 014.5 9.75h15A2.25 2.25 0 0121.75 12v.75m-8.69-6.44l-2.12-2.12a1.5 1.5 0 00-1.061-.44H4.5A2.25 2.25 0 002.25 6v12a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9a2.25 2.25 0 00-2.25-2.25h-5.379a1.5 1.5 0 01-1.06-.44z"/>
          </svg>
          <p class="input-label">Original Agreements</p>
          <p class="input-hint">Folder or individual PDF files</p>
          <p class="input-selected" id="originalsSelected"></p>
        </div>

        <div class="input-section" id="signedInput">
          <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z"/>
          </svg>
          <p class="input-label">Signed PDF from DocuSign</p>
          <p class="input-hint">Single PDF with all signed pages</p>
          <p class="input-selected" id="signedSelected"></p>
        </div>

        <div class="exec-actions">
          <button class="btn btn-primary" id="processExecBtn" disabled>Create Execution Versions</button>
        </div>
      </div>

      <!-- Execution Processing -->
      <div class="processing" id="execProcessing">
        <div class="horse-container">
          <div class="horse">
            <svg viewBox="0 0 100 62" xmlns="http://www.w3.org/2000/svg">
              <ellipse cx="50" cy="35" rx="28" ry="16"/>
              <path d="M 70 28 Q 82 18 85 8 Q 90 16 84 28 Q 78 32 70 32 Z"/>
              <ellipse cx="88" cy="8" rx="11" ry="7"/>
              <path d="M 94 2 L 97 -4 L 96 3 Z"/>
              <circle cx="92" cy="6" r="1.5" fill="#0a0a0a"/>
              <path d="M 84 10 Q 78 4 76 14 Q 72 8 70 18" fill="none" stroke="#fff" stroke-width="2.5" stroke-linecap="round"/>
              <path d="M 22 35 Q 10 32 6 42 Q 12 38 14 46" fill="none" stroke="#fff" stroke-width="3" stroke-linecap="round"/>
              <g class="front-legs">
                <rect x="62" y="46" width="5" height="14" rx="2"/>
                <rect x="54" y="46" width="5" height="14" rx="2"/>
              </g>
              <g class="back-legs">
                <rect x="38" y="46" width="5" height="14" rx="2"/>
                <rect x="30" y="46" width="5" height="14" rx="2"/>
              </g>
            </svg>
          </div>
          <div class="dust">
            <div class="dust-particle"></div>
            <div class="dust-particle"></div>
            <div class="dust-particle"></div>
          </div>
        </div>
        <p class="progress-text" id="execProgressText">Processing...</p>
        <div class="progress-bar">
          <div class="progress-fill" id="execProgressFill" style="width: 0%"></div>
        </div>
      </div>

      <!-- Execution Complete -->
      <div class="complete" id="execComplete">
        <svg class="check-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        <h2>Complete</h2>
        <p id="execResultText">Created 0 executed documents</p>
        <p class="result-summary" id="execResultSummary"></p>
        <button class="btn btn-primary" id="execDownloadBtn">Download ZIP</button>
        <button class="btn btn-secondary" id="execResetBtn">Process Another</button>
      </div>

      <!-- Execution Error -->
      <div class="error" id="execError">
        <svg class="error-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z"/>
        </svg>
        <h2>Error</h2>
        <p id="execErrorText">Something went wrong</p>
        <button class="btn btn-secondary" id="execRetryBtn">Try Again</button>
      </div>
    </div><!-- End executionTab -->

    <!-- Signature Blocks Tab -->
    <div id="sigblocksTab" style="display: none;">
      <!-- Input Steps -->
      <div id="sigblocksInputs" class="exec-inputs">
        <p class="subtitle" style="margin-bottom: 8px;">Generate signature blocks from checklist and incumbency certificates</p>

        <!-- Step 1: Checklist -->
        <div class="sigblock-step">
          <div class="sigblock-step-header" id="checklistHeader">
            <span class="step-number">1</span>
            Transaction Checklist
          </div>
          <div class="input-section" id="checklistInput">
            <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M3.375 19.5h17.25m-17.25 0a1.125 1.125 0 01-1.125-1.125M3.375 19.5h7.5c.621 0 1.125-.504 1.125-1.125m-9.75 0V5.625m0 12.75v-1.5c0-.621.504-1.125 1.125-1.125m18.375 2.625V5.625m0 12.75c0 .621-.504 1.125-1.125 1.125m1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125m0 3.75h-7.5A1.125 1.125 0 0112 18.375m9.75-12.75c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125m19.5 0v1.5c0 .621-.504 1.125-1.125 1.125M2.25 5.625v1.5c0 .621.504 1.125 1.125 1.125m0 0h17.25m-17.25 0h7.5c.621 0 1.125.504 1.125 1.125M3.375 8.25c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125m17.25-3.75h-7.5c-.621 0-1.125.504-1.125 1.125m8.625-1.125c.621 0 1.125.504 1.125 1.125v1.5c0 .621-.504 1.125-1.125 1.125"/>
            </svg>
            <p class="input-label">Drop checklist here (.xlsx, .csv)</p>
            <p class="input-hint">Should have Document and Signatories columns</p>
            <p class="input-selected" id="checklistSelected"></p>
          </div>
        </div>

        <!-- Step 2: Incumbency Certificates -->
        <div class="sigblock-step">
          <div class="sigblock-step-header" id="incumbencyHeader">
            <span class="step-number">2</span>
            Incumbency Certificates
          </div>
          <div class="input-section" id="incumbencyInput">
            <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z"/>
            </svg>
            <p class="input-label">Drop incumbency certs here (.pdf, .docx)</p>
            <p class="input-hint">Multiple files supported - one per entity</p>
            <p class="input-selected" id="incumbencySelected"></p>
          </div>
        </div>

        <!-- Step 3: Entity Mapping -->
        <div class="sigblock-step" id="mappingStep" style="display: none;">
          <div class="sigblock-step-header">
            <span class="step-number">3</span>
            Entity Mapping
          </div>
          <div class="entity-mapping" id="entityMapping">
            <!-- Populated dynamically -->
          </div>
        </div>

        <!-- Step 4: Documents -->
        <div class="sigblock-step" id="documentsStep" style="display: none;">
          <div class="sigblock-step-header" id="documentsHeader">
            <span class="step-number">4</span>
            Unsigned Documents
          </div>
          <div class="input-section" id="documentsInput">
            <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M2.25 12.75V12A2.25 2.25 0 014.5 9.75h15A2.25 2.25 0 0121.75 12v.75m-8.69-6.44l-2.12-2.12a1.5 1.5 0 00-1.061-.44H4.5A2.25 2.25 0 002.25 6v12a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9a2.25 2.25 0 00-2.25-2.25h-5.379a1.5 1.5 0 01-1.06-.44z"/>
            </svg>
            <p class="input-label">Drop documents folder here</p>
            <p class="input-hint">PDFs and Word docs to add signature blocks</p>
            <p class="input-selected" id="documentsSelected"></p>
          </div>
        </div>

        <div class="exec-actions">
          <button class="btn btn-primary" id="generateSigblocksBtn" disabled>Generate Signature Blocks</button>
        </div>
      </div>

      <!-- Processing -->
      <div class="processing" id="sigblocksProcessing">
        <div class="horse-container">
          <div class="horse">
            <svg viewBox="0 0 100 62" xmlns="http://www.w3.org/2000/svg">
              <ellipse cx="50" cy="35" rx="28" ry="16"/>
              <path d="M 70 28 Q 82 18 85 8 Q 90 16 84 28 Q 78 32 70 32 Z"/>
              <ellipse cx="88" cy="8" rx="11" ry="7"/>
              <path d="M 94 2 L 97 -4 L 96 3 Z"/>
              <circle cx="92" cy="6" r="1.5" fill="#0a0a0a"/>
              <path d="M 84 10 Q 78 4 76 14 Q 72 8 70 18" fill="none" stroke="#fff" stroke-width="2.5" stroke-linecap="round"/>
              <path d="M 22 35 Q 10 32 6 42 Q 12 38 14 46" fill="none" stroke="#fff" stroke-width="3" stroke-linecap="round"/>
              <g class="front-legs">
                <rect x="62" y="46" width="5" height="14" rx="2"/>
                <rect x="54" y="46" width="5" height="14" rx="2"/>
              </g>
              <g class="back-legs">
                <rect x="38" y="46" width="5" height="14" rx="2"/>
                <rect x="30" y="46" width="5" height="14" rx="2"/>
              </g>
            </svg>
          </div>
          <div class="dust">
            <div class="dust-particle"></div>
            <div class="dust-particle"></div>
            <div class="dust-particle"></div>
          </div>
        </div>
        <p class="progress-text" id="sigblocksProgressText">Processing...</p>
        <div class="progress-bar">
          <div class="progress-fill" id="sigblocksProgressFill" style="width: 0%"></div>
        </div>
      </div>

      <!-- Complete -->
      <div class="complete" id="sigblocksComplete">
        <svg class="check-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        <h2>Complete</h2>
        <p id="sigblocksResultText">Generated signature blocks for 0 documents</p>
        <div class="sigblock-results" id="sigblocksResults">
          <!-- Populated dynamically -->
        </div>
        <div class="btn-row">
          <button class="btn btn-primary" id="sigblocksDownloadBtn">Download ZIP</button>
          <button class="btn btn-flow" id="sigblocksToPacketsBtn">Create Signature Packets â†’</button>
        </div>
        <button class="btn btn-secondary" id="sigblocksResetBtn">Process Another</button>
      </div>

      <!-- Error -->
      <div class="error" id="sigblocksError">
        <svg class="error-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z"/>
        </svg>
        <h2>Error</h2>
        <p id="sigblocksErrorText">Something went wrong</p>
        <button class="btn btn-secondary" id="sigblocksRetryBtn">Try Again</button>
      </div>
    </div><!-- End sigblocksTab -->

    <!-- Collate Tab -->
    <div id="collateTab" style="display: none;">
      <!-- Collate Inputs -->
      <div id="collateInputs" class="exec-inputs">
        <p class="subtitle" style="margin-bottom: 8px;">Merge track changes and comments from multiple document versions</p>

        <!-- Base Document -->
        <div class="sigblock-step">
          <div class="sigblock-step-header" id="baseDocHeader">
            <span class="step-number">1</span>
            Base Document
          </div>
          <div class="input-section" id="baseDocInput">
            <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z"/>
            </svg>
            <p class="input-label">Drop base document here (.docx)</p>
            <p class="input-hint">The original clean version</p>
            <p class="input-selected" id="baseDocSelected"></p>
          </div>
        </div>

        <!-- Commented Versions -->
        <div class="sigblock-step">
          <div class="sigblock-step-header" id="commentedDocsHeader">
            <span class="step-number">2</span>
            Commented Versions
          </div>
          <div class="input-section" id="commentedDocsInput">
            <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M7.5 8.25h9m-9 3H12m-9.75 1.51c0 1.6 1.123 2.994 2.707 3.227 1.129.166 2.27.293 3.423.379.35.026.67.21.865.501L12 21l2.755-4.133a1.14 1.14 0 01.865-.501 48.172 48.172 0 003.423-.379c1.584-.233 2.707-1.626 2.707-3.228V6.741c0-1.602-1.123-2.995-2.707-3.228A48.394 48.394 0 0012 3c-2.392 0-4.744.175-7.043.513C3.373 3.746 2.25 5.14 2.25 6.741v6.018z"/>
            </svg>
            <p class="input-label">Drop commented versions here (.docx)</p>
            <p class="input-hint">Multiple files with track changes or comments</p>
            <p class="input-selected" id="commentedDocsSelected"></p>
          </div>
          <div class="file-list hidden" id="commentedDocsList">
            <!-- Populated dynamically -->
          </div>
        </div>

        <div class="exec-actions">
          <button class="btn btn-primary" id="collateBtn" disabled>Collate Documents</button>
        </div>
      </div>

      <!-- Processing -->
      <div class="processing" id="collateProcessing">
        <div class="horse-container">
          <div class="horse">
            <svg viewBox="0 0 100 62" xmlns="http://www.w3.org/2000/svg">
              <ellipse cx="50" cy="35" rx="28" ry="16"/>
              <path d="M 70 28 Q 82 18 85 8 Q 90 16 84 28 Q 78 32 70 32 Z"/>
              <ellipse cx="88" cy="8" rx="11" ry="7"/>
              <path d="M 94 2 L 97 -4 L 96 3 Z"/>
              <circle cx="92" cy="6" r="1.5" fill="#0a0a0a"/>
              <path d="M 84 10 Q 78 4 76 14 Q 72 8 70 18" fill="none" stroke="#fff" stroke-width="2.5" stroke-linecap="round"/>
              <path d="M 22 35 Q 10 32 6 42 Q 12 38 14 46" fill="none" stroke="#fff" stroke-width="3" stroke-linecap="round"/>
              <g class="front-legs">
                <rect x="62" y="46" width="5" height="14" rx="2"/>
                <rect x="54" y="46" width="5" height="14" rx="2"/>
              </g>
              <g class="back-legs">
                <rect x="38" y="46" width="5" height="14" rx="2"/>
                <rect x="30" y="46" width="5" height="14" rx="2"/>
              </g>
            </svg>
          </div>
          <div class="dust">
            <div class="dust-particle"></div>
            <div class="dust-particle"></div>
            <div class="dust-particle"></div>
          </div>
        </div>
        <p class="progress-text" id="collateProgressText">Processing...</p>
        <div class="progress-bar">
          <div class="progress-fill" id="collateProgressFill" style="width: 0%"></div>
        </div>
      </div>

      <!-- Complete -->
      <div class="complete" id="collateComplete">
        <svg class="check-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        <h2>Collation Complete</h2>
        <p id="collateResultText">Merged changes from 0 documents</p>

        <div class="collate-stats">
          <div class="stat-box">
            <div class="stat-value" id="totalChangesValue">0</div>
            <div class="stat-label">Track Changes</div>
          </div>
          <div class="stat-box">
            <div class="stat-value" id="totalCommentsValue">0</div>
            <div class="stat-label">Comments</div>
          </div>
          <div class="stat-box">
            <div class="stat-value" id="conflictsValue">0</div>
            <div class="stat-label">Conflicts</div>
          </div>
        </div>

        <div class="conflict-list hidden" id="conflictList">
          <!-- Populated dynamically -->
        </div>

        <div class="btn-row">
          <button class="btn btn-primary" id="collateDownloadBtn">Download ZIP</button>
        </div>
        <button class="btn btn-secondary" id="collateResetBtn">Process Another</button>
      </div>

      <!-- Error -->
      <div class="error" id="collateError">
        <svg class="error-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z"/>
        </svg>
        <h2>Error</h2>
        <p id="collateErrorText">Something went wrong</p>
        <button class="btn btn-secondary" id="collateRetryBtn">Try Again</button>
      </div>
    </div><!-- End collateTab -->

    <footer>
      <p>All processing happens locally. No data leaves your machine.</p>
    </footer>
  </div>

  <script>
    const { ipcRenderer } = require('electron');

    // ========== DISCLAIMER MODAL ==========
    const disclaimerModal = document.getElementById('disclaimerModal');
    const acceptDisclaimerBtn = document.getElementById('acceptDisclaimerBtn');
    const declineDisclaimerBtn = document.getElementById('declineDisclaimerBtn');

    // Check if user has accepted disclaimer
    const hasAcceptedDisclaimer = localStorage.getItem('emmaneigh_disclaimer_accepted');
    if (hasAcceptedDisclaimer) {
      disclaimerModal.classList.add('hidden');
    }

    acceptDisclaimerBtn.addEventListener('click', () => {
      localStorage.setItem('emmaneigh_disclaimer_accepted', 'true');
      disclaimerModal.classList.add('hidden');
    });

    declineDisclaimerBtn.addEventListener('click', async () => {
      await ipcRenderer.invoke('quit-app');
    });

    // ========== USER INFO / LOGIN ==========
    const userInfo = document.getElementById('userInfo');
    const userName = document.getElementById('userName');

    // Check for stored user
    const storedUser = localStorage.getItem('emmaneigh_user');
    if (storedUser) {
      try {
        const user = JSON.parse(storedUser);
        userName.textContent = user.name || 'Guest';
      } catch (e) {
        userName.textContent = 'Guest';
      }
    }

    userInfo.addEventListener('click', () => {
      // Simple prompt for name (in future could be full login modal)
      const currentName = userName.textContent;
      const newName = prompt('Enter your name (or leave blank for Guest):', currentName === 'Guest' ? '' : currentName);

      if (newName !== null) {
        const displayName = newName.trim() || 'Guest';
        userName.textContent = displayName;
        localStorage.setItem('emmaneigh_user', JSON.stringify({ name: displayName }));
      }
    });

    // ========== AUTO-UPDATE ==========
    const updateBanner = document.getElementById('updateBanner');
    const updateMessage = document.getElementById('updateMessage');
    const updateBtn = document.getElementById('updateBtn');
    const dismissUpdateBtn = document.getElementById('dismissUpdateBtn');

    ipcRenderer.on('update-available', (event, info) => {
      updateMessage.textContent = `Version ${info.version} is available!`;
      updateBanner.classList.remove('hidden');
    });

    ipcRenderer.on('update-downloaded', () => {
      updateMessage.textContent = 'Update downloaded. Restart to install.';
      updateBtn.textContent = 'Restart Now';
    });

    updateBtn.addEventListener('click', async () => {
      await ipcRenderer.invoke('install-update');
    });

    dismissUpdateBtn.addEventListener('click', () => {
      updateBanner.classList.add('hidden');
    });

    // ========== TABS ==========
    const tabs = document.querySelectorAll('.tab');
    const packetsTab = document.getElementById('packetsTab');
    const executionTab = document.getElementById('executionTab');
    const sigblocksTab = document.getElementById('sigblocksTab');
    const collateTab = document.getElementById('collateTab');

    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');

        const tabName = tab.dataset.tab;
        packetsTab.style.display = tabName === 'packets' ? 'block' : 'none';
        executionTab.style.display = tabName === 'execution' ? 'block' : 'none';
        sigblocksTab.style.display = tabName === 'sigblocks' ? 'block' : 'none';
        collateTab.style.display = tabName === 'collate' ? 'block' : 'none';
      });
    });

    // ========== SIGNATURE PACKETS TAB ==========
    const dropZone = document.getElementById('dropZone');
    const processing = document.getElementById('processing');
    const complete = document.getElementById('complete');
    const error = document.getElementById('error');
    const progressText = document.getElementById('progressText');
    const progressFill = document.getElementById('progressFill');
    const resultText = document.getElementById('resultText');
    const errorText = document.getElementById('errorText');
    const downloadBtn = document.getElementById('downloadBtn');
    const resetBtn = document.getElementById('resetBtn');
    const retryBtn = document.getElementById('retryBtn');
    const packetsFileCount = document.getElementById('packetsFileCount');

    let currentResult = null;
    let currentZipPath = null;
    let packetsPaths = []; // Can be folder path or array of file paths

    function showState(state) {
      dropZone.style.display = state === 'idle' ? 'flex' : 'none';
      processing.classList.toggle('visible', state === 'processing');
      complete.classList.toggle('visible', state === 'complete');
      error.classList.toggle('visible', state === 'error');
    }

    function updatePacketsFileCount() {
      if (packetsPaths.length === 0) {
        packetsFileCount.textContent = '';
      } else if (typeof packetsPaths === 'string') {
        packetsFileCount.textContent = 'Folder selected';
      } else {
        packetsFileCount.textContent = `${packetsPaths.length} file${packetsPaths.length !== 1 ? 's' : ''} selected`;
      }
    }

    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('active');
    });

    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('active');
    });

    dropZone.addEventListener('drop', async (e) => {
      e.preventDefault();
      dropZone.classList.remove('active');
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        // Check if it's a folder or files
        const firstFile = files[0];
        // If multiple files or single PDF, treat as file list
        if (files.length > 1 || firstFile.name.toLowerCase().endsWith('.pdf')) {
          packetsPaths = Array.from(files)
            .filter(f => f.name.toLowerCase().endsWith('.pdf'))
            .map(f => f.path);
          if (packetsPaths.length > 0) {
            updatePacketsFileCount();
            await processPackets({ files: packetsPaths });
          }
        } else {
          // Single item that's not a PDF - assume folder
          packetsPaths = firstFile.path;
          updatePacketsFileCount();
          await processPackets({ folder: firstFile.path });
        }
      }
    });

    dropZone.addEventListener('click', async () => {
      // Show choice dialog - folder or files
      const choice = await showPacketsChoiceDialog();
      if (choice === 'folder') {
        const folderPath = await ipcRenderer.invoke('select-folder');
        if (folderPath) {
          packetsPaths = folderPath;
          updatePacketsFileCount();
          await processPackets({ folder: folderPath });
        }
      } else if (choice === 'files') {
        const filePaths = await ipcRenderer.invoke('select-pdfs-multiple');
        if (filePaths && filePaths.length > 0) {
          packetsPaths = filePaths;
          updatePacketsFileCount();
          await processPackets({ files: filePaths });
        }
      }
    });

    function showPacketsChoiceDialog() {
      return new Promise((resolve) => {
        // Simple approach: use confirm dialog
        const useFolder = confirm('Click OK to select a folder, or Cancel to select individual PDF files.');
        resolve(useFolder ? 'folder' : 'files');
      });
    }

    async function processPackets(input) {
      showState('processing');
      progressFill.style.width = '0%';
      progressText.textContent = 'Starting...';

      try {
        const result = await ipcRenderer.invoke('process-folder', input);
        currentResult = result;
        progressText.textContent = 'Creating ZIP file...';
        currentZipPath = await ipcRenderer.invoke('create-zip', result.outputPath);
        resultText.textContent = `Created ${result.packetsCreated} signature packet${result.packetsCreated !== 1 ? 's' : ''}`;
        showState('complete');
      } catch (err) {
        errorText.textContent = err.message;
        showState('error');
      }
    }

    // Keep old function for backwards compatibility
    async function processFolder(folderPath) {
      await processPackets({ folder: folderPath });
    }

    ipcRenderer.on('progress', (event, data) => {
      // Route to correct progress bar based on active tab
      const activeTab = document.querySelector('.tab.active').dataset.tab;
      if (activeTab === 'packets') {
        progressText.textContent = data.message;
        progressFill.style.width = data.percent + '%';
      } else {
        execProgressText.textContent = data.message;
        execProgressFill.style.width = data.percent + '%';
      }
    });

    downloadBtn.addEventListener('click', async () => {
      if (currentZipPath) await ipcRenderer.invoke('save-zip', currentZipPath);
    });

    resetBtn.addEventListener('click', () => {
      currentResult = null;
      currentZipPath = null;
      packetsPaths = [];
      packetsFileCount.textContent = '';
      showState('idle');
    });

    retryBtn.addEventListener('click', () => {
      currentResult = null;
      currentZipPath = null;
      packetsPaths = [];
      packetsFileCount.textContent = '';
      showState('idle');
    });

    // ========== EXECUTION VERSION TAB ==========
    const originalsInput = document.getElementById('originalsInput');
    const signedInput = document.getElementById('signedInput');
    const originalsSelected = document.getElementById('originalsSelected');
    const signedSelected = document.getElementById('signedSelected');
    const processExecBtn = document.getElementById('processExecBtn');
    const execInputs = document.getElementById('execInputs');
    const execProcessing = document.getElementById('execProcessing');
    const execComplete = document.getElementById('execComplete');
    const execError = document.getElementById('execError');
    const execProgressText = document.getElementById('execProgressText');
    const execProgressFill = document.getElementById('execProgressFill');
    const execResultText = document.getElementById('execResultText');
    const execResultSummary = document.getElementById('execResultSummary');
    const execErrorText = document.getElementById('execErrorText');
    const execDownloadBtn = document.getElementById('execDownloadBtn');
    const execResetBtn = document.getElementById('execResetBtn');
    const execRetryBtn = document.getElementById('execRetryBtn');

    let originalsPath = null; // Can be folder path (string) or array of file paths
    let signedPath = null;
    let execResult = null;
    let execZipPath = null;

    function showExecState(state) {
      execInputs.style.display = state === 'idle' ? 'flex' : 'none';
      execProcessing.classList.toggle('visible', state === 'processing');
      execComplete.classList.toggle('visible', state === 'complete');
      execError.classList.toggle('visible', state === 'error');
    }

    function updateExecButton() {
      const hasOriginals = originalsPath && (typeof originalsPath === 'string' || originalsPath.length > 0);
      processExecBtn.disabled = !(hasOriginals && signedPath);
    }

    function truncatePath(p, maxLen = 40) {
      if (!p || p.length <= maxLen) return p;
      const name = p.split(/[/\\]/).pop();
      return '...' + p.slice(-(maxLen - 3));
    }

    function updateOriginalsDisplay() {
      if (!originalsPath) {
        originalsSelected.textContent = '';
        originalsInput.classList.remove('selected');
      } else if (typeof originalsPath === 'string') {
        originalsSelected.textContent = truncatePath(originalsPath);
        originalsInput.classList.add('selected');
      } else {
        originalsSelected.textContent = `${originalsPath.length} file${originalsPath.length !== 1 ? 's' : ''} selected`;
        originalsInput.classList.add('selected');
      }
    }

    // Originals folder/files selection
    originalsInput.addEventListener('click', async () => {
      // Show choice dialog
      const useFolder = confirm('Click OK to select a folder, or Cancel to select individual PDF files.');
      if (useFolder) {
        const path = await ipcRenderer.invoke('select-folder');
        if (path) {
          originalsPath = path;
          updateOriginalsDisplay();
          updateExecButton();
        }
      } else {
        const paths = await ipcRenderer.invoke('select-pdfs-multiple');
        if (paths && paths.length > 0) {
          originalsPath = paths;
          updateOriginalsDisplay();
          updateExecButton();
        }
      }
    });

    originalsInput.addEventListener('dragover', (e) => {
      e.preventDefault();
      originalsInput.classList.add('active');
    });

    originalsInput.addEventListener('dragleave', () => {
      originalsInput.classList.remove('active');
    });

    originalsInput.addEventListener('drop', (e) => {
      e.preventDefault();
      originalsInput.classList.remove('active');
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        // Check if multiple files or single PDF
        if (files.length > 1 || files[0].name.toLowerCase().endsWith('.pdf')) {
          // Treat as file list
          originalsPath = Array.from(files)
            .filter(f => f.name.toLowerCase().endsWith('.pdf'))
            .map(f => f.path);
          if (originalsPath.length === 0) {
            // If no PDFs found, maybe it was a folder
            originalsPath = files[0].path;
          }
        } else {
          // Single item that's not a PDF - assume folder
          originalsPath = files[0].path;
        }
        updateOriginalsDisplay();
        updateExecButton();
      }
    });

    // Signed PDF selection
    signedInput.addEventListener('click', async () => {
      const path = await ipcRenderer.invoke('select-pdf');
      if (path) {
        signedPath = path;
        signedSelected.textContent = truncatePath(path);
        signedInput.classList.add('selected');
        updateExecButton();
      }
    });

    signedInput.addEventListener('dragover', (e) => {
      e.preventDefault();
      signedInput.classList.add('active');
    });

    signedInput.addEventListener('dragleave', () => {
      signedInput.classList.remove('active');
    });

    signedInput.addEventListener('drop', (e) => {
      e.preventDefault();
      signedInput.classList.remove('active');
      const files = e.dataTransfer.files;
      if (files.length > 0 && files[0].name.toLowerCase().endsWith('.pdf')) {
        signedPath = files[0].path;
        signedSelected.textContent = truncatePath(signedPath);
        signedInput.classList.add('selected');
        updateExecButton();
      }
    });

    // Process execution version
    processExecBtn.addEventListener('click', async () => {
      const hasOriginals = originalsPath && (typeof originalsPath === 'string' || originalsPath.length > 0);
      if (!hasOriginals || !signedPath) return;

      showExecState('processing');
      execProgressFill.style.width = '0%';
      execProgressText.textContent = 'Starting...';

      try {
        // Pass originals as object with folder or files key
        const originalsInput = typeof originalsPath === 'string'
          ? { folder: originalsPath }
          : { files: originalsPath };
        const result = await ipcRenderer.invoke('process-execution-version', originalsInput, signedPath);
        execResult = result;

        execProgressText.textContent = 'Creating ZIP file...';
        execZipPath = await ipcRenderer.invoke('create-zip', result.outputPath);

        execResultText.textContent = `Created ${result.executedCount} executed document${result.executedCount !== 1 ? 's' : ''}`;

        let summary = `Matched ${result.matchedPages} of ${result.totalSignedPages} signed pages`;
        if (result.unmatchedAgreements > 0) {
          summary += ` â€¢ ${result.unmatchedAgreements} unmatched agreement${result.unmatchedAgreements !== 1 ? 's' : ''}`;
        }
        if (result.unmatchedPages > 0) {
          summary += ` â€¢ ${result.unmatchedPages} unmatched page${result.unmatchedPages !== 1 ? 's' : ''}`;
        }
        execResultSummary.textContent = summary;

        showExecState('complete');
      } catch (err) {
        execErrorText.textContent = err.message;
        showExecState('error');
      }
    });

    execDownloadBtn.addEventListener('click', async () => {
      if (execZipPath) await ipcRenderer.invoke('save-zip', execZipPath);
    });

    function resetExecState() {
      originalsPath = null;
      signedPath = null;
      execResult = null;
      execZipPath = null;
      originalsSelected.textContent = '';
      signedSelected.textContent = '';
      originalsInput.classList.remove('selected');
      signedInput.classList.remove('selected');
      updateOriginalsDisplay();
      updateExecButton();
      showExecState('idle');
    }

    execResetBtn.addEventListener('click', resetExecState);
    execRetryBtn.addEventListener('click', resetExecState);

    // ========== SIGNATURE BLOCKS TAB ==========
    const checklistInput = document.getElementById('checklistInput');
    const checklistSelected = document.getElementById('checklistSelected');
    const checklistHeader = document.getElementById('checklistHeader');
    const incumbencyInput = document.getElementById('incumbencyInput');
    const incumbencySelected = document.getElementById('incumbencySelected');
    const incumbencyHeader = document.getElementById('incumbencyHeader');
    const mappingStep = document.getElementById('mappingStep');
    const entityMapping = document.getElementById('entityMapping');
    const documentsStep = document.getElementById('documentsStep');
    const documentsInput = document.getElementById('documentsInput');
    const documentsSelected = document.getElementById('documentsSelected');
    const documentsHeader = document.getElementById('documentsHeader');
    const generateSigblocksBtn = document.getElementById('generateSigblocksBtn');
    const sigblocksInputs = document.getElementById('sigblocksInputs');
    const sigblocksProcessing = document.getElementById('sigblocksProcessing');
    const sigblocksComplete = document.getElementById('sigblocksComplete');
    const sigblocksError = document.getElementById('sigblocksError');
    const sigblocksProgressText = document.getElementById('sigblocksProgressText');
    const sigblocksProgressFill = document.getElementById('sigblocksProgressFill');
    const sigblocksResultText = document.getElementById('sigblocksResultText');
    const sigblocksResults = document.getElementById('sigblocksResults');
    const sigblocksErrorText = document.getElementById('sigblocksErrorText');
    const sigblocksDownloadBtn = document.getElementById('sigblocksDownloadBtn');
    const sigblocksToPacketsBtn = document.getElementById('sigblocksToPacketsBtn');
    const sigblocksResetBtn = document.getElementById('sigblocksResetBtn');
    const sigblocksRetryBtn = document.getElementById('sigblocksRetryBtn');

    let checklistPath = null;
    let checklistData = null;
    let incumbencyPaths = [];
    let incumbencyData = [];
    let sigblocksDocumentsPath = null;
    let sigblocksResult = null;
    let sigblocksZipPath = null;

    function showSigblocksState(state) {
      sigblocksInputs.style.display = state === 'idle' ? 'flex' : 'none';
      sigblocksProcessing.classList.toggle('visible', state === 'processing');
      sigblocksComplete.classList.toggle('visible', state === 'complete');
      sigblocksError.classList.toggle('visible', state === 'error');
    }

    function updateSigblocksButton() {
      const hasMappings = entityMapping.querySelectorAll('.entity-row').length > 0;
      generateSigblocksBtn.disabled = !(checklistPath && incumbencyPaths.length > 0 && sigblocksDocumentsPath && hasMappings);
    }

    // Checklist selection
    checklistInput.addEventListener('click', async () => {
      const path = await ipcRenderer.invoke('select-spreadsheet');
      if (path) {
        await loadChecklist(path);
      }
    });

    checklistInput.addEventListener('dragover', (e) => {
      e.preventDefault();
      checklistInput.classList.add('active');
    });

    checklistInput.addEventListener('dragleave', () => {
      checklistInput.classList.remove('active');
    });

    checklistInput.addEventListener('drop', async (e) => {
      e.preventDefault();
      checklistInput.classList.remove('active');
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        const ext = files[0].name.toLowerCase();
        if (ext.endsWith('.xlsx') || ext.endsWith('.xls') || ext.endsWith('.csv')) {
          await loadChecklist(files[0].path);
        }
      }
    });

    async function loadChecklist(path) {
      try {
        checklistPath = path;
        checklistSelected.textContent = truncatePath(path);
        checklistInput.classList.add('selected');
        checklistHeader.classList.add('done');

        // Parse checklist
        checklistData = await ipcRenderer.invoke('parse-checklist', path);
        updateEntityMappingUI();
        updateSigblocksButton();
      } catch (err) {
        checklistSelected.textContent = 'Error: ' + err.message;
        checklistInput.classList.remove('selected');
      }
    }

    // Incumbency selection
    incumbencyInput.addEventListener('click', async () => {
      const paths = await ipcRenderer.invoke('select-files', {
        filters: [{ name: 'Documents', extensions: ['pdf', 'docx'] }],
        properties: ['openFile', 'multiSelections']
      });
      if (paths && paths.length > 0) {
        await loadIncumbencies(paths);
      }
    });

    incumbencyInput.addEventListener('dragover', (e) => {
      e.preventDefault();
      incumbencyInput.classList.add('active');
    });

    incumbencyInput.addEventListener('dragleave', () => {
      incumbencyInput.classList.remove('active');
    });

    incumbencyInput.addEventListener('drop', async (e) => {
      e.preventDefault();
      incumbencyInput.classList.remove('active');
      const files = Array.from(e.dataTransfer.files).filter(f => {
        const ext = f.name.toLowerCase();
        return ext.endsWith('.pdf') || ext.endsWith('.docx');
      });
      if (files.length > 0) {
        await loadIncumbencies(files.map(f => f.path));
      }
    });

    async function loadIncumbencies(paths) {
      try {
        incumbencyPaths = paths;
        incumbencySelected.textContent = `${paths.length} file${paths.length !== 1 ? 's' : ''} selected`;
        incumbencyInput.classList.add('selected');
        incumbencyHeader.classList.add('done');

        // Parse incumbencies
        incumbencyData = [];
        for (const p of paths) {
          try {
            const data = await ipcRenderer.invoke('parse-incumbency', p);
            incumbencyData.push(data);
          } catch (err) {
            console.error('Failed to parse', p, err);
          }
        }

        updateEntityMappingUI();
        updateSigblocksButton();
      } catch (err) {
        incumbencySelected.textContent = 'Error: ' + err.message;
      }
    }

    function updateEntityMappingUI() {
      // Show mapping step if we have both checklist and incumbencies
      if (checklistData && incumbencyData.length > 0) {
        mappingStep.style.display = 'block';
        documentsStep.style.display = 'block';

        // Get all roles from checklist
        const roles = checklistData.all_roles || [];

        // Build mapping UI
        let html = '';
        for (const inc of incumbencyData) {
          const entityName = inc.entity_name || inc.source_file || 'Unknown Entity';
          const signers = inc.signers || [];

          html += `<div class="entity-row" data-entity="${entityName}">`;
          html += `<span class="entity-name">${entityName}</span>`;
          html += `<span class="entity-arrow">â†’</span>`;
          html += `<select class="entity-select" data-entity="${entityName}">`;
          html += `<option value="">Select role...</option>`;
          for (const role of roles) {
            html += `<option value="${role}">${role}</option>`;
          }
          html += `</select>`;

          // Signer dropdown
          html += `<select class="signer-select" data-entity="${entityName}">`;
          if (signers.length === 0) {
            html += `<option value="0">No signers found</option>`;
          } else {
            for (let i = 0; i < signers.length; i++) {
              const s = signers[i];
              html += `<option value="${i}">${s.name}${s.title ? ', ' + s.title : ''}</option>`;
            }
          }
          html += `</select>`;
          html += `</div>`;
        }

        if (html === '') {
          html = '<p class="no-data-msg">No entities found in incumbency certificates</p>';
        }

        entityMapping.innerHTML = html;
      }
    }

    // Documents folder selection
    documentsInput.addEventListener('click', async () => {
      const path = await ipcRenderer.invoke('select-folder');
      if (path) {
        sigblocksDocumentsPath = path;
        documentsSelected.textContent = truncatePath(path);
        documentsInput.classList.add('selected');
        documentsHeader.classList.add('done');
        updateSigblocksButton();
      }
    });

    documentsInput.addEventListener('dragover', (e) => {
      e.preventDefault();
      documentsInput.classList.add('active');
    });

    documentsInput.addEventListener('dragleave', () => {
      documentsInput.classList.remove('active');
    });

    documentsInput.addEventListener('drop', (e) => {
      e.preventDefault();
      documentsInput.classList.remove('active');
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        sigblocksDocumentsPath = files[0].path;
        documentsSelected.textContent = truncatePath(sigblocksDocumentsPath);
        documentsInput.classList.add('selected');
        documentsHeader.classList.add('done');
        updateSigblocksButton();
      }
    });

    // Generate signature blocks
    generateSigblocksBtn.addEventListener('click', async () => {
      if (!checklistPath || incumbencyPaths.length === 0 || !sigblocksDocumentsPath) return;

      // Build entity mappings from UI
      const entityMappings = {};
      const rows = entityMapping.querySelectorAll('.entity-row');
      rows.forEach(row => {
        const entityName = row.dataset.entity;
        const roleSelect = row.querySelector('.entity-select');
        const signerSelect = row.querySelector('.signer-select');
        const role = roleSelect.value;
        const signerIndex = parseInt(signerSelect.value, 10) || 0;

        if (role) {
          entityMappings[entityName] = { role, signer_index: signerIndex };
        }
      });

      showSigblocksState('processing');
      sigblocksProgressFill.style.width = '0%';
      sigblocksProgressText.textContent = 'Starting...';

      try {
        const result = await ipcRenderer.invoke('process-sigblocks', {
          checklist_path: checklistPath,
          incumbency_paths: incumbencyPaths,
          documents_folder: sigblocksDocumentsPath,
          entity_mappings: entityMappings
        });

        sigblocksResult = result;
        sigblocksProgressText.textContent = 'Creating ZIP file...';
        sigblocksZipPath = await ipcRenderer.invoke('create-zip', result.output_folder);

        // Update results UI
        const processed = result.documents_processed || [];
        sigblocksResultText.textContent = `Generated signature blocks for ${processed.length} document${processed.length !== 1 ? 's' : ''}`;

        let resultsHtml = '';
        for (const doc of processed.slice(0, 10)) {
          const status = doc.status === 'processed' ? 'âœ“' : 'â—‹';
          const note = doc.blocks_added ? `(${doc.blocks_added} blocks)` : doc.note || '';
          resultsHtml += `<div class="sigblock-result-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            ${doc.file} ${note}
          </div>`;
        }
        if (processed.length > 10) {
          resultsHtml += `<div class="sigblock-result-item" style="color: #555;">...and ${processed.length - 10} more</div>`;
        }
        sigblocksResults.innerHTML = resultsHtml;

        showSigblocksState('complete');
      } catch (err) {
        sigblocksErrorText.textContent = err.message;
        showSigblocksState('error');
      }
    });

    // Listen for sigblocks progress
    ipcRenderer.on('sigblocks-progress', (event, data) => {
      sigblocksProgressText.textContent = data.message;
      sigblocksProgressFill.style.width = data.percent + '%';
    });

    sigblocksDownloadBtn.addEventListener('click', async () => {
      if (sigblocksZipPath) await ipcRenderer.invoke('save-zip', sigblocksZipPath);
    });

    // Flow to Signature Packets
    sigblocksToPacketsBtn.addEventListener('click', async () => {
      if (sigblocksResult && sigblocksResult.output_folder) {
        // Switch to packets tab
        tabs.forEach(t => t.classList.remove('active'));
        document.querySelector('[data-tab="packets"]').classList.add('active');
        packetsTab.style.display = 'block';
        executionTab.style.display = 'none';
        sigblocksTab.style.display = 'none';

        // Process the output folder
        await processFolder(sigblocksResult.output_folder);
      }
    });

    function resetSigblocksState() {
      checklistPath = null;
      checklistData = null;
      incumbencyPaths = [];
      incumbencyData = [];
      sigblocksDocumentsPath = null;
      sigblocksResult = null;
      sigblocksZipPath = null;

      checklistSelected.textContent = '';
      incumbencySelected.textContent = '';
      documentsSelected.textContent = '';
      entityMapping.innerHTML = '';

      checklistInput.classList.remove('selected');
      incumbencyInput.classList.remove('selected');
      documentsInput.classList.remove('selected');
      checklistHeader.classList.remove('done');
      incumbencyHeader.classList.remove('done');
      documentsHeader.classList.remove('done');

      mappingStep.style.display = 'none';
      documentsStep.style.display = 'none';

      updateSigblocksButton();
      showSigblocksState('idle');
    }

    sigblocksResetBtn.addEventListener('click', resetSigblocksState);
    sigblocksRetryBtn.addEventListener('click', resetSigblocksState);

    // ========== COLLATE TAB ==========
    const baseDocInput = document.getElementById('baseDocInput');
    const baseDocSelected = document.getElementById('baseDocSelected');
    const baseDocHeader = document.getElementById('baseDocHeader');
    const commentedDocsInput = document.getElementById('commentedDocsInput');
    const commentedDocsSelected = document.getElementById('commentedDocsSelected');
    const commentedDocsList = document.getElementById('commentedDocsList');
    const commentedDocsHeader = document.getElementById('commentedDocsHeader');
    const collateBtn = document.getElementById('collateBtn');
    const collateInputs = document.getElementById('collateInputs');
    const collateProcessing = document.getElementById('collateProcessing');
    const collateComplete = document.getElementById('collateComplete');
    const collateError = document.getElementById('collateError');
    const collateProgressText = document.getElementById('collateProgressText');
    const collateProgressFill = document.getElementById('collateProgressFill');
    const collateResultText = document.getElementById('collateResultText');
    const totalChangesValue = document.getElementById('totalChangesValue');
    const totalCommentsValue = document.getElementById('totalCommentsValue');
    const conflictsValue = document.getElementById('conflictsValue');
    const conflictList = document.getElementById('conflictList');
    const collateErrorText = document.getElementById('collateErrorText');
    const collateDownloadBtn = document.getElementById('collateDownloadBtn');
    const collateResetBtn = document.getElementById('collateResetBtn');
    const collateRetryBtn = document.getElementById('collateRetryBtn');

    let baseDocPath = null;
    let commentedDocPaths = [];
    let collateResult = null;
    let collateZipPath = null;

    function showCollateState(state) {
      collateInputs.style.display = state === 'idle' ? 'flex' : 'none';
      collateProcessing.classList.toggle('visible', state === 'processing');
      collateComplete.classList.toggle('visible', state === 'complete');
      collateError.classList.toggle('visible', state === 'error');
    }

    function updateCollateButton() {
      collateBtn.disabled = !(baseDocPath && commentedDocPaths.length > 0);
    }

    function updateCommentedDocsList() {
      // Always update the count display
      if (commentedDocPaths.length > 0) {
        commentedDocsSelected.textContent = `${commentedDocPaths.length} file${commentedDocPaths.length !== 1 ? 's' : ''} selected`;
        commentedDocsInput.classList.add('selected');
        commentedDocsHeader.classList.add('done');
        commentedDocsList.classList.remove('hidden');

        let html = '';
        commentedDocPaths.forEach((p, i) => {
          const name = p.split(/[/\\]/).pop();
          html += `<div class="file-list-item">
            <span>${name}</span>
            <button class="remove-btn" data-index="${i}">Ã—</button>
          </div>`;
        });
        commentedDocsList.innerHTML = html;

        // Add remove handlers
        commentedDocsList.querySelectorAll('.remove-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const idx = parseInt(btn.dataset.index, 10);
            commentedDocPaths.splice(idx, 1);
            updateCommentedDocsList();
            updateCollateButton();
          });
        });
      } else {
        commentedDocsSelected.textContent = '';
        commentedDocsInput.classList.remove('selected');
        commentedDocsHeader.classList.remove('done');
        commentedDocsList.classList.add('hidden');
        commentedDocsList.innerHTML = '';
      }
    }

    // Base document selection
    baseDocInput.addEventListener('click', async () => {
      const path = await ipcRenderer.invoke('select-docx');
      if (path) {
        baseDocPath = path;
        baseDocSelected.textContent = truncatePath(path);
        baseDocInput.classList.add('selected');
        baseDocHeader.classList.add('done');
        updateCollateButton();
      }
    });

    baseDocInput.addEventListener('dragover', (e) => {
      e.preventDefault();
      baseDocInput.classList.add('active');
    });

    baseDocInput.addEventListener('dragleave', () => {
      baseDocInput.classList.remove('active');
    });

    baseDocInput.addEventListener('drop', (e) => {
      e.preventDefault();
      baseDocInput.classList.remove('active');
      const files = e.dataTransfer.files;
      if (files.length > 0 && files[0].name.toLowerCase().endsWith('.docx')) {
        baseDocPath = files[0].path;
        baseDocSelected.textContent = truncatePath(baseDocPath);
        baseDocInput.classList.add('selected');
        baseDocHeader.classList.add('done');
        updateCollateButton();
      }
    });

    // Commented documents selection
    commentedDocsInput.addEventListener('click', async () => {
      const paths = await ipcRenderer.invoke('select-docx-multiple');
      if (paths && paths.length > 0) {
        commentedDocPaths = [...commentedDocPaths, ...paths];
        commentedDocsSelected.textContent = `${commentedDocPaths.length} file${commentedDocPaths.length !== 1 ? 's' : ''} selected`;
        commentedDocsInput.classList.add('selected');
        commentedDocsHeader.classList.add('done');
        updateCommentedDocsList();
        updateCollateButton();
      }
    });

    commentedDocsInput.addEventListener('dragover', (e) => {
      e.preventDefault();
      commentedDocsInput.classList.add('active');
    });

    commentedDocsInput.addEventListener('dragleave', () => {
      commentedDocsInput.classList.remove('active');
    });

    commentedDocsInput.addEventListener('drop', (e) => {
      e.preventDefault();
      commentedDocsInput.classList.remove('active');
      const files = Array.from(e.dataTransfer.files).filter(f =>
        f.name.toLowerCase().endsWith('.docx')
      );
      if (files.length > 0) {
        commentedDocPaths = [...commentedDocPaths, ...files.map(f => f.path)];
        commentedDocsSelected.textContent = `${commentedDocPaths.length} file${commentedDocPaths.length !== 1 ? 's' : ''} selected`;
        commentedDocsInput.classList.add('selected');
        commentedDocsHeader.classList.add('done');
        updateCommentedDocsList();
        updateCollateButton();
      }
    });

    // Collate documents
    collateBtn.addEventListener('click', async () => {
      if (!baseDocPath || commentedDocPaths.length === 0) return;

      showCollateState('processing');
      collateProgressFill.style.width = '0%';
      collateProgressText.textContent = 'Starting...';

      try {
        const result = await ipcRenderer.invoke('collate-documents', {
          base_document: baseDocPath,
          commented_documents: commentedDocPaths
        });

        collateResult = result;
        collateProgressText.textContent = 'Creating ZIP file...';
        collateZipPath = await ipcRenderer.invoke('create-zip', result.output_folder);

        // Update results UI
        collateResultText.textContent = `Merged changes from ${commentedDocPaths.length} document${commentedDocPaths.length !== 1 ? 's' : ''}`;
        totalChangesValue.textContent = result.total_changes || 0;
        totalCommentsValue.textContent = result.total_comments || 0;
        conflictsValue.textContent = result.conflicts || 0;

        // Show conflicts if any
        if (result.conflicts > 0) {
          conflictsValue.classList.add('warning');
          conflictList.classList.remove('hidden');
          conflictList.innerHTML = `<div class="conflict-item">${result.unresolved_conflicts || 0} unresolved conflict(s) detected. Review the summary document for details.</div>`;
        } else {
          conflictsValue.classList.remove('warning');
          conflictList.classList.add('hidden');
        }

        showCollateState('complete');
      } catch (err) {
        collateErrorText.textContent = err.message;
        showCollateState('error');
      }
    });

    // Listen for collate progress
    ipcRenderer.on('collate-progress', (event, data) => {
      collateProgressText.textContent = data.message;
      collateProgressFill.style.width = data.percent + '%';
    });

    collateDownloadBtn.addEventListener('click', async () => {
      if (collateZipPath) await ipcRenderer.invoke('save-zip', collateZipPath);
    });

    function resetCollateState() {
      baseDocPath = null;
      commentedDocPaths = [];
      collateResult = null;
      collateZipPath = null;

      baseDocSelected.textContent = '';
      commentedDocsSelected.textContent = '';
      commentedDocsList.innerHTML = '';
      commentedDocsList.classList.add('hidden');

      baseDocInput.classList.remove('selected');
      commentedDocsInput.classList.remove('selected');
      baseDocHeader.classList.remove('done');
      commentedDocsHeader.classList.remove('done');

      conflictList.classList.add('hidden');
      conflictsValue.classList.remove('warning');

      updateCollateButton();
      showCollateState('idle');
    }

    collateResetBtn.addEventListener('click', resetCollateState);
    collateRetryBtn.addEventListener('click', resetCollateState);
  </script>
</body>
</html>
