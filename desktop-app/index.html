<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EmmaNeigh</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    @font-face {
      font-family: 'SF Pro';
      src: local('-apple-system'), local('BlinkMacSystemFont'), local('Segoe UI');
    }

    body {
      font-family: 'SF Pro', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0a0a0a;
      color: #fafafa;
      height: 100vh;
      overflow: hidden;
      -webkit-app-region: drag;
    }

    .container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      padding: 60px 40px 40px;
    }

    header {
      margin-bottom: 32px;
    }

    .logo {
      font-size: 13px;
      font-weight: 500;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: #666;
      margin-bottom: 8px;
    }

    h1 {
      font-size: 28px;
      font-weight: 600;
      letter-spacing: -0.02em;
    }

    .subtitle {
      font-size: 14px;
      color: #666;
      margin-top: 6px;
    }

    .drop-zone {
      flex: 1;
      border: 1px dashed #333;
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      cursor: pointer;
      -webkit-app-region: no-drag;
      min-height: 200px;
    }

    .drop-zone:hover {
      border-color: #444;
      background: rgba(255,255,255,0.02);
    }

    .drop-zone.active {
      border-color: #fff;
      background: rgba(255,255,255,0.05);
    }

    .drop-zone.disabled {
      pointer-events: none;
      opacity: 0.5;
    }

    .drop-icon {
      width: 48px;
      height: 48px;
      margin-bottom: 16px;
      opacity: 0.4;
    }

    .drop-text {
      font-size: 15px;
      color: #888;
      text-align: center;
    }

    .drop-text span {
      color: #fff;
      text-decoration: underline;
      text-underline-offset: 2px;
    }

    .drop-hint {
      font-size: 12px;
      color: #555;
      margin-top: 8px;
    }

    /* Processing State */
    .processing {
      flex: 1;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .processing.visible {
      display: flex;
    }

    .horse-container {
      width: 120px;
      height: 60px;
      margin-bottom: 24px;
      position: relative;
    }

    .horse {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      animation: gallop 0.4s ease-in-out infinite;
    }

    @keyframes gallop {
      0%, 100% { transform: translateX(-50%) translateY(0); }
      50% { transform: translateX(-50%) translateY(-6px); }
    }

    .horse svg {
      width: 80px;
      height: 50px;
      fill: #fff;
      opacity: 0.9;
    }

    .dust {
      position: absolute;
      bottom: 0;
      left: 20%;
      display: flex;
      gap: 4px;
    }

    .dust-particle {
      width: 6px;
      height: 6px;
      background: #888;
      border-radius: 50%;
      animation: dust 0.6s ease-out infinite;
    }

    .dust-particle:nth-child(2) { animation-delay: 0.1s; }
    .dust-particle:nth-child(3) { animation-delay: 0.2s; }

    @keyframes dust {
      0% { transform: translate(0, 0) scale(1); opacity: 0.8; }
      100% { transform: translate(-12px, -4px) scale(0.3); opacity: 0; }
    }

    .progress-text {
      font-size: 14px;
      color: #888;
      text-align: center;
    }

    .progress-bar {
      width: 200px;
      height: 2px;
      background: #222;
      border-radius: 1px;
      margin-top: 16px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: #fff;
      transition: width 0.3s ease;
    }

    /* Complete State */
    .complete {
      flex: 1;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .complete.visible {
      display: flex;
    }

    .check-icon {
      width: 48px;
      height: 48px;
      margin-bottom: 20px;
      color: #22c55e;
    }

    .complete h2 {
      font-size: 20px;
      font-weight: 500;
      margin-bottom: 8px;
    }

    .complete p {
      font-size: 14px;
      color: #666;
      margin-bottom: 24px;
    }

    .btn {
      padding: 12px 24px;
      font-size: 14px;
      font-weight: 500;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.15s ease;
      -webkit-app-region: no-drag;
    }

    .btn-primary {
      background: #fff;
      color: #000;
    }

    .btn-primary:hover {
      background: #e5e5e5;
    }

    .btn-secondary {
      background: transparent;
      color: #888;
      border: 1px solid #333;
      margin-top: 12px;
    }

    .btn-secondary:hover {
      border-color: #555;
      color: #fff;
    }

    /* Error State */
    .error {
      flex: 1;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .error.visible {
      display: flex;
    }

    .error-icon {
      width: 48px;
      height: 48px;
      margin-bottom: 20px;
      color: #ef4444;
    }

    .error h2 {
      font-size: 20px;
      font-weight: 500;
      margin-bottom: 8px;
    }

    .error p {
      font-size: 14px;
      color: #666;
      margin-bottom: 24px;
      text-align: center;
      max-width: 300px;
    }

    footer {
      margin-top: 24px;
      text-align: center;
    }

    footer p {
      font-size: 11px;
      color: #444;
    }

    /* Navigation Sidebar */
    .main-layout {
      display: flex;
      gap: 24px;
      flex: 1;
      min-height: 0;
    }

    .nav-sidebar {
      width: 220px;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      gap: 8px;
      -webkit-app-region: no-drag;
    }

    .nav-category {
      background: #111;
      border-radius: 8px;
      overflow: hidden;
    }

    .nav-category-header {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 14px;
      font-size: 12px;
      font-weight: 600;
      color: #888;
      background: transparent;
      border: none;
      cursor: pointer;
      width: 100%;
      text-align: left;
      transition: all 0.15s;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .nav-category-header:hover {
      color: #aaa;
      background: rgba(255,255,255,0.02);
    }

    .nav-category-header .icon {
      font-size: 14px;
    }

    .nav-category-header .arrow {
      margin-left: auto;
      font-size: 10px;
      transition: transform 0.2s;
    }

    .nav-category.expanded .nav-category-header .arrow {
      transform: rotate(180deg);
    }

    .nav-items {
      display: none;
      flex-direction: column;
      padding: 0 8px 8px;
      gap: 2px;
    }

    .nav-category.expanded .nav-items {
      display: flex;
    }

    .nav-item {
      padding: 10px 12px;
      font-size: 13px;
      color: #666;
      background: transparent;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      text-align: left;
      transition: all 0.15s;
    }

    .nav-item:hover {
      color: #888;
      background: rgba(255,255,255,0.03);
    }

    .nav-item.active {
      background: #222;
      color: #fff;
    }

    .nav-item.disabled {
      opacity: 0.4;
      cursor: not-allowed;
      position: relative;
    }

    .nav-item.disabled:hover {
      background: transparent;
      color: #666;
    }

    .nav-item.disabled::after {
      content: 'Soon';
      position: absolute;
      right: 8px;
      font-size: 9px;
      background: #333;
      padding: 2px 5px;
      border-radius: 3px;
      color: #888;
    }

    .content-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
      overflow-y: auto;
    }

    /* Legacy tabs - hidden but kept for JS compatibility */
    .tabs {
      display: none;
    }

    .tab {
      display: none;
    }

    /* Execution Version UI */
    .exec-inputs {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .input-section {
      border: 1px dashed #333;
      border-radius: 12px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      cursor: pointer;
      -webkit-app-region: no-drag;
      min-height: 100px;
    }

    .input-section:hover {
      border-color: #444;
      background: rgba(255,255,255,0.02);
    }

    .input-section.active {
      border-color: #fff;
      background: rgba(255,255,255,0.05);
    }

    .input-section.selected {
      border-color: #22c55e;
      border-style: solid;
    }

    .input-section.disabled {
      pointer-events: none;
      opacity: 0.5;
    }

    .input-icon {
      width: 32px;
      height: 32px;
      margin-bottom: 12px;
      opacity: 0.4;
    }

    .input-label {
      font-size: 14px;
      font-weight: 500;
      color: #fff;
      margin-bottom: 4px;
    }

    .input-hint {
      font-size: 12px;
      color: #555;
    }

    .input-selected {
      font-size: 12px;
      color: #22c55e;
      margin-top: 8px;
      word-break: break-all;
      text-align: center;
      max-width: 100%;
    }

    .input-selected-wrapper {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-top: 8px;
    }

    .input-selected-wrapper .input-selected {
      margin-top: 0;
    }

    .clear-file-btn {
      background: none;
      border: none;
      color: #666;
      cursor: pointer;
      padding: 2px 6px;
      font-size: 16px;
      line-height: 1;
      border-radius: 4px;
      -webkit-app-region: no-drag;
      display: none;
    }

    .clear-file-btn:hover {
      color: #ef4444;
      background: rgba(239, 68, 68, 0.1);
    }

    .clear-file-btn.visible {
      display: inline-block;
    }

    .exec-actions {
      margin-top: 16px;
      display: flex;
      justify-content: center;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Results summary */
    .result-summary {
      font-size: 13px;
      color: #888;
      margin-top: 8px;
      text-align: center;
    }

    /* Signature Blocks Tab Styles */
    .sigblock-step {
      margin-bottom: 16px;
    }

    .sigblock-step-header {
      font-size: 13px;
      font-weight: 500;
      color: #888;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .sigblock-step-header .step-number {
      width: 20px;
      height: 20px;
      background: #222;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      color: #666;
    }

    .sigblock-step-header.done .step-number {
      background: #22c55e;
      color: #fff;
    }

    .entity-mapping {
      background: #111;
      border-radius: 8px;
      padding: 12px;
      max-height: 200px;
      overflow-y: auto;
    }

    .entity-row {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 0;
      border-bottom: 1px solid #222;
    }

    .entity-row:last-child {
      border-bottom: none;
    }

    .entity-name {
      flex: 1;
      font-size: 13px;
      color: #fff;
    }

    .entity-arrow {
      color: #444;
      font-size: 14px;
    }

    .entity-select {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 6px;
      padding: 6px 10px;
      font-size: 12px;
      color: #fff;
      min-width: 140px;
      -webkit-app-region: no-drag;
    }

    .entity-select:focus {
      outline: none;
      border-color: #555;
    }

    .signer-select {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 6px;
      padding: 6px 10px;
      font-size: 12px;
      color: #888;
      min-width: 160px;
      -webkit-app-region: no-drag;
    }

    .sigblock-results {
      background: #111;
      border-radius: 8px;
      padding: 16px;
      margin-top: 12px;
    }

    .sigblock-result-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 0;
      font-size: 13px;
      color: #888;
    }

    .sigblock-result-item svg {
      width: 16px;
      height: 16px;
      color: #22c55e;
    }

    .btn-row {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-top: 16px;
    }

    .btn-flow {
      background: #22c55e;
      color: #000;
    }

    .btn-flow:hover {
      background: #16a34a;
    }

    .no-data-msg {
      font-size: 13px;
      color: #555;
      text-align: center;
      padding: 16px;
    }

    /* Modal Overlay */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      -webkit-app-region: no-drag;
    }

    .modal-overlay.hidden {
      display: none;
    }

    .modal {
      background: #111;
      border: 1px solid #333;
      border-radius: 16px;
      padding: 32px;
      max-width: 480px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal h2 {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 16px;
      color: #fff;
    }

    .modal-content {
      font-size: 13px;
      color: #999;
      line-height: 1.6;
      margin-bottom: 24px;
    }

    .modal-content p {
      margin-bottom: 12px;
    }

    .modal-content strong {
      color: #fff;
    }

    .modal-actions {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .modal-actions .btn {
      width: 100%;
      text-align: center;
    }

    /* Login Modal */
    .login-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1100;
      -webkit-app-region: no-drag;
    }

    .login-modal.hidden {
      display: none;
    }

    .login-box {
      background: #111;
      border: 1px solid #333;
      border-radius: 16px;
      padding: 40px;
      max-width: 400px;
      width: 90%;
      text-align: center;
      position: relative;
    }

    .login-close-btn {
      position: absolute;
      top: 12px;
      right: 12px;
      background: none;
      border: none;
      color: #666;
      font-size: 24px;
      cursor: pointer;
      padding: 4px 8px;
      line-height: 1;
      transition: color 0.15s;
    }

    .login-close-btn:hover {
      color: #fff;
    }

    .login-box h2 {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 8px;
      color: #fff;
    }

    .login-box .subtitle {
      font-size: 14px;
      color: #666;
      margin-bottom: 32px;
    }

    .login-options {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .login-option {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.15s;
    }

    .login-option:hover {
      border-color: #555;
      background: #222;
    }

    .login-option.selected {
      border-color: #fff;
      background: #222;
    }

    .login-option-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #333;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .login-option-icon svg {
      width: 20px;
      height: 20px;
      stroke: #888;
    }

    .login-option.selected .login-option-icon {
      background: #fff;
    }

    .login-option.selected .login-option-icon svg {
      stroke: #000;
    }

    .login-option-text {
      text-align: left;
      flex: 1;
    }

    .login-option-text h3 {
      font-size: 15px;
      font-weight: 500;
      color: #fff;
      margin-bottom: 4px;
    }

    .login-option-text p {
      font-size: 12px;
      color: #666;
    }

    .login-name-input {
      margin-top: 20px;
      display: none;
    }

    .login-name-input.visible {
      display: block;
    }

    .login-name-input input {
      width: 100%;
      padding: 14px 16px;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 8px;
      color: #fff;
      font-size: 14px;
      outline: none;
      transition: border-color 0.15s;
    }

    .login-name-input input:focus {
      border-color: #555;
    }

    .login-name-input input::placeholder {
      color: #555;
    }

    .login-continue-btn {
      margin-top: 24px;
      width: 100%;
      padding: 14px 24px;
      font-size: 15px;
      font-weight: 500;
      background: #fff;
      color: #000;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.15s;
    }

    .login-continue-btn:hover {
      background: #e5e5e5;
    }

    .login-continue-btn:disabled {
      background: #333;
      color: #666;
      cursor: not-allowed;
    }

    /* Login Tabs */
    .login-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
    }

    .login-tab {
      flex: 1;
      padding: 12px 16px;
      font-size: 14px;
      font-weight: 500;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 8px;
      color: #888;
      cursor: pointer;
      transition: all 0.15s;
    }

    .login-tab:hover {
      border-color: #555;
      color: #fff;
    }

    .login-tab.active {
      background: #fff;
      color: #000;
      border-color: #fff;
    }

    /* Login Forms */
    .login-form {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .login-form.hidden {
      display: none;
    }

    .login-form input {
      width: 100%;
      padding: 14px 16px;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 8px;
      color: #fff;
      font-size: 14px;
      outline: none;
      transition: border-color 0.15s;
      box-sizing: border-box;
    }

    .login-form input:focus {
      border-color: #555;
    }

    .login-form input::placeholder {
      color: #555;
    }

    .login-form button {
      margin-top: 8px;
      width: 100%;
      padding: 14px 24px;
      font-size: 15px;
      font-weight: 500;
      background: #fff;
      color: #000;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.15s;
    }

    .login-form button:hover {
      background: #e5e5e5;
    }

    .login-form button:disabled {
      background: #333;
      color: #666;
      cursor: not-allowed;
    }

    .login-error {
      color: #ff4444;
      font-size: 13px;
      text-align: center;
      min-height: 20px;
    }

    .login-form p {
      color: #888;
      font-size: 13px;
      text-align: center;
      margin: 8px 0;
    }

    .forgot-password-link {
      margin-top: 16px;
    }

    .forgot-password-link a,
    .back-to-login a {
      color: #888;
      text-decoration: none;
      font-size: 13px;
    }

    .forgot-password-link a:hover,
    .back-to-login a:hover {
      color: #fff;
      text-decoration: underline;
    }

    .section-label {
      color: #888;
      font-size: 12px;
      text-align: left;
      margin: 12px 0 4px 0;
    }

    .login-select {
      width: 100%;
      padding: 14px 16px;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 8px;
      color: #fff;
      font-size: 14px;
      outline: none;
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23888' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 16px center;
    }

    .login-select:focus {
      border-color: #555;
    }

    .login-select option {
      background: #1a1a1a;
      color: #fff;
    }

    .security-question-display {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 12px 16px;
      color: #fff;
      font-size: 14px;
      text-align: left;
      margin: 8px 0;
    }

    /* Update banner */
    .update-banner {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 12px 20px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      z-index: 900;
      -webkit-app-region: no-drag;
      min-width: 300px;
    }

    .update-banner.hidden {
      display: none;
    }

    .update-banner-row {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .update-banner p {
      font-size: 13px;
      color: #888;
      flex: 1;
    }

    .update-progress-container {
      display: none;
      width: 100%;
    }

    .update-progress-container.visible {
      display: block;
    }

    .update-progress-bar {
      width: 100%;
      height: 4px;
      background: #333;
      border-radius: 2px;
      overflow: hidden;
    }

    .update-progress-fill {
      height: 100%;
      background: #22c55e;
      transition: width 0.3s;
      width: 0%;
    }

    .update-progress-text {
      font-size: 11px;
      color: #666;
      margin-top: 4px;
      text-align: center;
    }

    .update-banner .btn {
      padding: 8px 16px;
      font-size: 12px;
    }

    /* User info in header */
    .user-info {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: #666;
      -webkit-app-region: no-drag;
      cursor: pointer;
    }

    .user-info:hover {
      color: #888;
    }

    .user-avatar {
      width: 24px;
      height: 24px;
      background: #222;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .history-btn {
      background: transparent;
      border: 1px solid #333;
      border-radius: 6px;
      padding: 6px 8px;
      color: #666;
      cursor: pointer;
      -webkit-app-region: no-drag;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .history-btn:hover {
      border-color: #555;
      color: #fff;
      background: #222;
    }

    /* History Modal */
    .history-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s;
    }

    .history-modal.visible {
      opacity: 1;
      visibility: visible;
    }

    .history-content {
      background: #111;
      border: 1px solid #333;
      border-radius: 12px;
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .history-header {
      padding: 16px 20px;
      border-bottom: 1px solid #222;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .history-header h2 {
      font-size: 16px;
      font-weight: 600;
    }

    .history-close {
      background: transparent;
      border: none;
      color: #666;
      cursor: pointer;
      font-size: 20px;
      line-height: 1;
    }

    .history-close:hover {
      color: #fff;
    }

    .history-tabs {
      display: flex;
      border-bottom: 1px solid #222;
    }

    .history-tab {
      flex: 1;
      padding: 12px;
      background: transparent;
      border: none;
      color: #666;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
    }

    .history-tab:hover {
      color: #888;
    }

    .history-tab.active {
      color: #fff;
      border-bottom: 2px solid #fff;
    }

    .history-body {
      padding: 16px 20px;
      overflow-y: auto;
      flex: 1;
    }

    .history-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .history-item {
      background: #1a1a1a;
      border-radius: 8px;
      padding: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .history-item-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .history-item-feature {
      font-size: 13px;
      font-weight: 500;
    }

    .history-item-meta {
      font-size: 11px;
      color: #666;
    }

    .history-item-stats {
      text-align: right;
      font-size: 12px;
      color: #888;
    }

    .history-stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }

    .history-stat-card {
      background: #1a1a1a;
      border-radius: 8px;
      padding: 16px;
      text-align: center;
    }

    .history-stat-value {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .history-stat-label {
      font-size: 11px;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .history-actions {
      padding: 16px 20px;
      border-top: 1px solid #222;
      display: flex;
      gap: 8px;
    }

    .history-empty {
      text-align: center;
      color: #666;
      padding: 40px 20px;
    }

    /* Settings Modal */
    .settings-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
    }

    .settings-modal.visible {
      opacity: 1;
      visibility: visible;
    }

    .settings-content {
      background: #111;
      border: 1px solid #333;
      border-radius: 12px;
      width: 90%;
      max-width: 450px;
      padding: 24px;
    }

    .settings-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .settings-header h2 {
      font-size: 16px;
      font-weight: 600;
    }

    .settings-close {
      background: transparent;
      border: none;
      color: #666;
      cursor: pointer;
      font-size: 20px;
      line-height: 1;
    }

    .settings-close:hover {
      color: #fff;
    }

    .settings-section {
      margin-bottom: 20px;
    }

    .settings-section h3 {
      font-size: 13px;
      color: #888;
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .api-key-input-group {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }

    .api-key-input {
      flex: 1;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 10px 14px;
      font-size: 13px;
      color: #fff;
      font-family: monospace;
    }

    .api-key-input:focus {
      outline: none;
      border-color: #555;
    }

    .api-key-input::placeholder {
      color: #555;
    }

    .api-key-status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: #666;
      margin-bottom: 12px;
    }

    .api-key-status.connected {
      color: #22c55e;
    }

    .api-key-status.error {
      color: #ef4444;
    }

    .api-key-actions {
      display: flex;
      gap: 8px;
    }

    .settings-btn {
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .settings-btn-primary {
      background: #fff;
      color: #000;
      border: none;
    }

    .settings-btn-primary:hover {
      background: #e5e5e5;
    }

    .settings-btn-secondary {
      background: transparent;
      color: #888;
      border: 1px solid #333;
    }

    .settings-btn-secondary:hover {
      border-color: #555;
      color: #fff;
    }

    .settings-btn-danger {
      background: transparent;
      color: #ef4444;
      border: 1px solid #333;
    }

    .settings-btn-danger:hover {
      border-color: #ef4444;
    }

    .settings-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .settings-info {
      font-size: 11px;
      color: #555;
      margin-top: 12px;
    }

    .settings-info a {
      color: #888;
      text-decoration: underline;
    }

    /* Update Check Section */
    .update-check-row {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-top: 12px;
    }

    .update-check-status {
      font-size: 13px;
      color: #888;
    }

    .update-check-status.success {
      color: #22c55e;
    }

    .update-check-status.error {
      color: #ef4444;
    }

    .current-version {
      font-size: 13px;
      color: #666;
      margin-bottom: 8px;
    }

    .current-version strong {
      color: #fff;
    }

    /* Settings button in header */
    .settings-btn-header {
      background: transparent;
      border: none;
      color: #666;
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: color 0.2s;
    }

    .settings-btn-header:hover {
      color: #fff;
    }

    /* Collate Tab Styles */
    .file-list {
      background: #111;
      border-radius: 8px;
      padding: 8px;
      max-height: 120px;
      overflow-y: auto;
      margin-top: 8px;
    }

    .file-list-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 8px;
      font-size: 12px;
      color: #888;
      border-bottom: 1px solid #222;
    }

    .file-list-item:last-child {
      border-bottom: none;
    }

    .file-list-item .remove-btn {
      background: none;
      border: none;
      color: #666;
      cursor: pointer;
      padding: 2px 6px;
      font-size: 14px;
      -webkit-app-region: no-drag;
    }

    .file-list-item .remove-btn:hover {
      color: #ef4444;
    }

    .collate-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-top: 12px;
    }

    .stat-box {
      background: #111;
      border-radius: 8px;
      padding: 12px;
      text-align: center;
    }

    .stat-value {
      font-size: 24px;
      font-weight: 600;
      color: #fff;
    }

    .stat-label {
      font-size: 11px;
      color: #666;
      margin-top: 4px;
    }

    .stat-value.warning {
      color: #f59e0b;
    }

    .stat-value.error {
      color: #ef4444;
    }

    .conflict-list {
      background: #1a1a1a;
      border: 1px solid #ef4444;
      border-radius: 8px;
      padding: 12px;
      margin-top: 12px;
      max-height: 150px;
      overflow-y: auto;
    }

    .conflict-item {
      font-size: 12px;
      color: #f59e0b;
      padding: 6px 0;
      border-bottom: 1px solid #333;
    }

    .conflict-item:last-child {
      border-bottom: none;
    }

    /* Tab scrolling */
    #packetsTab,
    #executionTab,
    #sigblocksTab,
    #collateTab {
      overflow-y: auto;
      flex: 1;
      padding-bottom: 40px;
    }

    .tabs {
      flex-shrink: 0;
    }

    /* File count badge */
    .file-count {
      font-size: 12px;
      color: #22c55e;
      margin-top: 4px;
    }

    /* Email Tab Styles */
    #emailTab {
      overflow-y: auto;
      flex: 1;
      padding-bottom: 40px;
    }

    .email-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-top: 16px;
    }

    /* Search Mode Toggle */
    .search-mode-toggle {
      display: flex;
      gap: 4px;
      margin-top: 16px;
      background: #111;
      border-radius: 8px;
      padding: 4px;
    }

    .search-mode-btn {
      flex: 1;
      padding: 8px 12px;
      border: none;
      background: transparent;
      color: #666;
      font-size: 13px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .search-mode-btn:hover {
      color: #888;
    }

    .search-mode-btn.active {
      background: #222;
      color: #fff;
    }

    .email-search {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    .email-search-input {
      flex: 1;
      background: #111;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 12px 16px;
      font-size: 14px;
      color: #fff;
      -webkit-app-region: no-drag;
    }

    .email-search-input:focus {
      outline: none;
      border-color: #555;
    }

    .email-search-input::placeholder {
      color: #555;
    }

    .email-filters {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-top: 12px;
      padding: 16px;
      background: #111;
      border-radius: 8px;
      border: 1px solid #222;
    }

    .email-filter-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .email-filter-group label {
      font-size: 11px;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .email-filter-input {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 6px;
      padding: 8px 12px;
      font-size: 13px;
      color: #fff;
      -webkit-app-region: no-drag;
    }

    .email-filter-input:focus {
      outline: none;
      border-color: #555;
    }

    .email-filter-input::placeholder {
      color: #555;
    }

    .email-date-range {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .email-date-range span {
      color: #555;
      font-size: 12px;
    }

    .email-date-input {
      flex: 1;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 6px;
      padding: 8px 12px;
      font-size: 13px;
      color: #fff;
      -webkit-app-region: no-drag;
    }

    .email-date-input:focus {
      outline: none;
      border-color: #555;
    }

    .email-filter-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
    }

    .email-filter-toggle input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: #fff;
    }

    .email-filter-toggle span {
      font-size: 13px;
      color: #aaa;
    }

    .email-clear-filters {
      background: none;
      border: 1px solid #333;
      color: #888;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .email-clear-filters:hover {
      border-color: #555;
      color: #fff;
    }

    /* AI Search Panel */
    .ai-search-panel {
      margin-top: 12px;
      display: none;
    }

    .ai-search-panel.visible {
      display: block;
    }

    .ai-search-input {
      width: 100%;
      background: #111;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 12px 16px;
      font-size: 14px;
      color: #fff;
      resize: vertical;
      min-height: 80px;
      font-family: inherit;
      -webkit-app-region: no-drag;
    }

    .ai-search-input:focus {
      outline: none;
      border-color: #555;
    }

    .ai-search-input::placeholder {
      color: #555;
    }

    .ai-search-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    .ai-search-loading {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      background: #111;
      border-radius: 8px;
      margin-top: 12px;
      color: #888;
      font-size: 13px;
    }

    .ai-search-loading .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid #333;
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .ai-answer-box {
      background: #111;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 16px;
      margin-top: 12px;
    }

    .ai-answer-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
      font-size: 12px;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .ai-answer-header .ai-icon {
      font-size: 16px;
    }

    .ai-answer-text {
      font-size: 14px;
      line-height: 1.6;
      color: #fff;
    }

    .ai-answer-confidence {
      margin-top: 12px;
      font-size: 11px;
      color: #666;
    }

    .ai-relevant-emails {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid #222;
    }

    .ai-relevant-emails h4 {
      font-size: 12px;
      color: #888;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .email-results {
      margin-top: 16px;
    }

    .email-results h3 {
      font-size: 13px;
      color: #888;
      margin-bottom: 12px;
    }

    .email-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 300px;
      overflow-y: auto;
    }

    .email-item {
      background: #111;
      border-radius: 8px;
      padding: 12px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .email-item:hover {
      background: #1a1a1a;
    }

    .email-item-subject {
      font-size: 13px;
      font-weight: 500;
      color: #fff;
      margin-bottom: 4px;
    }

    .email-item-meta {
      font-size: 11px;
      color: #666;
    }

    .email-item-match {
      font-size: 10px;
      color: #22c55e;
      margin-top: 4px;
    }

    .privacy-toggle {
      margin-top: 16px;
      padding: 12px;
      background: #111;
      border-radius: 8px;
    }

    .toggle-label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: #888;
      cursor: pointer;
    }

    .toggle-label input {
      -webkit-app-region: no-drag;
    }

    .blurred {
      filter: blur(4px);
      user-select: none;
    }

    /* Time Tracking Tab Styles */
    #timetrackTab {
      overflow-y: auto;
      flex: 1;
      padding-bottom: 40px;
    }

    .timetrack-summary-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }

    .timetrack-matters {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .matter-item {
      background: #111;
      border-radius: 8px;
      padding: 12px;
    }

    .matter-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .matter-name {
      font-size: 14px;
      font-weight: 500;
    }

    .matter-hours {
      font-size: 14px;
      color: #22c55e;
    }

    .matter-bar {
      height: 4px;
      background: #222;
      border-radius: 2px;
      overflow: hidden;
      margin-bottom: 8px;
    }

    .matter-bar-fill {
      height: 100%;
      background: #22c55e;
    }

    .matter-details {
      font-size: 11px;
      color: #666;
    }

    .timetrack-timeline {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 200px;
      overflow-y: auto;
    }

    .timeline-item {
      display: flex;
      gap: 12px;
      font-size: 12px;
      padding: 8px;
      background: #111;
      border-radius: 6px;
    }

    .timeline-time {
      color: #888;
      min-width: 70px;
    }

    .timeline-icon {
      width: 16px;
      text-align: center;
    }

    .timeline-desc {
      flex: 1;
      color: #ccc;
    }

    .timetrack-options {
      display: flex;
      align-items: center;
    }

    .timetrack-options input {
      -webkit-app-region: no-drag;
    }
  </style>
</head>
<body>
  <!-- Login Modal -->
  <div class="login-modal" id="loginModal">
    <div class="login-box">
      <button class="login-close-btn" id="loginCloseBtn">&times;</button>
      <h2>Welcome to EmmaNeigh</h2>
      <p class="subtitle">Sign in to save your API key and usage history</p>

      <!-- Tab Toggle -->
      <div class="login-tabs">
        <button class="login-tab active" data-tab="login">Login</button>
        <button class="login-tab" data-tab="create">Create Account</button>
        <button class="login-tab" data-tab="guest">Guest</button>
      </div>

      <!-- Login Form -->
      <div class="login-form" id="loginForm">
        <input type="text" id="loginUsername" placeholder="Username" autocomplete="username">
        <input type="password" id="loginPassword" placeholder="Password" autocomplete="current-password">
        <p class="login-error" id="loginError"></p>
        <button id="loginBtn">Login</button>
        <p class="forgot-password-link"><a href="#" id="forgotPasswordLink">Forgot Password?</a></p>
      </div>

      <!-- Create Account Form -->
      <div class="login-form hidden" id="createForm">
        <input type="text" id="createUsername" placeholder="Username" autocomplete="username">
        <input type="email" id="createEmail" placeholder="Email (optional)">
        <input type="text" id="createDisplayName" placeholder="Display Name (optional)">
        <input type="password" id="createPassword" placeholder="Password (min 4 characters)" autocomplete="new-password">
        <input type="password" id="createPasswordConfirm" placeholder="Confirm Password" autocomplete="new-password">
        <p class="section-label">Security Question (for password recovery)</p>
        <select id="createSecurityQuestion" class="login-select">
          <option value="">Select a security question...</option>
          <option value="pet">What was the name of your first pet?</option>
          <option value="city">In what city were you born?</option>
          <option value="school">What was the name of your first school?</option>
          <option value="mother">What is your mother's maiden name?</option>
        </select>
        <input type="text" id="createSecurityAnswer" placeholder="Your answer">
        <p class="login-error" id="createError"></p>
        <button id="createBtn">Create Account</button>
      </div>

      <!-- Forgot Password Form -->
      <div class="login-form hidden" id="forgotForm">
        <p>Enter your username to reset your password.</p>
        <input type="text" id="forgotUsername" placeholder="Username">
        <button id="lookupQuestionBtn">Look Up Security Question</button>
        <p class="security-question-display" id="forgotQuestionDisplay"></p>
        <input type="text" id="forgotSecurityAnswer" placeholder="Security Answer" style="display: none;">
        <input type="password" id="forgotNewPassword" placeholder="New Password" style="display: none;">
        <input type="password" id="forgotNewPasswordConfirm" placeholder="Confirm New Password" style="display: none;">
        <p class="login-error" id="forgotError"></p>
        <button id="resetPasswordBtn" style="display: none;">Reset Password</button>
        <p class="back-to-login"><a href="#" id="backToLoginLink">Back to Login</a></p>
      </div>

      <!-- Guest Mode -->
      <div class="login-form hidden" id="guestForm">
        <p>Continue without an account. Your API key and usage history will not be saved between sessions.</p>
        <input type="text" id="guestName" placeholder="Your name (optional)">
        <button id="guestBtn">Continue as Guest</button>
      </div>
    </div>
  </div>

  <!-- Disclaimer Modal -->
  <div class="modal-overlay" id="disclaimerModal">
    <div class="modal">
      <h2>Terms of Use</h2>
      <div class="modal-content">
        <p><strong>DISCLAIMER:</strong> EmmaNeigh is provided "as is" without warranty of any kind, express or implied.</p>
        <p>By using this software, you acknowledge and agree that:</p>
        <p>1. This tool is intended to assist with document processing and signature management. It does not constitute legal advice.</p>
        <p>2. You are solely responsible for reviewing and verifying all output documents before use.</p>
        <p>3. The developers and publishers of EmmaNeigh shall not be liable for any damages, losses, or legal issues arising from the use of this software.</p>
        <p>4. All document processing occurs locally on your machine. No data is transmitted to external servers.</p>
        <p>5. You agree to use this software in compliance with all applicable laws and regulations.</p>
      </div>
      <div class="modal-actions">
        <button class="btn btn-primary" id="acceptDisclaimerBtn">I Accept</button>
        <button class="btn btn-secondary" id="declineDisclaimerBtn">Decline & Exit</button>
      </div>
    </div>
  </div>

  <!-- History Modal -->
  <div class="history-modal" id="historyModal">
    <div class="history-content">
      <div class="history-header">
        <h2>Usage History</h2>
        <button class="history-close" id="historyClose">&times;</button>
      </div>
      <div class="history-tabs">
        <button class="history-tab active" data-history-tab="recent">Recent Activity</button>
        <button class="history-tab" data-history-tab="stats">Statistics</button>
      </div>
      <div class="history-body">
        <!-- Recent Tab -->
        <div id="historyRecentTab">
          <div class="history-list" id="historyList">
            <div class="history-empty">No activity recorded yet</div>
          </div>
        </div>
        <!-- Stats Tab -->
        <div id="historyStatsTab" style="display: none;">
          <div class="history-stats-grid" id="historyStatsGrid">
            <div class="history-stat-card">
              <div class="history-stat-value" id="statTotalOps">0</div>
              <div class="history-stat-label">Total Operations</div>
            </div>
            <div class="history-stat-card">
              <div class="history-stat-value" id="statTotalOutputs">0</div>
              <div class="history-stat-label">Documents Created</div>
            </div>
          </div>
          <h3 style="margin: 20px 0 12px; font-size: 13px; color: #888;">By Feature</h3>
          <div class="history-list" id="historyFeatureList"></div>
        </div>
      </div>
      <div class="history-actions">
        <button class="btn btn-secondary" id="historyExportBtn">Export CSV</button>
        <button class="btn btn-secondary" id="historyClearBtn" style="color: #ff6666;">Clear History</button>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="settings-modal" id="settingsModal">
    <div class="settings-content">
      <div class="settings-header">
        <h2>Settings</h2>
        <button class="settings-close" id="settingsClose">&times;</button>
      </div>

      <div class="settings-section">
        <h3>Claude API Key</h3>
        <p style="font-size: 12px; color: #666; margin-bottom: 12px;">
          Required for AI-powered features like natural language search, checklist updates, and punchlist generation.
        </p>
        <div class="api-key-input-group">
          <input type="password" class="api-key-input" id="apiKeyInput" placeholder="sk-ant-api...">
        </div>
        <div class="api-key-status" id="apiKeyStatus">
          <span>No API key configured</span>
        </div>
        <div class="api-key-actions">
          <button class="settings-btn settings-btn-primary" id="saveApiKeyBtn">Save Key</button>
          <button class="settings-btn settings-btn-secondary" id="testApiKeyBtn">Test Connection</button>
          <button class="settings-btn settings-btn-danger" id="deleteApiKeyBtn" style="display: none;">Delete</button>
        </div>
        <p class="settings-info">
          Get your API key from <a href="#" id="anthropicLink">console.anthropic.com</a>.
          Your key is encrypted and stored locally.
        </p>
      </div>

      <div class="settings-section">
        <h3>Updates</h3>
        <p class="current-version">Current version: <strong id="currentVersion">...</strong></p>
        <div class="update-check-row">
          <button class="settings-btn settings-btn-secondary" id="checkUpdatesBtn">Check for Updates</button>
          <span class="update-check-status" id="updateCheckStatus"></span>
        </div>
      </div>
    </div>
  </div>

  <!-- Update Banner -->
  <div class="update-banner hidden" id="updateBanner">
    <div class="update-banner-row">
      <p id="updateMessage">A new version is available!</p>
      <button class="btn btn-primary" id="updateBtn">Download</button>
      <button class="btn btn-secondary" id="dismissUpdateBtn" style="margin-top: 0;">Later</button>
    </div>
    <div class="update-progress-container" id="updateProgressContainer">
      <div class="update-progress-bar">
        <div class="update-progress-fill" id="updateProgressFill"></div>
      </div>
      <p class="update-progress-text" id="updateProgressText">Downloading...</p>
    </div>
  </div>

  <div class="container">
    <header>
      <div class="header-row">
        <div class="logo">EmmaNeigh</div>
        <div class="header-actions">
          <button class="settings-btn-header" id="settingsBtn" title="Settings">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="3"/>
              <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
            </svg>
          </button>
          <button class="history-btn" id="historyBtn" title="View History">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <polyline points="12 6 12 12 16 14"/>
            </svg>
          </button>
          <div class="user-info" id="userInfo">
            <div class="user-avatar">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                <circle cx="12" cy="7" r="4"/>
              </svg>
            </div>
            <span id="userName">Guest</span>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Layout: Sidebar + Content -->
    <div class="main-layout">
      <!-- Navigation Sidebar -->
      <div class="nav-sidebar">
        <!-- Group 1: Signature Packets / Closing -->
        <div class="nav-category expanded">
          <button class="nav-category-header">
            <span class="icon"></span>
            <span>Closing</span>
            <span class="arrow"></span>
          </button>
          <div class="nav-items">
            <button class="nav-item active" data-tab="packets">Create Sig Packets</button>
            <button class="nav-item" data-tab="execution">Execution Versions</button>
            <button class="nav-item" data-tab="sigblocks">Sig Blocks from Checklist</button>
          </div>
        </div>

        <!-- Group 2: Time Management -->
        <div class="nav-category">
          <button class="nav-category-header">
            <span class="icon"></span>
            <span>Time Management</span>
            <span class="arrow"></span>
          </button>
          <div class="nav-items">
            <button class="nav-item" data-tab="timetrack">Activity Summary</button>
          </div>
        </div>

        <!-- Group 3: Project Management -->
        <div class="nav-category">
          <button class="nav-category-header">
            <span class="icon"></span>
            <span>Project Management</span>
            <span class="arrow"></span>
          </button>
          <div class="nav-items">
            <button class="nav-item" data-tab="email">Email Search</button>
            <button class="nav-item" data-tab="updatechecklist">Update Checklist</button>
            <button class="nav-item" data-tab="punchlist">Generate Punchlist</button>
          </div>
        </div>

        <!-- Group 4: Document Processing -->
        <div class="nav-category">
          <button class="nav-category-header">
            <span class="icon"></span>
            <span>Document Processing</span>
            <span class="arrow"></span>
          </button>
          <div class="nav-items">
            <button class="nav-item" data-tab="collate">Collate Documents</button>
          </div>
        </div>
      </div>

      <!-- Content Area -->
      <div class="content-area">
        <!-- Signature Packets Tab -->
        <div id="packetsTab">

    <!-- Drop Zone -->
    <div class="drop-zone" id="dropZone">
      <svg class="drop-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <path d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5"/>
      </svg>
      <p class="drop-text">Drop folder or PDFs here, or <span>browse</span></p>
      <p class="drop-hint">Accepts a folder or individual PDF files with signature pages</p>
      <p class="file-count" id="packetsFileCount"></p>
    </div>

    <!-- Processing -->
    <div class="processing" id="processing">
      <div class="horse-container">
        <div class="horse">
          <svg viewBox="0 0 100 62" xmlns="http://www.w3.org/2000/svg">
            <!-- Body -->
            <ellipse cx="50" cy="35" rx="28" ry="16"/>
            <!-- Neck -->
            <path d="M 70 28 Q 82 18 85 8 Q 90 16 84 28 Q 78 32 70 32 Z"/>
            <!-- Head -->
            <ellipse cx="88" cy="8" rx="11" ry="7"/>
            <!-- Ear -->
            <path d="M 94 2 L 97 -4 L 96 3 Z"/>
            <!-- Eye -->
            <circle cx="92" cy="6" r="1.5" fill="#0a0a0a"/>
            <!-- Mane -->
            <path d="M 84 10 Q 78 4 76 14 Q 72 8 70 18" fill="none" stroke="#fff" stroke-width="2.5" stroke-linecap="round"/>
            <!-- Tail -->
            <path d="M 22 35 Q 10 32 6 42 Q 12 38 14 46" fill="none" stroke="#fff" stroke-width="3" stroke-linecap="round"/>
            <!-- Front legs -->
            <g class="front-legs">
              <rect x="62" y="46" width="5" height="14" rx="2"/>
              <rect x="54" y="46" width="5" height="14" rx="2"/>
            </g>
            <!-- Back legs -->
            <g class="back-legs">
              <rect x="38" y="46" width="5" height="14" rx="2"/>
              <rect x="30" y="46" width="5" height="14" rx="2"/>
            </g>
          </svg>
        </div>
        <div class="dust">
          <div class="dust-particle"></div>
          <div class="dust-particle"></div>
          <div class="dust-particle"></div>
        </div>
      </div>
      <p class="progress-text" id="progressText">Processing...</p>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
      </div>
    </div>

    <!-- Complete -->
    <div class="complete" id="complete">
      <svg class="check-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
      </svg>
      <h2>Complete</h2>
      <p id="resultText">Created 0 signature packets</p>
      <button class="btn btn-primary" id="downloadBtn">Download ZIP</button>
      <button class="btn btn-secondary" id="resetBtn">Process Another</button>
    </div>

    <!-- Error -->
    <div class="error" id="error">
      <svg class="error-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z"/>
      </svg>
      <h2>Error</h2>
      <p id="errorText">Something went wrong</p>
      <button class="btn btn-secondary" id="retryBtn">Try Again</button>
    </div>
    </div><!-- End packetsTab -->

    <!-- Execution Version Tab -->
    <div id="executionTab" style="display: none;">
      <!-- Execution Inputs -->
      <div class="exec-inputs" id="execInputs">
        <p class="subtitle" style="margin-bottom: 8px;">Merge signed DocuSign pages back into original agreements</p>

        <div class="input-section" id="originalsInput">
          <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M2.25 12.75V12A2.25 2.25 0 014.5 9.75h15A2.25 2.25 0 0121.75 12v.75m-8.69-6.44l-2.12-2.12a1.5 1.5 0 00-1.061-.44H4.5A2.25 2.25 0 002.25 6v12a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9a2.25 2.25 0 00-2.25-2.25h-5.379a1.5 1.5 0 01-1.06-.44z"/>
          </svg>
          <p class="input-label">Original Agreements</p>
          <p class="input-hint">Folder or individual PDF files</p>
          <p class="input-selected" id="originalsSelected"></p>
        </div>

        <div class="input-section" id="signedInput">
          <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z"/>
          </svg>
          <p class="input-label">Signed PDF from DocuSign</p>
          <p class="input-hint">Single PDF with all signed pages</p>
          <p class="input-selected" id="signedSelected"></p>
        </div>

        <div class="exec-actions">
          <button class="btn btn-primary" id="processExecBtn" disabled>Create Execution Versions</button>
        </div>
      </div>

      <!-- Execution Processing -->
      <div class="processing" id="execProcessing">
        <div class="horse-container">
          <div class="horse">
            <svg viewBox="0 0 100 62" xmlns="http://www.w3.org/2000/svg">
              <ellipse cx="50" cy="35" rx="28" ry="16"/>
              <path d="M 70 28 Q 82 18 85 8 Q 90 16 84 28 Q 78 32 70 32 Z"/>
              <ellipse cx="88" cy="8" rx="11" ry="7"/>
              <path d="M 94 2 L 97 -4 L 96 3 Z"/>
              <circle cx="92" cy="6" r="1.5" fill="#0a0a0a"/>
              <path d="M 84 10 Q 78 4 76 14 Q 72 8 70 18" fill="none" stroke="#fff" stroke-width="2.5" stroke-linecap="round"/>
              <path d="M 22 35 Q 10 32 6 42 Q 12 38 14 46" fill="none" stroke="#fff" stroke-width="3" stroke-linecap="round"/>
              <g class="front-legs">
                <rect x="62" y="46" width="5" height="14" rx="2"/>
                <rect x="54" y="46" width="5" height="14" rx="2"/>
              </g>
              <g class="back-legs">
                <rect x="38" y="46" width="5" height="14" rx="2"/>
                <rect x="30" y="46" width="5" height="14" rx="2"/>
              </g>
            </svg>
          </div>
          <div class="dust">
            <div class="dust-particle"></div>
            <div class="dust-particle"></div>
            <div class="dust-particle"></div>
          </div>
        </div>
        <p class="progress-text" id="execProgressText">Processing...</p>
        <div class="progress-bar">
          <div class="progress-fill" id="execProgressFill" style="width: 0%"></div>
        </div>
      </div>

      <!-- Execution Complete -->
      <div class="complete" id="execComplete">
        <svg class="check-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        <h2>Complete</h2>
        <p id="execResultText">Created 0 executed documents</p>
        <p class="result-summary" id="execResultSummary"></p>
        <button class="btn btn-primary" id="execDownloadBtn">Download ZIP</button>
        <button class="btn btn-secondary" id="execResetBtn">Process Another</button>
      </div>

      <!-- Execution Error -->
      <div class="error" id="execError">
        <svg class="error-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z"/>
        </svg>
        <h2>Error</h2>
        <p id="execErrorText">Something went wrong</p>
        <button class="btn btn-secondary" id="execRetryBtn">Try Again</button>
      </div>
    </div><!-- End executionTab -->

    <!-- Signature Blocks Tab -->
    <div id="sigblocksTab" style="display: none;">
      <!-- Input Steps -->
      <div id="sigblocksInputs" class="exec-inputs">
        <p class="subtitle" style="margin-bottom: 8px;">Generate signature blocks from checklist and incumbency certificates</p>

        <!-- Step 1: Checklist -->
        <div class="sigblock-step">
          <div class="sigblock-step-header" id="checklistHeader">
            <span class="step-number">1</span>
            Transaction Checklist
          </div>
          <div class="input-section" id="checklistInput">
            <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M3.375 19.5h17.25m-17.25 0a1.125 1.125 0 01-1.125-1.125M3.375 19.5h7.5c.621 0 1.125-.504 1.125-1.125m-9.75 0V5.625m0 12.75v-1.5c0-.621.504-1.125 1.125-1.125m18.375 2.625V5.625m0 12.75c0 .621-.504 1.125-1.125 1.125m1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125m0 3.75h-7.5A1.125 1.125 0 0112 18.375m9.75-12.75c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125m19.5 0v1.5c0 .621-.504 1.125-1.125 1.125M2.25 5.625v1.5c0 .621.504 1.125 1.125 1.125m0 0h17.25m-17.25 0h7.5c.621 0 1.125.504 1.125 1.125M3.375 8.25c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125m17.25-3.75h-7.5c-.621 0-1.125.504-1.125 1.125m8.625-1.125c.621 0 1.125.504 1.125 1.125v1.5c0 .621-.504 1.125-1.125 1.125"/>
            </svg>
            <p class="input-label">Drop checklist here (.xlsx, .csv)</p>
            <p class="input-hint">Should have Document and Signatories columns</p>
            <p class="input-selected" id="checklistSelected"></p>
          </div>
        </div>

        <!-- Step 2: Incumbency Certificates -->
        <div class="sigblock-step">
          <div class="sigblock-step-header" id="incumbencyHeader">
            <span class="step-number">2</span>
            Incumbency Certificates
          </div>
          <div class="input-section" id="incumbencyInput">
            <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z"/>
            </svg>
            <p class="input-label">Drop incumbency certs here (.pdf, .docx)</p>
            <p class="input-hint">Multiple files supported - one per entity</p>
            <p class="input-selected" id="incumbencySelected"></p>
          </div>
        </div>

        <!-- Step 3: Entity Mapping -->
        <div class="sigblock-step" id="mappingStep" style="display: none;">
          <div class="sigblock-step-header">
            <span class="step-number">3</span>
            Entity Mapping
          </div>
          <div class="entity-mapping" id="entityMapping">
            <!-- Populated dynamically -->
          </div>
        </div>

        <!-- Step 4: Documents -->
        <div class="sigblock-step" id="documentsStep" style="display: none;">
          <div class="sigblock-step-header" id="documentsHeader">
            <span class="step-number">4</span>
            Unsigned Documents
          </div>
          <div class="input-section" id="documentsInput">
            <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M2.25 12.75V12A2.25 2.25 0 014.5 9.75h15A2.25 2.25 0 0121.75 12v.75m-8.69-6.44l-2.12-2.12a1.5 1.5 0 00-1.061-.44H4.5A2.25 2.25 0 002.25 6v12a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9a2.25 2.25 0 00-2.25-2.25h-5.379a1.5 1.5 0 01-1.06-.44z"/>
            </svg>
            <p class="input-label">Drop documents folder here</p>
            <p class="input-hint">PDFs and Word docs to add signature blocks</p>
            <p class="input-selected" id="documentsSelected"></p>
          </div>
        </div>

        <div class="exec-actions">
          <button class="btn btn-primary" id="generateSigblocksBtn" disabled>Generate Signature Blocks</button>
        </div>
      </div>

      <!-- Processing -->
      <div class="processing" id="sigblocksProcessing">
        <div class="horse-container">
          <div class="horse">
            <svg viewBox="0 0 100 62" xmlns="http://www.w3.org/2000/svg">
              <ellipse cx="50" cy="35" rx="28" ry="16"/>
              <path d="M 70 28 Q 82 18 85 8 Q 90 16 84 28 Q 78 32 70 32 Z"/>
              <ellipse cx="88" cy="8" rx="11" ry="7"/>
              <path d="M 94 2 L 97 -4 L 96 3 Z"/>
              <circle cx="92" cy="6" r="1.5" fill="#0a0a0a"/>
              <path d="M 84 10 Q 78 4 76 14 Q 72 8 70 18" fill="none" stroke="#fff" stroke-width="2.5" stroke-linecap="round"/>
              <path d="M 22 35 Q 10 32 6 42 Q 12 38 14 46" fill="none" stroke="#fff" stroke-width="3" stroke-linecap="round"/>
              <g class="front-legs">
                <rect x="62" y="46" width="5" height="14" rx="2"/>
                <rect x="54" y="46" width="5" height="14" rx="2"/>
              </g>
              <g class="back-legs">
                <rect x="38" y="46" width="5" height="14" rx="2"/>
                <rect x="30" y="46" width="5" height="14" rx="2"/>
              </g>
            </svg>
          </div>
          <div class="dust">
            <div class="dust-particle"></div>
            <div class="dust-particle"></div>
            <div class="dust-particle"></div>
          </div>
        </div>
        <p class="progress-text" id="sigblocksProgressText">Processing...</p>
        <div class="progress-bar">
          <div class="progress-fill" id="sigblocksProgressFill" style="width: 0%"></div>
        </div>
      </div>

      <!-- Complete -->
      <div class="complete" id="sigblocksComplete">
        <svg class="check-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        <h2>Complete</h2>
        <p id="sigblocksResultText">Generated signature blocks for 0 documents</p>
        <div class="sigblock-results" id="sigblocksResults">
          <!-- Populated dynamically -->
        </div>
        <div class="btn-row">
          <button class="btn btn-primary" id="sigblocksDownloadBtn">Download ZIP</button>
          <button class="btn btn-flow" id="sigblocksToPacketsBtn">Create Signature Packets </button>
        </div>
        <button class="btn btn-secondary" id="sigblocksResetBtn">Process Another</button>
      </div>

      <!-- Error -->
      <div class="error" id="sigblocksError">
        <svg class="error-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z"/>
        </svg>
        <h2>Error</h2>
        <p id="sigblocksErrorText">Something went wrong</p>
        <button class="btn btn-secondary" id="sigblocksRetryBtn">Try Again</button>
      </div>
    </div><!-- End sigblocksTab -->

    <!-- Collate Tab -->
    <div id="collateTab" style="display: none;">
      <!-- Collate Inputs -->
      <div id="collateInputs" class="exec-inputs">
        <p class="subtitle" style="margin-bottom: 8px;">Merge track changes and comments from multiple document versions</p>

        <!-- Base Document -->
        <div class="sigblock-step">
          <div class="sigblock-step-header" id="baseDocHeader">
            <span class="step-number">1</span>
            Base Document
          </div>
          <div class="input-section" id="baseDocInput">
            <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z"/>
            </svg>
            <p class="input-label">Drop base document here (.docx)</p>
            <p class="input-hint">The original clean version</p>
            <p class="input-selected" id="baseDocSelected"></p>
          </div>
        </div>

        <!-- Commented Versions -->
        <div class="sigblock-step">
          <div class="sigblock-step-header" id="commentedDocsHeader">
            <span class="step-number">2</span>
            Commented Versions
          </div>
          <div class="input-section" id="commentedDocsInput">
            <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M7.5 8.25h9m-9 3H12m-9.75 1.51c0 1.6 1.123 2.994 2.707 3.227 1.129.166 2.27.293 3.423.379.35.026.67.21.865.501L12 21l2.755-4.133a1.14 1.14 0 01.865-.501 48.172 48.172 0 003.423-.379c1.584-.233 2.707-1.626 2.707-3.228V6.741c0-1.602-1.123-2.995-2.707-3.228A48.394 48.394 0 0012 3c-2.392 0-4.744.175-7.043.513C3.373 3.746 2.25 5.14 2.25 6.741v6.018z"/>
            </svg>
            <p class="input-label">Drop commented versions here (.docx)</p>
            <p class="input-hint">Multiple files with track changes or comments</p>
            <p class="input-selected" id="commentedDocsSelected"></p>
          </div>
          <div class="file-list hidden" id="commentedDocsList">
            <!-- Populated dynamically -->
          </div>
        </div>

        <div class="exec-actions">
          <button class="btn btn-primary" id="collateBtn" disabled>Collate Documents</button>
        </div>
      </div>

      <!-- Processing -->
      <div class="processing" id="collateProcessing">
        <div class="horse-container">
          <div class="horse">
            <svg viewBox="0 0 100 62" xmlns="http://www.w3.org/2000/svg">
              <ellipse cx="50" cy="35" rx="28" ry="16"/>
              <path d="M 70 28 Q 82 18 85 8 Q 90 16 84 28 Q 78 32 70 32 Z"/>
              <ellipse cx="88" cy="8" rx="11" ry="7"/>
              <path d="M 94 2 L 97 -4 L 96 3 Z"/>
              <circle cx="92" cy="6" r="1.5" fill="#0a0a0a"/>
              <path d="M 84 10 Q 78 4 76 14 Q 72 8 70 18" fill="none" stroke="#fff" stroke-width="2.5" stroke-linecap="round"/>
              <path d="M 22 35 Q 10 32 6 42 Q 12 38 14 46" fill="none" stroke="#fff" stroke-width="3" stroke-linecap="round"/>
              <g class="front-legs">
                <rect x="62" y="46" width="5" height="14" rx="2"/>
                <rect x="54" y="46" width="5" height="14" rx="2"/>
              </g>
              <g class="back-legs">
                <rect x="38" y="46" width="5" height="14" rx="2"/>
                <rect x="30" y="46" width="5" height="14" rx="2"/>
              </g>
            </svg>
          </div>
          <div class="dust">
            <div class="dust-particle"></div>
            <div class="dust-particle"></div>
            <div class="dust-particle"></div>
          </div>
        </div>
        <p class="progress-text" id="collateProgressText">Processing...</p>
        <div class="progress-bar">
          <div class="progress-fill" id="collateProgressFill" style="width: 0%"></div>
        </div>
      </div>

      <!-- Complete -->
      <div class="complete" id="collateComplete">
        <svg class="check-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        <h2>Collation Complete</h2>
        <p id="collateResultText">Merged changes from 0 documents</p>

        <div class="collate-stats">
          <div class="stat-box">
            <div class="stat-value" id="totalChangesValue">0</div>
            <div class="stat-label">Track Changes</div>
          </div>
          <div class="stat-box">
            <div class="stat-value" id="totalCommentsValue">0</div>
            <div class="stat-label">Comments</div>
          </div>
          <div class="stat-box">
            <div class="stat-value" id="conflictsValue">0</div>
            <div class="stat-label">Conflicts</div>
          </div>
        </div>

        <div class="conflict-list hidden" id="conflictList">
          <!-- Populated dynamically -->
        </div>

        <div class="btn-row">
          <button class="btn btn-primary" id="collateDownloadBtn">Download ZIP</button>
        </div>
        <button class="btn btn-secondary" id="collateResetBtn">Process Another</button>
      </div>

      <!-- Error -->
      <div class="error" id="collateError">
        <svg class="error-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z"/>
        </svg>
        <h2>Error</h2>
        <p id="collateErrorText">Something went wrong</p>
        <button class="btn btn-secondary" id="collateRetryBtn">Try Again</button>
      </div>
    </div><!-- End collateTab -->

    <!-- Email Tab -->
    <div id="emailTab" style="display: none;">
      <!-- Upload State -->
      <div class="email-upload" id="emailUpload">
        <div class="input-section" id="emailCsvDrop">
          <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M21.75 9v.906a2.25 2.25 0 01-1.183 1.981l-6.478 3.488M2.25 9v.906a2.25 2.25 0 001.183 1.981l6.478 3.488m8.839 2.51l-4.66-2.51m0 0l-1.023-.55a2.25 2.25 0 00-2.134 0l-1.022.55m0 0l-4.661 2.51m16.5 1.615a2.25 2.25 0 01-2.25 2.25h-15a2.25 2.25 0 01-2.25-2.25V8.844a2.25 2.25 0 011.183-1.98l7.5-4.04a2.25 2.25 0 012.134 0l7.5 4.04a2.25 2.25 0 011.183 1.98V19.5z"/>
          </svg>
          <p class="input-label">Upload Email CSV</p>
          <p class="input-hint">Export emails from Outlook as CSV</p>
          <p class="input-selected" id="emailCsvSelected"></p>
        </div>

        <div class="email-stats" id="emailStats" style="display: none;">
          <div class="stat-box">
            <div class="stat-value" id="emailTotalCount">0</div>
            <div class="stat-label">Total Emails</div>
          </div>
          <div class="stat-box">
            <div class="stat-value" id="emailSenderCount">0</div>
            <div class="stat-label">Unique Senders</div>
          </div>
          <div class="stat-box">
            <div class="stat-value" id="emailDateRange">-</div>
            <div class="stat-label">Date Range</div>
          </div>
        </div>

        <!-- Search Mode Toggle -->
        <div class="search-mode-toggle" id="searchModeToggle" style="display: none;">
          <button class="search-mode-btn active" id="keywordSearchMode">Keyword Search</button>
          <button class="search-mode-btn" id="aiSearchMode"> AI Search</button>
        </div>

        <!-- Keyword Search Box -->
        <div class="email-search" id="emailSearchBox" style="display: none;">
          <input type="text" class="email-search-input" id="emailSearchInput" placeholder="Search emails by keyword...">
          <button class="btn btn-primary" id="emailSearchBtn">Search</button>
        </div>

        <!-- AI Search Panel -->
        <div class="ai-search-panel" id="aiSearchPanel">
          <textarea class="ai-search-input" id="aiSearchInput" placeholder="Ask questions like:&#10; Did we receive the signed agreement from ABC firm?&#10; What is the latest version of the Credit Agreement?&#10; Show all emails about the closing date"></textarea>
          <div class="ai-search-actions">
            <button class="btn btn-primary" id="aiSearchBtn">Search with AI</button>
          </div>
        </div>

        <!-- AI Search Loading -->
        <div class="ai-search-loading" id="aiSearchLoading" style="display: none;">
          <div class="spinner"></div>
          <span id="aiSearchLoadingText">Analyzing emails with AI...</span>
        </div>

        <!-- AI Answer Box -->
        <div class="ai-answer-box" id="aiAnswerBox" style="display: none;">
          <div class="ai-answer-header">
            <span class="ai-icon"></span>
            <span>AI Answer</span>
          </div>
          <div class="ai-answer-text" id="aiAnswerText"></div>
          <div class="ai-answer-confidence" id="aiAnswerConfidence"></div>
          <div class="ai-relevant-emails" id="aiRelevantEmails" style="display: none;">
            <h4>Relevant Emails</h4>
            <div class="email-list" id="aiEmailList"></div>
          </div>
        </div>

        <!-- Advanced Filters -->
        <div class="email-filters" id="emailFilters" style="display: none;">
          <div class="email-filter-group">
            <label>Sender Name/Email</label>
            <input type="text" class="email-filter-input" id="emailFilterSender" placeholder="e.g. john@company.com">
          </div>
          <div class="email-filter-group">
            <label>Subject Contains</label>
            <input type="text" class="email-filter-input" id="emailFilterSubject" placeholder="e.g. Agreement Draft">
          </div>
          <div class="email-filter-group">
            <label>Attachment Filename</label>
            <input type="text" class="email-filter-input" id="emailFilterAttachment" placeholder="e.g. contract.pdf">
          </div>
          <div class="email-filter-group">
            <label>Date Range</label>
            <div class="email-date-range">
              <input type="date" class="email-date-input" id="emailFilterDateFrom">
              <span>to</span>
              <input type="date" class="email-date-input" id="emailFilterDateTo">
            </div>
          </div>
          <div class="email-filter-group">
            <div class="email-filter-toggle">
              <input type="checkbox" id="emailFilterHasAttachment">
              <span>Only emails with attachments</span>
            </div>
          </div>
          <div class="email-filter-group" style="justify-content: flex-end;">
            <button class="email-clear-filters" id="emailClearFilters">Clear Filters</button>
          </div>
        </div>

        <!-- Search Results -->
        <div class="email-results" id="emailResults" style="display: none;">
          <h3 id="emailResultsTitle">Search Results</h3>
          <div class="email-list" id="emailList"></div>
        </div>

        <!-- Privacy Toggle -->
        <div class="privacy-toggle" id="emailPrivacyToggle" style="display: none;">
          <label class="toggle-label">
            <input type="checkbox" id="emailBlurToggle">
            <span>Blur sensitive info</span>
          </label>
        </div>
      </div>

      <!-- Processing -->
      <div class="processing" id="emailProcessing">
        <div class="horse-container">
          <div class="horse">
            <svg viewBox="0 0 100 62" xmlns="http://www.w3.org/2000/svg">
              <ellipse cx="50" cy="35" rx="28" ry="16"/>
              <path d="M 70 28 Q 82 18 85 8 Q 90 16 84 28 Q 78 32 70 32 Z"/>
              <ellipse cx="88" cy="8" rx="11" ry="7"/>
              <path d="M 94 2 L 97 -4 L 96 3 Z"/>
              <ellipse cx="80" cy="6" rx="2" ry="2"/>
              <path d="M 18 40 Q 8 42 5 55"/>
              <path d="M 28 45 Q 22 52 25 60"/>
              <path d="M 62 45 Q 68 52 65 60"/>
              <path d="M 72 40 Q 78 48 75 58"/>
              <path d="M 22 32 Q 10 38 2 32 Q 8 28 22 32"/>
            </svg>
          </div>
          <div class="dust">
            <div class="dust-particle"></div>
            <div class="dust-particle"></div>
            <div class="dust-particle"></div>
          </div>
        </div>
        <p class="progress-text" id="emailProgressText">Processing emails...</p>
        <div class="progress-bar">
          <div class="progress-fill" id="emailProgressFill" style="width: 0%"></div>
        </div>
      </div>

      <!-- Error State -->
      <div class="error" id="emailError">
        <svg class="error-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z"/>
        </svg>
        <h2>Error</h2>
        <p id="emailErrorText">Something went wrong</p>
        <button class="btn btn-secondary" id="emailRetryBtn">Try Again</button>
      </div>
    </div><!-- End emailTab -->

    <!-- Time Tracking Tab -->
    <div id="timetrackTab" style="display: none;">
      <div class="timetrack-setup" id="timetrackSetup">
        <h3 style="font-size: 14px; color: #888; margin-bottom: 16px;">Generate Activity Summary</h3>

        <!-- Email CSV Input -->
        <div class="input-section" id="timetrackEmailDrop">
          <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M21.75 9v.906a2.25 2.25 0 01-1.183 1.981l-6.478 3.488M2.25 9v.906a2.25 2.25 0 001.183 1.981l6.478 3.488m8.839 2.51l-4.66-2.51m0 0l-1.023-.55a2.25 2.25 0 00-2.134 0l-1.022.55m0 0l-4.661 2.51m16.5 1.615a2.25 2.25 0 01-2.25 2.25h-15a2.25 2.25 0 01-2.25-2.25V8.844a2.25 2.25 0 011.183-1.98l7.5-4.04a2.25 2.25 0 012.134 0l7.5 4.04a2.25 2.25 0 011.183 1.98V19.5z"/>
          </svg>
          <p class="input-label">Upload Email CSV</p>
          <p class="input-hint">Outlook email export</p>
          <p class="input-selected" id="timetrackEmailSelected"></p>
        </div>

        <!-- Calendar Input -->
        <div class="input-section" id="timetrackCalendarDrop" style="margin-top: 12px;">
          <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5"/>
          </svg>
          <p class="input-label">Upload Calendar (Optional)</p>
          <p class="input-hint">.ics or .csv from Outlook/Google</p>
          <p class="input-selected" id="timetrackCalendarSelected"></p>
        </div>

        <!-- Period Selection -->
        <div class="timetrack-options" style="margin-top: 16px;">
          <label style="font-size: 13px; color: #888;">
            <input type="radio" name="timetrackPeriod" value="day" checked> Today
          </label>
          <label style="font-size: 13px; color: #888; margin-left: 16px;">
            <input type="radio" name="timetrackPeriod" value="week"> This Week
          </label>
        </div>

        <div class="btn-row" style="margin-top: 16px;">
          <button class="btn btn-primary" id="timetrackGenerateBtn" disabled>Generate Summary</button>
        </div>
      </div>

      <!-- Processing -->
      <div class="processing" id="timetrackProcessing">
        <div class="horse-container">
          <div class="horse">
            <svg viewBox="0 0 100 62" xmlns="http://www.w3.org/2000/svg">
              <ellipse cx="50" cy="35" rx="28" ry="16"/>
              <path d="M 70 28 Q 82 18 85 8 Q 90 16 84 28 Q 78 32 70 32 Z"/>
              <ellipse cx="88" cy="8" rx="11" ry="7"/>
            </svg>
          </div>
        </div>
        <p class="progress-text" id="timetrackProgressText">Analyzing activity...</p>
        <div class="progress-bar">
          <div class="progress-fill" id="timetrackProgressFill" style="width: 0%"></div>
        </div>
      </div>

      <!-- Results -->
      <div class="timetrack-results" id="timetrackResults" style="display: none;">
        <h3 style="font-size: 16px; margin-bottom: 16px;">
          <span id="timetrackResultsTitle">Activity Summary</span>
        </h3>

        <!-- Summary Stats -->
        <div class="timetrack-summary-stats">
          <div class="stat-box">
            <div class="stat-value" id="ttTotalHours">0</div>
            <div class="stat-label">Active Hours</div>
          </div>
          <div class="stat-box">
            <div class="stat-value" id="ttTotalMeetings">0</div>
            <div class="stat-label">Meetings</div>
          </div>
          <div class="stat-box">
            <div class="stat-value" id="ttTotalEmails">0</div>
            <div class="stat-label">Emails</div>
          </div>
        </div>

        <!-- By Matter -->
        <h4 style="font-size: 13px; color: #888; margin: 20px 0 12px;">By Matter</h4>
        <div class="timetrack-matters" id="timetrackMatters"></div>

        <!-- Timeline -->
        <h4 style="font-size: 13px; color: #888; margin: 20px 0 12px;">Timeline</h4>
        <div class="timetrack-timeline" id="timetrackTimeline"></div>

        <div class="btn-row" style="margin-top: 20px;">
          <button class="btn btn-secondary" id="timetrackResetBtn">New Summary</button>
        </div>
      </div>

      <!-- Error State -->
      <div class="error" id="timetrackError">
        <svg class="error-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z"/>
        </svg>
        <h2>Error</h2>
        <p id="timetrackErrorText">Something went wrong</p>
        <button class="btn btn-secondary" id="timetrackRetryBtn">Try Again</button>
      </div>
    </div><!-- End timetrackTab -->

    <!-- Update Checklist Tab -->
    <div id="updatechecklistTab" style="display: none;">
      <div class="checklist-setup" id="checklistSetup">
        <h3 style="font-size: 14px; color: #888; margin-bottom: 16px;">Update Transaction Checklist</h3>
        <p class="subtitle" style="margin-bottom: 16px;">Upload your email activity CSV and checklist to auto-update document statuses</p>

        <!-- Checklist Input -->
        <div class="input-section" id="checklistDocDrop">
          <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25z"/>
          </svg>
          <p class="input-label">Upload Closing Checklist</p>
          <p class="input-hint">Word document (.docx) with transaction checklist</p>
          <div class="input-selected-wrapper">
            <p class="input-selected" id="checklistDocSelected"></p>
            <button class="clear-file-btn" id="clearChecklistDoc"></button>
          </div>
        </div>

        <!-- Email CSV Input -->
        <div class="input-section" id="checklistEmailDrop" style="margin-top: 12px;">
          <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M21.75 9v.906a2.25 2.25 0 01-1.183 1.981l-6.478 3.488M2.25 9v.906a2.25 2.25 0 001.183 1.981l6.478 3.488m8.839 2.51l-4.66-2.51m0 0l-1.023-.55a2.25 2.25 0 00-2.134 0l-1.022.55m0 0l-4.661 2.51m16.5 1.615a2.25 2.25 0 01-2.25 2.25h-15a2.25 2.25 0 01-2.25-2.25V8.844a2.25 2.25 0 011.183-1.98l7.5-4.04a2.25 2.25 0 012.134 0l7.5 4.04a2.25 2.25 0 011.183 1.98V19.5z"/>
          </svg>
          <p class="input-label">Upload Email CSV</p>
          <p class="input-hint">Outlook email export from today's activity</p>
          <div class="input-selected-wrapper">
            <p class="input-selected" id="checklistEmailSelected"></p>
            <button class="clear-file-btn" id="clearChecklistEmail"></button>
          </div>
        </div>

        <div class="btn-row" style="margin-top: 16px;">
          <button class="btn btn-primary" id="updateChecklistBtn" disabled>Update Checklist</button>
        </div>
      </div>

      <!-- Processing -->
      <div class="processing" id="checklistProcessing">
        <div class="horse-container">
          <div class="horse">
            <svg viewBox="0 0 100 62" xmlns="http://www.w3.org/2000/svg">
              <ellipse cx="50" cy="35" rx="28" ry="16"/>
              <path d="M 70 28 Q 82 18 85 8 Q 90 16 84 28 Q 78 32 70 32 Z"/>
              <ellipse cx="88" cy="8" rx="11" ry="7"/>
            </svg>
          </div>
        </div>
        <p class="progress-text" id="checklistProgressText">Analyzing emails and updating checklist...</p>
        <div class="progress-bar">
          <div class="progress-fill" id="checklistProgressFill" style="width: 0%"></div>
        </div>
      </div>

      <!-- Complete State -->
      <div class="complete" id="checklistComplete">
        <svg class="check-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        <h2>Checklist Updated</h2>
        <p id="checklistResultText">Updated 0 items based on email activity</p>
        <button class="btn btn-primary" id="downloadChecklistBtn">Download Updated Checklist</button>
        <button class="btn btn-secondary" id="checklistResetBtn">Process Another</button>
      </div>

      <!-- Error State -->
      <div class="error" id="checklistError">
        <svg class="error-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z"/>
        </svg>
        <h2>Error</h2>
        <p id="checklistErrorText">Something went wrong</p>
        <button class="btn btn-secondary" id="checklistRetryBtn">Try Again</button>
      </div>
    </div><!-- End updatechecklistTab -->

    <!-- Generate Punchlist Tab -->
    <div id="punchlistTab" style="display: none;">
      <div class="punchlist-setup" id="punchlistSetup">
        <h3 style="font-size: 14px; color: #888; margin-bottom: 16px;">Generate Daily Punchlist</h3>
        <p class="subtitle" style="margin-bottom: 16px;">Convert your closing checklist into a focused daily punchlist of open items</p>

        <!-- Checklist Input -->
        <div class="input-section" id="punchlistChecklistDrop">
          <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25z"/>
          </svg>
          <p class="input-label">Upload Closing Checklist</p>
          <p class="input-hint">Word document (.docx) with transaction checklist</p>
          <div class="input-selected-wrapper">
            <p class="input-selected" id="punchlistChecklistSelected"></p>
            <button class="clear-file-btn" id="clearPunchlistChecklist"></button>
          </div>
        </div>

        <!-- Output Options -->
        <div class="punchlist-options" style="margin-top: 16px;">
          <label style="font-size: 13px; color: #888; display: block; margin-bottom: 8px;">Include items with status:</label>
          <label style="font-size: 13px; color: #888; margin-right: 16px;">
            <input type="checkbox" name="punchlistStatus" value="pending" checked> Pending / To Be Drafted
          </label>
          <label style="font-size: 13px; color: #888; margin-right: 16px;">
            <input type="checkbox" name="punchlistStatus" value="review" checked> Under Review / With Opposing Counsel
          </label>
          <label style="font-size: 13px; color: #888;">
            <input type="checkbox" name="punchlistStatus" value="signature" checked> Awaiting Signature
          </label>
        </div>

        <div class="btn-row" style="margin-top: 16px;">
          <button class="btn btn-primary" id="generatePunchlistBtn" disabled>Generate Punchlist</button>
        </div>
      </div>

      <!-- Processing -->
      <div class="processing" id="punchlistProcessing">
        <div class="horse-container">
          <div class="horse">
            <svg viewBox="0 0 100 62" xmlns="http://www.w3.org/2000/svg">
              <ellipse cx="50" cy="35" rx="28" ry="16"/>
              <path d="M 70 28 Q 82 18 85 8 Q 90 16 84 28 Q 78 32 70 32 Z"/>
              <ellipse cx="88" cy="8" rx="11" ry="7"/>
            </svg>
          </div>
        </div>
        <p class="progress-text" id="punchlistProgressText">Generating punchlist...</p>
        <div class="progress-bar">
          <div class="progress-fill" id="punchlistProgressFill" style="width: 0%"></div>
        </div>
      </div>

      <!-- Complete State -->
      <div class="complete" id="punchlistComplete">
        <svg class="check-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        <h2>Punchlist Generated</h2>
        <p id="punchlistResultText">Created punchlist with 0 open items</p>
        <button class="btn btn-primary" id="downloadPunchlistBtn">Download Punchlist</button>
        <button class="btn btn-secondary" id="punchlistResetBtn">Process Another</button>
      </div>

      <!-- Error State -->
      <div class="error" id="punchlistError">
        <svg class="error-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z"/>
        </svg>
        <h2>Error</h2>
        <p id="punchlistErrorText">Something went wrong</p>
        <button class="btn btn-secondary" id="punchlistRetryBtn">Try Again</button>
      </div>
    </div><!-- End punchlistTab -->

      </div><!-- End content-area -->
    </div><!-- End main-layout -->

    <footer>
      <p>All processing happens locally. No data leaves your machine.</p>
    </footer>
  </div>

  <script>
    const { ipcRenderer } = require('electron');

    // ========== DISCLAIMER MODAL ==========
    const disclaimerModal = document.getElementById('disclaimerModal');
    const acceptDisclaimerBtn = document.getElementById('acceptDisclaimerBtn');
    const declineDisclaimerBtn = document.getElementById('declineDisclaimerBtn');

    // Check if user has accepted disclaimer
    const hasAcceptedDisclaimer = localStorage.getItem('emmaneigh_disclaimer_accepted');
    if (hasAcceptedDisclaimer) {
      disclaimerModal.classList.add('hidden');
    }

    acceptDisclaimerBtn.addEventListener('click', () => {
      localStorage.setItem('emmaneigh_disclaimer_accepted', 'true');
      disclaimerModal.classList.add('hidden');
    });

    declineDisclaimerBtn.addEventListener('click', async () => {
      await ipcRenderer.invoke('quit-app');
    });

    // ========== HISTORY MODAL ==========
    const historyBtn = document.getElementById('historyBtn');
    const historyModal = document.getElementById('historyModal');
    const historyClose = document.getElementById('historyClose');
    const historyList = document.getElementById('historyList');
    const historyTabs = document.querySelectorAll('.history-tab');
    const historyRecentTab = document.getElementById('historyRecentTab');
    const historyStatsTab = document.getElementById('historyStatsTab');
    const historyExportBtn = document.getElementById('historyExportBtn');
    const historyClearBtn = document.getElementById('historyClearBtn');
    const statTotalOps = document.getElementById('statTotalOps');
    const statTotalOutputs = document.getElementById('statTotalOutputs');
    const historyFeatureList = document.getElementById('historyFeatureList');

    // Feature name mapping
    const featureNames = {
      'signature_packets': 'Signature Packets',
      'execution_version': 'Execution Version',
      'sigblocks': 'Signature Blocks',
      'collate': 'Collate',
      'redline': 'Redline'
    };

    async function loadHistory() {
      const history = await ipcRenderer.invoke('get-history', 20);

      if (!history || history.length === 0) {
        historyList.innerHTML = '<div class="history-empty">No activity recorded yet</div>';
        return;
      }

      historyList.innerHTML = history.map(item => {
        const date = new Date(item.timestamp);
        const dateStr = date.toLocaleDateString();
        const timeStr = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const featureName = featureNames[item.feature] || item.feature;

        return `
          <div class="history-item">
            <div class="history-item-info">
              <div class="history-item-feature">${featureName}</div>
              <div class="history-item-meta">${dateStr} at ${timeStr}</div>
            </div>
            <div class="history-item-stats">
              ${item.output_count || 0} created
            </div>
          </div>
        `;
      }).join('');
    }

    async function loadStats() {
      const stats = await ipcRenderer.invoke('get-usage-stats');

      statTotalOps.textContent = stats.total_operations || 0;
      statTotalOutputs.textContent = stats.total_outputs || 0;

      if (stats.by_feature && Object.keys(stats.by_feature).length > 0) {
        historyFeatureList.innerHTML = Object.entries(stats.by_feature).map(([feature, data]) => {
          const featureName = featureNames[feature] || feature;
          return `
            <div class="history-item">
              <div class="history-item-info">
                <div class="history-item-feature">${featureName}</div>
              </div>
              <div class="history-item-stats">
                ${data.count} uses, ${data.outputs || 0} outputs
              </div>
            </div>
          `;
        }).join('');
      } else {
        historyFeatureList.innerHTML = '<div class="history-empty">No statistics yet</div>';
      }
    }

    historyBtn.addEventListener('click', async () => {
      historyModal.classList.add('visible');
      await loadHistory();
      await loadStats();
    });

    historyClose.addEventListener('click', () => {
      historyModal.classList.remove('visible');
    });

    historyModal.addEventListener('click', (e) => {
      if (e.target === historyModal) {
        historyModal.classList.remove('visible');
      }
    });

    historyTabs.forEach(tab => {
      tab.addEventListener('click', () => {
        historyTabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');

        const tabName = tab.dataset.historyTab;
        historyRecentTab.style.display = tabName === 'recent' ? 'block' : 'none';
        historyStatsTab.style.display = tabName === 'stats' ? 'block' : 'none';
      });
    });

    historyExportBtn.addEventListener('click', async () => {
      const result = await ipcRenderer.invoke('export-history-csv');
      if (result) {
        alert('History exported to: ' + result);
      }
    });

    historyClearBtn.addEventListener('click', async () => {
      if (confirm('Are you sure you want to clear all history? This cannot be undone.')) {
        await ipcRenderer.invoke('clear-history');
        await loadHistory();
        await loadStats();
      }
    });

    // ========== SETTINGS MODAL ==========
    const settingsBtn = document.getElementById('settingsBtn');
    const settingsModal = document.getElementById('settingsModal');
    const settingsClose = document.getElementById('settingsClose');
    const apiKeyInput = document.getElementById('apiKeyInput');
    const apiKeyStatus = document.getElementById('apiKeyStatus');
    const saveApiKeyBtn = document.getElementById('saveApiKeyBtn');
    const testApiKeyBtn = document.getElementById('testApiKeyBtn');
    const deleteApiKeyBtn = document.getElementById('deleteApiKeyBtn');
    const anthropicLink = document.getElementById('anthropicLink');

    // Check if API key exists on startup
    async function checkApiKeyStatus() {
      const result = await ipcRenderer.invoke('get-api-key');
      if (result.hasKey) {
        apiKeyStatus.innerHTML = '<span style="color: #22c55e;"> API key configured</span>';
        apiKeyStatus.className = 'api-key-status connected';
        deleteApiKeyBtn.style.display = 'inline-block';
        apiKeyInput.placeholder = '';
      } else {
        apiKeyStatus.innerHTML = '<span>No API key configured</span>';
        apiKeyStatus.className = 'api-key-status';
        deleteApiKeyBtn.style.display = 'none';
        apiKeyInput.placeholder = 'sk-ant-api...';
      }
    }

    settingsBtn.addEventListener('click', async () => {
      settingsModal.classList.add('visible');
      await checkApiKeyStatus();
    });

    settingsClose.addEventListener('click', () => {
      settingsModal.classList.remove('visible');
    });

    settingsModal.addEventListener('click', (e) => {
      if (e.target === settingsModal) {
        settingsModal.classList.remove('visible');
      }
    });

    saveApiKeyBtn.addEventListener('click', async () => {
      const key = apiKeyInput.value.trim();
      if (!key) {
        apiKeyStatus.innerHTML = '<span style="color: #ef4444;">Please enter an API key</span>';
        return;
      }

      saveApiKeyBtn.disabled = true;
      saveApiKeyBtn.textContent = 'Saving...';

      const result = await ipcRenderer.invoke('set-api-key', key);

      if (result.success) {
        apiKeyInput.value = '';
        await checkApiKeyStatus();
        apiKeyStatus.innerHTML = '<span style="color: #22c55e;"> API key saved successfully</span>';
      } else {
        apiKeyStatus.innerHTML = `<span style="color: #ef4444;">${result.error || 'Failed to save key'}</span>`;
      }

      saveApiKeyBtn.disabled = false;
      saveApiKeyBtn.textContent = 'Save Key';
    });

    testApiKeyBtn.addEventListener('click', async () => {
      let keyToTest = apiKeyInput.value.trim();

      // If no key in input, test the stored key
      if (!keyToTest) {
        keyToTest = await ipcRenderer.invoke('get-api-key-value');
      }

      if (!keyToTest) {
        apiKeyStatus.innerHTML = '<span style="color: #ef4444;">No API key to test</span>';
        return;
      }

      testApiKeyBtn.disabled = true;
      testApiKeyBtn.textContent = 'Testing...';
      apiKeyStatus.innerHTML = '<span>Testing connection...</span>';

      const result = await ipcRenderer.invoke('test-api-key', keyToTest);

      if (result.success) {
        apiKeyStatus.innerHTML = '<span style="color: #22c55e;"> ' + result.message + '</span>';
        apiKeyStatus.className = 'api-key-status connected';
      } else {
        apiKeyStatus.innerHTML = '<span style="color: #ef4444;">' + result.error + '</span>';
        apiKeyStatus.className = 'api-key-status error';
      }

      testApiKeyBtn.disabled = false;
      testApiKeyBtn.textContent = 'Test Connection';
    });

    deleteApiKeyBtn.addEventListener('click', async () => {
      if (confirm('Are you sure you want to delete your API key?')) {
        await ipcRenderer.invoke('delete-api-key');
        await checkApiKeyStatus();
        apiKeyStatus.innerHTML = '<span>API key deleted</span>';
      }
    });

    anthropicLink.addEventListener('click', (e) => {
      e.preventDefault();
      require('electron').shell.openExternal('https://console.anthropic.com/');
    });

    // ========== UPDATE CHECK ==========
    const checkUpdatesBtn = document.getElementById('checkUpdatesBtn');
    const updateCheckStatus = document.getElementById('updateCheckStatus');
    const currentVersionEl = document.getElementById('currentVersion');

    // Load current version on startup
    ipcRenderer.invoke('get-app-version').then(version => {
      currentVersionEl.textContent = version;
    }).catch(() => {
      currentVersionEl.textContent = 'Unknown';
    });

    // Check for updates button
    checkUpdatesBtn.addEventListener('click', async () => {
      checkUpdatesBtn.disabled = true;
      updateCheckStatus.textContent = 'Checking...';
      updateCheckStatus.className = 'update-check-status';

      try {
        const result = await ipcRenderer.invoke('check-for-updates');
        if (!result.success) {
          updateCheckStatus.textContent = result.error || 'Check failed';
          updateCheckStatus.className = 'update-check-status error';
        }
        // If successful, wait for update-available or update-not-available events
      } catch (e) {
        updateCheckStatus.textContent = 'Error: ' + e.message;
        updateCheckStatus.className = 'update-check-status error';
      }

      checkUpdatesBtn.disabled = false;
    });

    // Handle update-not-available event
    ipcRenderer.on('update-not-available', () => {
      if (updateCheckStatus) {
        updateCheckStatus.textContent = 'You are up to date!';
        updateCheckStatus.className = 'update-check-status success';
      }
    });

    // Helper function to log usage (call this after each feature completes)
    async function logUsage(feature, action, inputCount, outputCount, durationMs) {
      const currentUser = localStorage.getItem('emmaneigh_user');
      let userName = 'Guest';
      try {
        if (currentUser) {
          const user = JSON.parse(currentUser);
          userName = user.name || 'Guest';
        }
      } catch (e) {}

      await ipcRenderer.invoke('log-usage', {
        user_name: userName,
        feature: feature,
        action: action,
        input_count: inputCount,
        output_count: outputCount,
        duration_ms: durationMs
      });
    }

    // ========== USER INFO / LOGIN ==========
    const userInfo = document.getElementById('userInfo');
    const userName = document.getElementById('userName');
    const loginModal = document.getElementById('loginModal');

    // Current user state
    let currentUser = null;  // { id, username, displayName, isGuest }

    // Tab switching
    const loginTabs = document.querySelectorAll('.login-tab');
    loginTabs.forEach(tab => {
      tab.addEventListener('click', () => {
        loginTabs.forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.login-form').forEach(f => f.classList.add('hidden'));
        tab.classList.add('active');
        const formId = tab.dataset.tab + 'Form';
        document.getElementById(formId).classList.remove('hidden');
        // Clear error messages
        document.getElementById('loginError').textContent = '';
        document.getElementById('createError').textContent = '';
      });
    });

    // Login form handler
    document.getElementById('loginBtn').addEventListener('click', async () => {
      const username = document.getElementById('loginUsername').value.trim();
      const password = document.getElementById('loginPassword').value;
      const errorEl = document.getElementById('loginError');

      if (!username || !password) {
        errorEl.textContent = 'Please enter username and password';
        return;
      }

      try {
        const result = await ipcRenderer.invoke('login-user', { username, password });

        if (result.success) {
          currentUser = { ...result.user, isGuest: false };
          localStorage.setItem('emmaneigh_session', JSON.stringify({ userId: result.user.id }));
          userName.textContent = result.user.displayName || result.user.username;
          loginModal.classList.add('hidden');
          // Load user's API key
          loadUserApiKey();
        } else {
          errorEl.textContent = result.error || 'Login failed';
        }
      } catch (e) {
        errorEl.textContent = 'Login error: ' + e.message;
      }
    });

    // Allow Enter key to submit login
    document.getElementById('loginPassword').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') document.getElementById('loginBtn').click();
    });

    // Create account form handler
    document.getElementById('createBtn').addEventListener('click', async () => {
      const username = document.getElementById('createUsername').value.trim();
      const email = document.getElementById('createEmail').value.trim();
      const displayName = document.getElementById('createDisplayName').value.trim();
      const password = document.getElementById('createPassword').value;
      const confirm = document.getElementById('createPasswordConfirm').value;
      const securityQuestion = document.getElementById('createSecurityQuestion').value;
      const securityAnswer = document.getElementById('createSecurityAnswer').value.trim();
      const errorEl = document.getElementById('createError');

      if (!username) {
        errorEl.textContent = 'Username is required';
        return;
      }

      if (password.length < 4) {
        errorEl.textContent = 'Password must be at least 4 characters';
        return;
      }

      if (password !== confirm) {
        errorEl.textContent = 'Passwords do not match';
        return;
      }

      try {
        const result = await ipcRenderer.invoke('create-user', {
          username, password, displayName, email, securityQuestion, securityAnswer
        });

        if (result.success) {
          // Auto-login after creation
          const loginResult = await ipcRenderer.invoke('login-user', { username, password });
          if (loginResult.success) {
            currentUser = { ...loginResult.user, isGuest: false };
            localStorage.setItem('emmaneigh_session', JSON.stringify({ userId: loginResult.user.id }));
            userName.textContent = loginResult.user.displayName || loginResult.user.username;
            loginModal.classList.add('hidden');
          }
        } else {
          errorEl.textContent = result.error || 'Account creation failed';
        }
      } catch (e) {
        errorEl.textContent = 'Error: ' + e.message;
      }
    });

    // Allow Enter key to submit create
    document.getElementById('createPasswordConfirm').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') document.getElementById('createBtn').click();
    });

    // Guest mode handler
    document.getElementById('guestBtn').addEventListener('click', () => {
      const name = document.getElementById('guestName').value.trim() || 'Guest';
      currentUser = { id: null, username: null, displayName: name, isGuest: true };
      userName.textContent = name;
      localStorage.removeItem('emmaneigh_session');  // Clear any stored session
      loginModal.classList.add('hidden');
    });

    // Load user's API key after login
    async function loadUserApiKey() {
      if (currentUser && !currentUser.isGuest && currentUser.id) {
        try {
          const result = await ipcRenderer.invoke('get-user-api-key', { userId: currentUser.id });
          if (result.success && result.apiKey) {
            // API key is available - update status display
            const apiKeyStatus = document.getElementById('apiKeyStatus');
            if (apiKeyStatus) {
              apiKeyStatus.innerHTML = '<span style="color: #4CAF50;">API key configured</span>';
            }
          }
        } catch (e) {
          console.error('Failed to load user API key:', e);
        }
      }
    }

    // Check for stored session on load
    async function checkStoredSession() {
      const session = localStorage.getItem('emmaneigh_session');
      if (session) {
        try {
          const { userId } = JSON.parse(session);
          const result = await ipcRenderer.invoke('get-user-by-id', { userId });
          if (result.success) {
            currentUser = { ...result.user, isGuest: false };
            userName.textContent = result.user.displayName || result.user.username;
            loginModal.classList.add('hidden');
            loadUserApiKey();
            return;
          }
        } catch (e) {
          console.error('Session restore failed:', e);
        }
      }
      // No valid session - show login modal
      userName.textContent = 'Guest';
    }

    // Initialize session check
    checkStoredSession();

    // Click on user info to logout/switch user
    userInfo.addEventListener('click', () => {
      // Clear session and show login modal
      localStorage.removeItem('emmaneigh_session');
      currentUser = null;
      loginModal.classList.remove('hidden');
      // Reset forms
      resetLoginForms();
    });

    // Close button handler
    document.getElementById('loginCloseBtn').addEventListener('click', () => {
      // Close modal and continue as Guest
      currentUser = { id: null, username: null, displayName: 'Guest', isGuest: true };
      userName.textContent = 'Guest';
      loginModal.classList.add('hidden');
    });

    // Forgot password link handler
    document.getElementById('forgotPasswordLink').addEventListener('click', (e) => {
      e.preventDefault();
      // Hide all forms and show forgot password form
      document.querySelectorAll('.login-form').forEach(f => f.classList.add('hidden'));
      document.getElementById('forgotForm').classList.remove('hidden');
      // Hide tabs
      document.querySelector('.login-tabs').style.display = 'none';
      // Reset forgot form state
      document.getElementById('forgotUsername').value = '';
      document.getElementById('forgotQuestionDisplay').textContent = '';
      document.getElementById('forgotSecurityAnswer').style.display = 'none';
      document.getElementById('forgotNewPassword').style.display = 'none';
      document.getElementById('forgotNewPasswordConfirm').style.display = 'none';
      document.getElementById('resetPasswordBtn').style.display = 'none';
      document.getElementById('forgotError').textContent = '';
    });

    // Back to login link handler
    document.getElementById('backToLoginLink').addEventListener('click', (e) => {
      e.preventDefault();
      // Show tabs and reset to login form
      document.querySelector('.login-tabs').style.display = 'flex';
      document.querySelectorAll('.login-form').forEach(f => f.classList.add('hidden'));
      document.getElementById('loginForm').classList.remove('hidden');
      loginTabs.forEach(t => t.classList.remove('active'));
      loginTabs[0].classList.add('active');
    });

    // Look up security question handler
    document.getElementById('lookupQuestionBtn').addEventListener('click', async () => {
      const username = document.getElementById('forgotUsername').value.trim();
      const errorEl = document.getElementById('forgotError');

      if (!username) {
        errorEl.textContent = 'Please enter your username';
        return;
      }

      try {
        const result = await ipcRenderer.invoke('get-security-question', { username });

        if (result.success) {
          document.getElementById('forgotQuestionDisplay').textContent = result.question;
          document.getElementById('forgotSecurityAnswer').style.display = 'block';
          document.getElementById('forgotNewPassword').style.display = 'block';
          document.getElementById('forgotNewPasswordConfirm').style.display = 'block';
          document.getElementById('resetPasswordBtn').style.display = 'block';
          document.getElementById('lookupQuestionBtn').style.display = 'none';
          errorEl.textContent = '';
        } else {
          errorEl.textContent = result.error || 'Could not find security question';
        }
      } catch (e) {
        errorEl.textContent = 'Error: ' + e.message;
      }
    });

    // Reset password handler
    document.getElementById('resetPasswordBtn').addEventListener('click', async () => {
      const username = document.getElementById('forgotUsername').value.trim();
      const securityAnswer = document.getElementById('forgotSecurityAnswer').value.trim();
      const newPassword = document.getElementById('forgotNewPassword').value;
      const confirmPassword = document.getElementById('forgotNewPasswordConfirm').value;
      const errorEl = document.getElementById('forgotError');

      if (!securityAnswer) {
        errorEl.textContent = 'Please enter your security answer';
        return;
      }

      if (newPassword.length < 4) {
        errorEl.textContent = 'Password must be at least 4 characters';
        return;
      }

      if (newPassword !== confirmPassword) {
        errorEl.textContent = 'Passwords do not match';
        return;
      }

      try {
        const result = await ipcRenderer.invoke('reset-password', { username, securityAnswer, newPassword });

        if (result.success) {
          alert('Password reset successful! Please login with your new password.');
          // Go back to login form
          document.querySelector('.login-tabs').style.display = 'flex';
          document.querySelectorAll('.login-form').forEach(f => f.classList.add('hidden'));
          document.getElementById('loginForm').classList.remove('hidden');
          loginTabs.forEach(t => t.classList.remove('active'));
          loginTabs[0].classList.add('active');
          document.getElementById('lookupQuestionBtn').style.display = 'block';
        } else {
          errorEl.textContent = result.error || 'Password reset failed';
        }
      } catch (e) {
        errorEl.textContent = 'Error: ' + e.message;
      }
    });

    // Helper function to reset login forms
    function resetLoginForms() {
      document.getElementById('loginUsername').value = '';
      document.getElementById('loginPassword').value = '';
      document.getElementById('createUsername').value = '';
      document.getElementById('createEmail').value = '';
      document.getElementById('createDisplayName').value = '';
      document.getElementById('createPassword').value = '';
      document.getElementById('createPasswordConfirm').value = '';
      document.getElementById('createSecurityQuestion').value = '';
      document.getElementById('createSecurityAnswer').value = '';
      document.getElementById('guestName').value = '';
      document.getElementById('loginError').textContent = '';
      document.getElementById('createError').textContent = '';
      document.getElementById('forgotError').textContent = '';
      // Reset to login tab
      document.querySelector('.login-tabs').style.display = 'flex';
      loginTabs.forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.login-form').forEach(f => f.classList.add('hidden'));
      loginTabs[0].classList.add('active');
      document.getElementById('loginForm').classList.remove('hidden');
      // Reset forgot password state
      document.getElementById('lookupQuestionBtn').style.display = 'block';
      document.getElementById('forgotSecurityAnswer').style.display = 'none';
      document.getElementById('forgotNewPassword').style.display = 'none';
      document.getElementById('forgotNewPasswordConfirm').style.display = 'none';
      document.getElementById('resetPasswordBtn').style.display = 'none';
    }

    // ========== AUTO-UPDATE ==========
    const updateBanner = document.getElementById('updateBanner');
    const updateMessage = document.getElementById('updateMessage');
    const updateBtn = document.getElementById('updateBtn');
    const dismissUpdateBtn = document.getElementById('dismissUpdateBtn');
    const updateProgressContainer = document.getElementById('updateProgressContainer');
    const updateProgressFill = document.getElementById('updateProgressFill');
    const updateProgressText = document.getElementById('updateProgressText');
    let updateDownloaded = false;

    ipcRenderer.on('update-available', (event, info) => {
      updateMessage.textContent = `Version ${info.version} is available!`;
      updateBanner.classList.remove('hidden');
      updateBtn.textContent = 'Download';
      updateBtn.disabled = false;
    });

    ipcRenderer.on('update-progress', (event, progress) => {
      updateProgressContainer.classList.add('visible');
      updateProgressFill.style.width = progress.percent + '%';
      const mbTransferred = (progress.transferred / 1024 / 1024).toFixed(1);
      const mbTotal = (progress.total / 1024 / 1024).toFixed(1);
      const speed = (progress.bytesPerSecond / 1024 / 1024).toFixed(1);
      updateProgressText.textContent = `${mbTransferred}MB / ${mbTotal}MB (${speed} MB/s)`;
      updateBtn.textContent = `${progress.percent}%`;
      updateBtn.disabled = true;
    });

    ipcRenderer.on('update-downloaded', () => {
      updateDownloaded = true;
      updateProgressContainer.classList.remove('visible');
      updateMessage.textContent = 'Update ready! Restart to install.';
      updateBtn.textContent = 'Restart Now';
      updateBtn.disabled = false;
      dismissUpdateBtn.style.display = 'none';
    });

    ipcRenderer.on('update-error', (event, message) => {
      updateProgressContainer.classList.remove('visible');
      updateMessage.textContent = 'Update failed: ' + message;
      updateBtn.textContent = 'Retry';
      updateBtn.disabled = false;
    });

    updateBtn.addEventListener('click', async () => {
      if (updateDownloaded) {
        await ipcRenderer.invoke('install-update');
      } else {
        updateBtn.textContent = 'Starting...';
        updateBtn.disabled = true;
        await ipcRenderer.invoke('download-update');
      }
    });

    dismissUpdateBtn.addEventListener('click', () => {
      updateBanner.classList.add('hidden');
    });

    // ========== NAVIGATION SIDEBAR ==========
    const navItems = document.querySelectorAll('.nav-item');
    const navCategoryHeaders = document.querySelectorAll('.nav-category-header');
    const packetsTab = document.getElementById('packetsTab');
    const executionTab = document.getElementById('executionTab');
    const sigblocksTab = document.getElementById('sigblocksTab');
    const collateTab = document.getElementById('collateTab');
    const emailTab = document.getElementById('emailTab');
    const timetrackTab = document.getElementById('timetrackTab');
    const updatechecklistTab = document.getElementById('updatechecklistTab');
    const punchlistTab = document.getElementById('punchlistTab');

    // Category accordion toggle
    navCategoryHeaders.forEach(header => {
      header.addEventListener('click', () => {
        const category = header.parentElement;
        category.classList.toggle('expanded');
      });
    });

    // Tab switching with nav-items
    function switchTab(tabName) {
      // Update active state on all nav-items
      navItems.forEach(item => item.classList.remove('active'));
      const activeItem = document.querySelector(`.nav-item[data-tab="${tabName}"]`);
      if (activeItem) activeItem.classList.add('active');

      // Show/hide tab content
      packetsTab.style.display = tabName === 'packets' ? 'block' : 'none';
      executionTab.style.display = tabName === 'execution' ? 'block' : 'none';
      sigblocksTab.style.display = tabName === 'sigblocks' ? 'block' : 'none';
      collateTab.style.display = tabName === 'collate' ? 'block' : 'none';
      emailTab.style.display = tabName === 'email' ? 'block' : 'none';
      timetrackTab.style.display = tabName === 'timetrack' ? 'block' : 'none';
      updatechecklistTab.style.display = tabName === 'updatechecklist' ? 'block' : 'none';
      punchlistTab.style.display = tabName === 'punchlist' ? 'block' : 'none';
    }

    navItems.forEach(item => {
      item.addEventListener('click', () => {
        // Skip disabled items
        if (item.classList.contains('disabled')) return;
        switchTab(item.dataset.tab);
      });
    });

    // ========== SIGNATURE PACKETS TAB ==========
    const dropZone = document.getElementById('dropZone');
    const processing = document.getElementById('processing');
    const complete = document.getElementById('complete');
    const error = document.getElementById('error');
    const progressText = document.getElementById('progressText');
    const progressFill = document.getElementById('progressFill');
    const resultText = document.getElementById('resultText');
    const errorText = document.getElementById('errorText');
    const downloadBtn = document.getElementById('downloadBtn');
    const resetBtn = document.getElementById('resetBtn');
    const retryBtn = document.getElementById('retryBtn');
    const packetsFileCount = document.getElementById('packetsFileCount');

    let currentResult = null;
    let currentZipPath = null;
    let packetsPaths = []; // Can be folder path or array of file paths

    function showState(state) {
      dropZone.style.display = state === 'idle' ? 'flex' : 'none';
      processing.classList.toggle('visible', state === 'processing');
      complete.classList.toggle('visible', state === 'complete');
      error.classList.toggle('visible', state === 'error');
    }

    function updatePacketsFileCount() {
      if (packetsPaths.length === 0) {
        packetsFileCount.textContent = '';
      } else if (typeof packetsPaths === 'string') {
        packetsFileCount.textContent = 'Folder selected';
      } else {
        packetsFileCount.textContent = `${packetsPaths.length} file${packetsPaths.length !== 1 ? 's' : ''} selected`;
      }
    }

    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('active');
    });

    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('active');
    });

    dropZone.addEventListener('drop', async (e) => {
      e.preventDefault();
      dropZone.classList.remove('active');
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        // Check if it's a folder or files
        const firstFile = files[0];
        // If multiple files or single PDF, treat as file list
        if (files.length > 1 || firstFile.name.toLowerCase().endsWith('.pdf')) {
          packetsPaths = Array.from(files)
            .filter(f => f.name.toLowerCase().endsWith('.pdf'))
            .map(f => f.path);
          if (packetsPaths.length > 0) {
            updatePacketsFileCount();
            await processPackets({ files: packetsPaths });
          }
        } else {
          // Single item that's not a PDF - assume folder
          packetsPaths = firstFile.path;
          updatePacketsFileCount();
          await processPackets({ folder: firstFile.path });
        }
      }
    });

    dropZone.addEventListener('click', async () => {
      // Show choice dialog - folder or files
      const choice = await showPacketsChoiceDialog();
      if (choice === 'folder') {
        const folderPath = await ipcRenderer.invoke('select-folder');
        if (folderPath) {
          packetsPaths = folderPath;
          updatePacketsFileCount();
          await processPackets({ folder: folderPath });
        }
      } else if (choice === 'files') {
        const filePaths = await ipcRenderer.invoke('select-pdfs-multiple');
        if (filePaths && filePaths.length > 0) {
          packetsPaths = filePaths;
          updatePacketsFileCount();
          await processPackets({ files: filePaths });
        }
      }
    });

    function showPacketsChoiceDialog() {
      return new Promise((resolve) => {
        // Simple approach: use confirm dialog
        const useFolder = confirm('Click OK to select a folder, or Cancel to select individual PDF files.');
        resolve(useFolder ? 'folder' : 'files');
      });
    }

    async function processPackets(input) {
      showState('processing');
      progressFill.style.width = '0%';
      progressText.textContent = 'Starting...';

      try {
        const startTime = Date.now();
        const result = await ipcRenderer.invoke('process-folder', input);
        currentResult = result;
        progressText.textContent = 'Creating ZIP file...';
        currentZipPath = await ipcRenderer.invoke('create-zip', result.outputPath);
        resultText.textContent = `Created ${result.packetsCreated} signature packet${result.packetsCreated !== 1 ? 's' : ''}`;

        // Log usage
        await logUsage('signature_packets', 'process', packetsPaths.length || 1, result.packetsCreated || 0, Date.now() - startTime);

        showState('complete');
      } catch (err) {
        errorText.textContent = err.message;
        showState('error');
      }
    }

    // Keep old function for backwards compatibility
    async function processFolder(folderPath) {
      await processPackets({ folder: folderPath });
    }

    ipcRenderer.on('progress', (event, data) => {
      // Route to correct progress bar based on active tab
      const activeTab = document.querySelector('.tab.active').dataset.tab;
      if (activeTab === 'packets') {
        progressText.textContent = data.message;
        progressFill.style.width = data.percent + '%';
      } else {
        execProgressText.textContent = data.message;
        execProgressFill.style.width = data.percent + '%';
      }
    });

    downloadBtn.addEventListener('click', async () => {
      if (currentZipPath) await ipcRenderer.invoke('save-zip', currentZipPath, 'EmmaNeigh-Signature-Packets.zip');
    });

    resetBtn.addEventListener('click', () => {
      currentResult = null;
      currentZipPath = null;
      packetsPaths = [];
      packetsFileCount.textContent = '';
      showState('idle');
    });

    retryBtn.addEventListener('click', () => {
      currentResult = null;
      currentZipPath = null;
      packetsPaths = [];
      packetsFileCount.textContent = '';
      showState('idle');
    });

    // ========== EXECUTION VERSION TAB ==========
    const originalsInput = document.getElementById('originalsInput');
    const signedInput = document.getElementById('signedInput');
    const originalsSelected = document.getElementById('originalsSelected');
    const signedSelected = document.getElementById('signedSelected');
    const processExecBtn = document.getElementById('processExecBtn');
    const execInputs = document.getElementById('execInputs');
    const execProcessing = document.getElementById('execProcessing');
    const execComplete = document.getElementById('execComplete');
    const execError = document.getElementById('execError');
    const execProgressText = document.getElementById('execProgressText');
    const execProgressFill = document.getElementById('execProgressFill');
    const execResultText = document.getElementById('execResultText');
    const execResultSummary = document.getElementById('execResultSummary');
    const execErrorText = document.getElementById('execErrorText');
    const execDownloadBtn = document.getElementById('execDownloadBtn');
    const execResetBtn = document.getElementById('execResetBtn');
    const execRetryBtn = document.getElementById('execRetryBtn');

    let originalsPath = null; // Can be folder path (string) or array of file paths
    let signedPath = null;
    let execResult = null;
    let execZipPath = null;

    function showExecState(state) {
      execInputs.style.display = state === 'idle' ? 'flex' : 'none';
      execProcessing.classList.toggle('visible', state === 'processing');
      execComplete.classList.toggle('visible', state === 'complete');
      execError.classList.toggle('visible', state === 'error');
    }

    function updateExecButton() {
      const hasOriginals = originalsPath && (typeof originalsPath === 'string' || originalsPath.length > 0);
      processExecBtn.disabled = !(hasOriginals && signedPath);
    }

    function truncatePath(p, maxLen = 40) {
      if (!p || p.length <= maxLen) return p;
      const name = p.split(/[/\\]/).pop();
      return '...' + p.slice(-(maxLen - 3));
    }

    function updateOriginalsDisplay() {
      if (!originalsPath) {
        originalsSelected.textContent = '';
        originalsInput.classList.remove('selected');
      } else if (typeof originalsPath === 'string') {
        originalsSelected.textContent = truncatePath(originalsPath);
        originalsInput.classList.add('selected');
      } else {
        originalsSelected.textContent = `${originalsPath.length} file${originalsPath.length !== 1 ? 's' : ''} selected`;
        originalsInput.classList.add('selected');
      }
    }

    // Originals folder/files selection
    originalsInput.addEventListener('click', async () => {
      // Show choice dialog
      const useFolder = confirm('Click OK to select a folder, or Cancel to select individual PDF files.');
      if (useFolder) {
        const path = await ipcRenderer.invoke('select-folder');
        if (path) {
          originalsPath = path;
          updateOriginalsDisplay();
          updateExecButton();
        }
      } else {
        const paths = await ipcRenderer.invoke('select-pdfs-multiple');
        if (paths && paths.length > 0) {
          originalsPath = paths;
          updateOriginalsDisplay();
          updateExecButton();
        }
      }
    });

    originalsInput.addEventListener('dragover', (e) => {
      e.preventDefault();
      originalsInput.classList.add('active');
    });

    originalsInput.addEventListener('dragleave', () => {
      originalsInput.classList.remove('active');
    });

    originalsInput.addEventListener('drop', (e) => {
      e.preventDefault();
      originalsInput.classList.remove('active');
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        // Check if multiple files or single PDF
        if (files.length > 1 || files[0].name.toLowerCase().endsWith('.pdf')) {
          // Treat as file list
          originalsPath = Array.from(files)
            .filter(f => f.name.toLowerCase().endsWith('.pdf'))
            .map(f => f.path);
          if (originalsPath.length === 0) {
            // If no PDFs found, maybe it was a folder
            originalsPath = files[0].path;
          }
        } else {
          // Single item that's not a PDF - assume folder
          originalsPath = files[0].path;
        }
        updateOriginalsDisplay();
        updateExecButton();
      }
    });

    // Signed PDF selection
    signedInput.addEventListener('click', async () => {
      const path = await ipcRenderer.invoke('select-pdf');
      if (path) {
        signedPath = path;
        signedSelected.textContent = truncatePath(path);
        signedInput.classList.add('selected');
        updateExecButton();
      }
    });

    signedInput.addEventListener('dragover', (e) => {
      e.preventDefault();
      signedInput.classList.add('active');
    });

    signedInput.addEventListener('dragleave', () => {
      signedInput.classList.remove('active');
    });

    signedInput.addEventListener('drop', (e) => {
      e.preventDefault();
      signedInput.classList.remove('active');
      const files = e.dataTransfer.files;
      if (files.length > 0 && files[0].name.toLowerCase().endsWith('.pdf')) {
        signedPath = files[0].path;
        signedSelected.textContent = truncatePath(signedPath);
        signedInput.classList.add('selected');
        updateExecButton();
      }
    });

    // Process execution version
    processExecBtn.addEventListener('click', async () => {
      const hasOriginals = originalsPath && (typeof originalsPath === 'string' || originalsPath.length > 0);
      if (!hasOriginals || !signedPath) return;

      showExecState('processing');
      execProgressFill.style.width = '0%';
      execProgressText.textContent = 'Starting...';

      try {
        const startTime = Date.now();
        // Pass originals as object with folder or files key
        const originalsInput = typeof originalsPath === 'string'
          ? { folder: originalsPath }
          : { files: originalsPath };
        const result = await ipcRenderer.invoke('process-execution-version', originalsInput, signedPath);
        execResult = result;

        execProgressText.textContent = 'Creating ZIP file...';
        execZipPath = await ipcRenderer.invoke('create-zip', result.outputPath);

        execResultText.textContent = `Created ${result.executedCount} executed document${result.executedCount !== 1 ? 's' : ''}`;

        let summary = `Matched ${result.matchedPages} of ${result.totalSignedPages} signed pages`;
        if (result.unmatchedAgreements > 0) {
          summary += `  ${result.unmatchedAgreements} unmatched agreement${result.unmatchedAgreements !== 1 ? 's' : ''}`;
        }
        if (result.unmatchedPages > 0) {
          summary += `  ${result.unmatchedPages} unmatched page${result.unmatchedPages !== 1 ? 's' : ''}`;
        }
        execResultSummary.textContent = summary;

        // Log usage
        const inputCount = typeof originalsPath === 'string' ? 1 : originalsPath.length;
        await logUsage('execution_version', 'process', inputCount, result.executedCount || 0, Date.now() - startTime);

        showExecState('complete');
      } catch (err) {
        execErrorText.textContent = err.message;
        showExecState('error');
      }
    });

    execDownloadBtn.addEventListener('click', async () => {
      if (execZipPath) await ipcRenderer.invoke('save-zip', execZipPath, 'EmmaNeigh-Execution-Versions.zip');
    });

    function resetExecState() {
      originalsPath = null;
      signedPath = null;
      execResult = null;
      execZipPath = null;
      originalsSelected.textContent = '';
      signedSelected.textContent = '';
      originalsInput.classList.remove('selected');
      signedInput.classList.remove('selected');
      updateOriginalsDisplay();
      updateExecButton();
      showExecState('idle');
    }

    execResetBtn.addEventListener('click', resetExecState);
    execRetryBtn.addEventListener('click', resetExecState);

    // ========== SIGNATURE BLOCKS TAB ==========
    const checklistInput = document.getElementById('checklistInput');
    const checklistSelected = document.getElementById('checklistSelected');
    const checklistHeader = document.getElementById('checklistHeader');
    const incumbencyInput = document.getElementById('incumbencyInput');
    const incumbencySelected = document.getElementById('incumbencySelected');
    const incumbencyHeader = document.getElementById('incumbencyHeader');
    const mappingStep = document.getElementById('mappingStep');
    const entityMapping = document.getElementById('entityMapping');
    const documentsStep = document.getElementById('documentsStep');
    const documentsInput = document.getElementById('documentsInput');
    const documentsSelected = document.getElementById('documentsSelected');
    const documentsHeader = document.getElementById('documentsHeader');
    const generateSigblocksBtn = document.getElementById('generateSigblocksBtn');
    const sigblocksInputs = document.getElementById('sigblocksInputs');
    const sigblocksProcessing = document.getElementById('sigblocksProcessing');
    const sigblocksComplete = document.getElementById('sigblocksComplete');
    const sigblocksError = document.getElementById('sigblocksError');
    const sigblocksProgressText = document.getElementById('sigblocksProgressText');
    const sigblocksProgressFill = document.getElementById('sigblocksProgressFill');
    const sigblocksResultText = document.getElementById('sigblocksResultText');
    const sigblocksResults = document.getElementById('sigblocksResults');
    const sigblocksErrorText = document.getElementById('sigblocksErrorText');
    const sigblocksDownloadBtn = document.getElementById('sigblocksDownloadBtn');
    const sigblocksToPacketsBtn = document.getElementById('sigblocksToPacketsBtn');
    const sigblocksResetBtn = document.getElementById('sigblocksResetBtn');
    const sigblocksRetryBtn = document.getElementById('sigblocksRetryBtn');

    let checklistPath = null;
    let checklistData = null;
    let incumbencyPaths = [];
    let incumbencyData = [];
    let sigblocksDocumentsPath = null;
    let sigblocksResult = null;
    let sigblocksZipPath = null;

    function showSigblocksState(state) {
      sigblocksInputs.style.display = state === 'idle' ? 'flex' : 'none';
      sigblocksProcessing.classList.toggle('visible', state === 'processing');
      sigblocksComplete.classList.toggle('visible', state === 'complete');
      sigblocksError.classList.toggle('visible', state === 'error');
    }

    function updateSigblocksButton() {
      const hasMappings = entityMapping.querySelectorAll('.entity-row').length > 0;
      generateSigblocksBtn.disabled = !(checklistPath && incumbencyPaths.length > 0 && sigblocksDocumentsPath && hasMappings);
    }

    // Checklist selection
    checklistInput.addEventListener('click', async () => {
      const path = await ipcRenderer.invoke('select-spreadsheet');
      if (path) {
        await loadChecklist(path);
      }
    });

    checklistInput.addEventListener('dragover', (e) => {
      e.preventDefault();
      checklistInput.classList.add('active');
    });

    checklistInput.addEventListener('dragleave', () => {
      checklistInput.classList.remove('active');
    });

    checklistInput.addEventListener('drop', async (e) => {
      e.preventDefault();
      checklistInput.classList.remove('active');
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        const ext = files[0].name.toLowerCase();
        if (ext.endsWith('.xlsx') || ext.endsWith('.xls') || ext.endsWith('.csv')) {
          await loadChecklist(files[0].path);
        }
      }
    });

    async function loadChecklist(path) {
      try {
        checklistPath = path;
        checklistSelected.textContent = truncatePath(path);
        checklistInput.classList.add('selected');
        checklistHeader.classList.add('done');

        // Parse checklist
        checklistData = await ipcRenderer.invoke('parse-checklist', path);
        updateEntityMappingUI();
        updateSigblocksButton();
      } catch (err) {
        checklistSelected.textContent = 'Error: ' + err.message;
        checklistInput.classList.remove('selected');
      }
    }

    // Incumbency selection
    incumbencyInput.addEventListener('click', async () => {
      const paths = await ipcRenderer.invoke('select-files', {
        filters: [{ name: 'Documents', extensions: ['pdf', 'docx'] }],
        properties: ['openFile', 'multiSelections']
      });
      if (paths && paths.length > 0) {
        await loadIncumbencies(paths);
      }
    });

    incumbencyInput.addEventListener('dragover', (e) => {
      e.preventDefault();
      incumbencyInput.classList.add('active');
    });

    incumbencyInput.addEventListener('dragleave', () => {
      incumbencyInput.classList.remove('active');
    });

    incumbencyInput.addEventListener('drop', async (e) => {
      e.preventDefault();
      incumbencyInput.classList.remove('active');
      const files = Array.from(e.dataTransfer.files).filter(f => {
        const ext = f.name.toLowerCase();
        return ext.endsWith('.pdf') || ext.endsWith('.docx');
      });
      if (files.length > 0) {
        await loadIncumbencies(files.map(f => f.path));
      }
    });

    async function loadIncumbencies(paths) {
      try {
        incumbencyPaths = paths;
        incumbencySelected.textContent = `${paths.length} file${paths.length !== 1 ? 's' : ''} selected`;
        incumbencyInput.classList.add('selected');
        incumbencyHeader.classList.add('done');

        // Parse incumbencies
        incumbencyData = [];
        for (const p of paths) {
          try {
            const data = await ipcRenderer.invoke('parse-incumbency', p);
            incumbencyData.push(data);
          } catch (err) {
            console.error('Failed to parse', p, err);
          }
        }

        updateEntityMappingUI();
        updateSigblocksButton();
      } catch (err) {
        incumbencySelected.textContent = 'Error: ' + err.message;
      }
    }

    function updateEntityMappingUI() {
      // Show mapping step if we have both checklist and incumbencies
      if (checklistData && incumbencyData.length > 0) {
        mappingStep.style.display = 'block';
        documentsStep.style.display = 'block';

        // Get all roles from checklist
        const roles = checklistData.all_roles || [];

        // Build mapping UI
        let html = '';
        for (const inc of incumbencyData) {
          const entityName = inc.entity_name || inc.source_file || 'Unknown Entity';
          const signers = inc.signers || [];

          html += `<div class="entity-row" data-entity="${entityName}">`;
          html += `<span class="entity-name">${entityName}</span>`;
          html += `<span class="entity-arrow"></span>`;
          html += `<select class="entity-select" data-entity="${entityName}">`;
          html += `<option value="">Select role...</option>`;
          for (const role of roles) {
            html += `<option value="${role}">${role}</option>`;
          }
          html += `</select>`;

          // Signer dropdown
          html += `<select class="signer-select" data-entity="${entityName}">`;
          if (signers.length === 0) {
            html += `<option value="0">No signers found</option>`;
          } else {
            for (let i = 0; i < signers.length; i++) {
              const s = signers[i];
              html += `<option value="${i}">${s.name}${s.title ? ', ' + s.title : ''}</option>`;
            }
          }
          html += `</select>`;
          html += `</div>`;
        }

        if (html === '') {
          html = '<p class="no-data-msg">No entities found in incumbency certificates</p>';
        }

        entityMapping.innerHTML = html;
      }
    }

    // Documents folder selection
    documentsInput.addEventListener('click', async () => {
      const path = await ipcRenderer.invoke('select-folder');
      if (path) {
        sigblocksDocumentsPath = path;
        documentsSelected.textContent = truncatePath(path);
        documentsInput.classList.add('selected');
        documentsHeader.classList.add('done');
        updateSigblocksButton();
      }
    });

    documentsInput.addEventListener('dragover', (e) => {
      e.preventDefault();
      documentsInput.classList.add('active');
    });

    documentsInput.addEventListener('dragleave', () => {
      documentsInput.classList.remove('active');
    });

    documentsInput.addEventListener('drop', (e) => {
      e.preventDefault();
      documentsInput.classList.remove('active');
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        sigblocksDocumentsPath = files[0].path;
        documentsSelected.textContent = truncatePath(sigblocksDocumentsPath);
        documentsInput.classList.add('selected');
        documentsHeader.classList.add('done');
        updateSigblocksButton();
      }
    });

    // Generate signature blocks
    generateSigblocksBtn.addEventListener('click', async () => {
      if (!checklistPath || incumbencyPaths.length === 0 || !sigblocksDocumentsPath) return;

      // Build entity mappings from UI
      const entityMappings = {};
      const rows = entityMapping.querySelectorAll('.entity-row');
      rows.forEach(row => {
        const entityName = row.dataset.entity;
        const roleSelect = row.querySelector('.entity-select');
        const signerSelect = row.querySelector('.signer-select');
        const role = roleSelect.value;
        const signerIndex = parseInt(signerSelect.value, 10) || 0;

        if (role) {
          entityMappings[entityName] = { role, signer_index: signerIndex };
        }
      });

      showSigblocksState('processing');
      sigblocksProgressFill.style.width = '0%';
      sigblocksProgressText.textContent = 'Starting...';

      try {
        const startTime = Date.now();
        const result = await ipcRenderer.invoke('process-sigblocks', {
          checklist_path: checklistPath,
          incumbency_paths: incumbencyPaths,
          documents_folder: sigblocksDocumentsPath,
          entity_mappings: entityMappings
        });

        sigblocksResult = result;
        sigblocksProgressText.textContent = 'Creating ZIP file...';
        sigblocksZipPath = await ipcRenderer.invoke('create-zip', result.output_folder);

        // Update results UI
        const processed = result.documents_processed || [];
        sigblocksResultText.textContent = `Generated signature blocks for ${processed.length} document${processed.length !== 1 ? 's' : ''}`;

        let resultsHtml = '';
        for (const doc of processed.slice(0, 10)) {
          const status = doc.status === 'processed' ? '' : '';
          const note = doc.blocks_added ? `(${doc.blocks_added} blocks)` : doc.note || '';
          resultsHtml += `<div class="sigblock-result-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            ${doc.file} ${note}
          </div>`;
        }
        if (processed.length > 10) {
          resultsHtml += `<div class="sigblock-result-item" style="color: #555;">...and ${processed.length - 10} more</div>`;
        }
        sigblocksResults.innerHTML = resultsHtml;

        // Log usage
        await logUsage('sigblocks', 'process', 1, processed.length, Date.now() - startTime);

        showSigblocksState('complete');
      } catch (err) {
        sigblocksErrorText.textContent = err.message;
        showSigblocksState('error');
      }
    });

    // Listen for sigblocks progress
    ipcRenderer.on('sigblocks-progress', (event, data) => {
      sigblocksProgressText.textContent = data.message;
      sigblocksProgressFill.style.width = data.percent + '%';
    });

    sigblocksDownloadBtn.addEventListener('click', async () => {
      if (sigblocksZipPath) await ipcRenderer.invoke('save-zip', sigblocksZipPath, 'EmmaNeigh-Signature-Blocks.zip');
    });

    // Flow to Signature Packets
    sigblocksToPacketsBtn.addEventListener('click', async () => {
      if (sigblocksResult && sigblocksResult.output_folder) {
        // Switch to packets tab using new nav system
        switchTab('packets');

        // Process the output folder
        await processFolder(sigblocksResult.output_folder);
      }
    });

    function resetSigblocksState() {
      checklistPath = null;
      checklistData = null;
      incumbencyPaths = [];
      incumbencyData = [];
      sigblocksDocumentsPath = null;
      sigblocksResult = null;
      sigblocksZipPath = null;

      checklistSelected.textContent = '';
      incumbencySelected.textContent = '';
      documentsSelected.textContent = '';
      entityMapping.innerHTML = '';

      checklistInput.classList.remove('selected');
      incumbencyInput.classList.remove('selected');
      documentsInput.classList.remove('selected');
      checklistHeader.classList.remove('done');
      incumbencyHeader.classList.remove('done');
      documentsHeader.classList.remove('done');

      mappingStep.style.display = 'none';
      documentsStep.style.display = 'none';

      updateSigblocksButton();
      showSigblocksState('idle');
    }

    sigblocksResetBtn.addEventListener('click', resetSigblocksState);
    sigblocksRetryBtn.addEventListener('click', resetSigblocksState);

    // ========== COLLATE TAB ==========
    const baseDocInput = document.getElementById('baseDocInput');
    const baseDocSelected = document.getElementById('baseDocSelected');
    const baseDocHeader = document.getElementById('baseDocHeader');
    const commentedDocsInput = document.getElementById('commentedDocsInput');
    const commentedDocsSelected = document.getElementById('commentedDocsSelected');
    const commentedDocsList = document.getElementById('commentedDocsList');
    const commentedDocsHeader = document.getElementById('commentedDocsHeader');
    const collateBtn = document.getElementById('collateBtn');
    const collateInputs = document.getElementById('collateInputs');
    const collateProcessing = document.getElementById('collateProcessing');
    const collateComplete = document.getElementById('collateComplete');
    const collateError = document.getElementById('collateError');
    const collateProgressText = document.getElementById('collateProgressText');
    const collateProgressFill = document.getElementById('collateProgressFill');
    const collateResultText = document.getElementById('collateResultText');
    const totalChangesValue = document.getElementById('totalChangesValue');
    const totalCommentsValue = document.getElementById('totalCommentsValue');
    const conflictsValue = document.getElementById('conflictsValue');
    const conflictList = document.getElementById('conflictList');
    const collateErrorText = document.getElementById('collateErrorText');
    const collateDownloadBtn = document.getElementById('collateDownloadBtn');
    const collateResetBtn = document.getElementById('collateResetBtn');
    const collateRetryBtn = document.getElementById('collateRetryBtn');

    let baseDocPath = null;
    let commentedDocPaths = [];
    let collateResult = null;
    let collateZipPath = null;

    function showCollateState(state) {
      collateInputs.style.display = state === 'idle' ? 'flex' : 'none';
      collateProcessing.classList.toggle('visible', state === 'processing');
      collateComplete.classList.toggle('visible', state === 'complete');
      collateError.classList.toggle('visible', state === 'error');
    }

    function updateCollateButton() {
      collateBtn.disabled = !(baseDocPath && commentedDocPaths.length > 0);
    }

    function updateCommentedDocsList() {
      // Always update the count display
      if (commentedDocPaths.length > 0) {
        commentedDocsSelected.textContent = `${commentedDocPaths.length} file${commentedDocPaths.length !== 1 ? 's' : ''} selected`;
        commentedDocsInput.classList.add('selected');
        commentedDocsHeader.classList.add('done');
        commentedDocsList.classList.remove('hidden');

        let html = '';
        commentedDocPaths.forEach((p, i) => {
          const name = p.split(/[/\\]/).pop();
          html += `<div class="file-list-item">
            <span>${name}</span>
            <button class="remove-btn" data-index="${i}"></button>
          </div>`;
        });
        commentedDocsList.innerHTML = html;

        // Add remove handlers
        commentedDocsList.querySelectorAll('.remove-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const idx = parseInt(btn.dataset.index, 10);
            commentedDocPaths.splice(idx, 1);
            updateCommentedDocsList();
            updateCollateButton();
          });
        });
      } else {
        commentedDocsSelected.textContent = '';
        commentedDocsInput.classList.remove('selected');
        commentedDocsHeader.classList.remove('done');
        commentedDocsList.classList.add('hidden');
        commentedDocsList.innerHTML = '';
      }
    }

    // Base document selection
    baseDocInput.addEventListener('click', async () => {
      const path = await ipcRenderer.invoke('select-docx');
      if (path) {
        baseDocPath = path;
        baseDocSelected.textContent = truncatePath(path);
        baseDocInput.classList.add('selected');
        baseDocHeader.classList.add('done');
        updateCollateButton();
      }
    });

    baseDocInput.addEventListener('dragover', (e) => {
      e.preventDefault();
      baseDocInput.classList.add('active');
    });

    baseDocInput.addEventListener('dragleave', () => {
      baseDocInput.classList.remove('active');
    });

    baseDocInput.addEventListener('drop', (e) => {
      e.preventDefault();
      baseDocInput.classList.remove('active');
      const files = e.dataTransfer.files;
      if (files.length > 0 && files[0].name.toLowerCase().endsWith('.docx')) {
        baseDocPath = files[0].path;
        baseDocSelected.textContent = truncatePath(baseDocPath);
        baseDocInput.classList.add('selected');
        baseDocHeader.classList.add('done');
        updateCollateButton();
      }
    });

    // Commented documents selection
    commentedDocsInput.addEventListener('click', async () => {
      const paths = await ipcRenderer.invoke('select-docx-multiple');
      if (paths && paths.length > 0) {
        commentedDocPaths = [...commentedDocPaths, ...paths];
        commentedDocsSelected.textContent = `${commentedDocPaths.length} file${commentedDocPaths.length !== 1 ? 's' : ''} selected`;
        commentedDocsInput.classList.add('selected');
        commentedDocsHeader.classList.add('done');
        updateCommentedDocsList();
        updateCollateButton();
      }
    });

    commentedDocsInput.addEventListener('dragover', (e) => {
      e.preventDefault();
      commentedDocsInput.classList.add('active');
    });

    commentedDocsInput.addEventListener('dragleave', () => {
      commentedDocsInput.classList.remove('active');
    });

    commentedDocsInput.addEventListener('drop', (e) => {
      e.preventDefault();
      commentedDocsInput.classList.remove('active');
      const files = Array.from(e.dataTransfer.files).filter(f =>
        f.name.toLowerCase().endsWith('.docx')
      );
      if (files.length > 0) {
        commentedDocPaths = [...commentedDocPaths, ...files.map(f => f.path)];
        commentedDocsSelected.textContent = `${commentedDocPaths.length} file${commentedDocPaths.length !== 1 ? 's' : ''} selected`;
        commentedDocsInput.classList.add('selected');
        commentedDocsHeader.classList.add('done');
        updateCommentedDocsList();
        updateCollateButton();
      }
    });

    // Collate documents
    collateBtn.addEventListener('click', async () => {
      if (!baseDocPath || commentedDocPaths.length === 0) return;

      showCollateState('processing');
      collateProgressFill.style.width = '0%';
      collateProgressText.textContent = 'Starting...';

      try {
        const startTime = Date.now();
        const result = await ipcRenderer.invoke('collate-documents', {
          base_document: baseDocPath,
          commented_documents: commentedDocPaths
        });

        collateResult = result;
        collateProgressText.textContent = 'Creating ZIP file...';
        collateZipPath = await ipcRenderer.invoke('create-zip', result.output_folder);

        // Update results UI
        collateResultText.textContent = `Merged changes from ${commentedDocPaths.length} document${commentedDocPaths.length !== 1 ? 's' : ''}`;
        totalChangesValue.textContent = result.total_changes || 0;
        totalCommentsValue.textContent = result.total_comments || 0;
        conflictsValue.textContent = result.conflicts || 0;

        // Show conflicts if any
        if (result.conflicts > 0) {
          conflictsValue.classList.add('warning');
          conflictList.classList.remove('hidden');
          conflictList.innerHTML = `<div class="conflict-item">${result.unresolved_conflicts || 0} unresolved conflict(s) detected. Review the summary document for details.</div>`;
        } else {
          conflictsValue.classList.remove('warning');
          conflictList.classList.add('hidden');
        }

        // Log usage
        await logUsage('collate', 'process', commentedDocPaths.length + 1, 1, Date.now() - startTime);

        showCollateState('complete');
      } catch (err) {
        collateErrorText.textContent = err.message;
        showCollateState('error');
      }
    });

    // Listen for collate progress
    ipcRenderer.on('collate-progress', (event, data) => {
      collateProgressText.textContent = data.message;
      collateProgressFill.style.width = data.percent + '%';
    });

    collateDownloadBtn.addEventListener('click', async () => {
      if (collateZipPath) await ipcRenderer.invoke('save-zip', collateZipPath, 'EmmaNeigh-Collated.zip');
    });

    function resetCollateState() {
      baseDocPath = null;
      commentedDocPaths = [];
      collateResult = null;
      collateZipPath = null;

      baseDocSelected.textContent = '';
      commentedDocsSelected.textContent = '';
      commentedDocsList.innerHTML = '';
      commentedDocsList.classList.add('hidden');

      baseDocInput.classList.remove('selected');
      commentedDocsInput.classList.remove('selected');
      baseDocHeader.classList.remove('done');
      commentedDocsHeader.classList.remove('done');

      conflictList.classList.add('hidden');
      conflictsValue.classList.remove('warning');

      updateCollateButton();
      showCollateState('idle');
    }

    collateResetBtn.addEventListener('click', resetCollateState);
    collateRetryBtn.addEventListener('click', resetCollateState);

    // ========== EMAIL TAB ==========
    const emailCsvDrop = document.getElementById('emailCsvDrop');
    const emailCsvSelected = document.getElementById('emailCsvSelected');
    const emailStats = document.getElementById('emailStats');
    const emailTotalCount = document.getElementById('emailTotalCount');
    const emailSenderCount = document.getElementById('emailSenderCount');
    const emailDateRange = document.getElementById('emailDateRange');
    const emailSearchBox = document.getElementById('emailSearchBox');
    const emailSearchInput = document.getElementById('emailSearchInput');
    const emailSearchBtn = document.getElementById('emailSearchBtn');
    const emailResults = document.getElementById('emailResults');
    const emailResultsTitle = document.getElementById('emailResultsTitle');
    const emailList = document.getElementById('emailList');
    const emailPrivacyToggle = document.getElementById('emailPrivacyToggle');
    const emailBlurToggle = document.getElementById('emailBlurToggle');
    const emailUpload = document.getElementById('emailUpload');
    const emailProcessing = document.getElementById('emailProcessing');
    const emailError = document.getElementById('emailError');
    const emailProgressText = document.getElementById('emailProgressText');
    const emailProgressFill = document.getElementById('emailProgressFill');
    const emailErrorText = document.getElementById('emailErrorText');
    const emailRetryBtn = document.getElementById('emailRetryBtn');

    // Advanced filter elements
    const emailFilters = document.getElementById('emailFilters');
    const emailFilterSender = document.getElementById('emailFilterSender');
    const emailFilterSubject = document.getElementById('emailFilterSubject');
    const emailFilterAttachment = document.getElementById('emailFilterAttachment');
    const emailFilterDateFrom = document.getElementById('emailFilterDateFrom');
    const emailFilterDateTo = document.getElementById('emailFilterDateTo');
    const emailFilterHasAttachment = document.getElementById('emailFilterHasAttachment');
    const emailClearFilters = document.getElementById('emailClearFilters');

    // AI Search elements
    const searchModeToggle = document.getElementById('searchModeToggle');
    const keywordSearchMode = document.getElementById('keywordSearchMode');
    const aiSearchMode = document.getElementById('aiSearchMode');
    const aiSearchPanel = document.getElementById('aiSearchPanel');
    const aiSearchInput = document.getElementById('aiSearchInput');
    const aiSearchBtn = document.getElementById('aiSearchBtn');
    const aiSearchLoading = document.getElementById('aiSearchLoading');
    const aiSearchLoadingText = document.getElementById('aiSearchLoadingText');
    const aiAnswerBox = document.getElementById('aiAnswerBox');
    const aiAnswerText = document.getElementById('aiAnswerText');
    const aiAnswerConfidence = document.getElementById('aiAnswerConfidence');
    const aiRelevantEmails = document.getElementById('aiRelevantEmails');
    const aiEmailList = document.getElementById('aiEmailList');

    let emailData = []; // Parsed emails
    let emailCsvPath = null;
    let currentSearchMode = 'keyword'; // 'keyword' or 'ai'

    function showEmailState(state) {
      emailUpload.style.display = state === 'idle' || state === 'loaded' ? 'block' : 'none';
      emailProcessing.classList.toggle('visible', state === 'processing');
      emailError.classList.toggle('visible', state === 'error');
    }

    // CSV Drop handlers
    emailCsvDrop.addEventListener('dragover', (e) => {
      e.preventDefault();
      emailCsvDrop.classList.add('active');
    });

    emailCsvDrop.addEventListener('dragleave', () => {
      emailCsvDrop.classList.remove('active');
    });

    emailCsvDrop.addEventListener('drop', async (e) => {
      e.preventDefault();
      emailCsvDrop.classList.remove('active');
      const files = e.dataTransfer.files;
      if (files.length > 0 && files[0].name.toLowerCase().endsWith('.csv')) {
        await processEmailCsv(files[0].path);
      }
    });

    emailCsvDrop.addEventListener('click', async () => {
      const result = await ipcRenderer.invoke('select-file', {
        title: 'Select Email CSV',
        filters: [{ name: 'CSV Files', extensions: ['csv'] }]
      });
      if (result) {
        await processEmailCsv(result);
      }
    });

    async function processEmailCsv(csvPath) {
      emailCsvPath = csvPath;
      emailCsvSelected.textContent = csvPath.split(/[/\\]/).pop();
      emailCsvDrop.classList.add('selected');
      showEmailState('processing');

      const startTime = Date.now();

      try {
        const result = await ipcRenderer.invoke('parse-email-csv', csvPath);

        if (result.success) {
          emailData = result.emails;

          // Update stats
          emailTotalCount.textContent = result.summary.total_emails;
          emailSenderCount.textContent = result.summary.unique_senders;

          if (result.summary.date_range.earliest && result.summary.date_range.latest) {
            const earliest = new Date(result.summary.date_range.earliest).toLocaleDateString();
            const latest = new Date(result.summary.date_range.latest).toLocaleDateString();
            emailDateRange.textContent = `${earliest} - ${latest}`;
          }

          // Show UI elements
          emailStats.style.display = 'grid';
          searchModeToggle.style.display = 'flex';
          emailSearchBox.style.display = 'flex';
          emailFilters.style.display = 'grid';
          emailPrivacyToggle.style.display = 'block';

          // Log usage
          await logUsage('email', 'parse', 1, result.summary.total_emails, Date.now() - startTime);

          showEmailState('loaded');
        } else {
          emailErrorText.textContent = result.error || 'Failed to parse CSV';
          showEmailState('error');
        }
      } catch (err) {
        emailErrorText.textContent = err.message;
        showEmailState('error');
      }
    }

    // Search functionality
    emailSearchBtn.addEventListener('click', () => {
      performEmailSearch();
    });

    emailSearchInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        performEmailSearch();
      }
    });

    function performEmailSearch() {
      const query = emailSearchInput.value.trim();

      // Get filter values
      const senderFilter = emailFilterSender.value.trim().toLowerCase();
      const subjectFilter = emailFilterSubject.value.trim().toLowerCase();
      const attachmentFilter = emailFilterAttachment.value.trim().toLowerCase();
      const dateFrom = emailFilterDateFrom.value ? new Date(emailFilterDateFrom.value) : null;
      const dateTo = emailFilterDateTo.value ? new Date(emailFilterDateTo.value + 'T23:59:59') : null;
      const hasAttachmentOnly = emailFilterHasAttachment.checked;

      // Check if we have any search criteria
      const hasFilters = query || senderFilter || subjectFilter || attachmentFilter || dateFrom || dateTo || hasAttachmentOnly;
      if (!hasFilters || emailData.length === 0) {
        if (emailData.length === 0) return;
        // Show all emails if no filters but data exists
      }

      const queryLower = query.toLowerCase();
      const results = emailData.filter(email => {
        // Keyword search (if provided)
        if (query) {
          const keywordMatch = (email.subject && email.subject.toLowerCase().includes(queryLower)) ||
                               (email.body && email.body.toLowerCase().includes(queryLower)) ||
                               (email.from && email.from.toLowerCase().includes(queryLower)) ||
                               (email.to && email.to.toLowerCase().includes(queryLower));
          if (!keywordMatch) return false;
        }

        // Sender filter
        if (senderFilter) {
          const senderMatch = email.from && email.from.toLowerCase().includes(senderFilter);
          if (!senderMatch) return false;
        }

        // Subject filter
        if (subjectFilter) {
          const subjectMatch = email.subject && email.subject.toLowerCase().includes(subjectFilter);
          if (!subjectMatch) return false;
        }

        // Attachment filename filter
        if (attachmentFilter) {
          const attachmentMatch = email.attachments && email.attachments.toLowerCase().includes(attachmentFilter);
          if (!attachmentMatch) return false;
        }

        // Has attachment filter
        if (hasAttachmentOnly && !email.has_attachments) {
          return false;
        }

        // Date range filter
        const emailDate = email.date_received || email.date_sent;
        if (emailDate) {
          const emailDateObj = new Date(emailDate);
          if (dateFrom && emailDateObj < dateFrom) return false;
          if (dateTo && emailDateObj > dateTo) return false;
        } else if (dateFrom || dateTo) {
          // If date filter set but email has no date, exclude it
          return false;
        }

        return true;
      });

      emailResultsTitle.textContent = `Search Results (${results.length} found)`;
      emailList.innerHTML = '';

      const blur = emailBlurToggle.checked;

      results.slice(0, 50).forEach(email => {
        const item = document.createElement('div');
        item.className = 'email-item';

        const subject = document.createElement('div');
        subject.className = 'email-item-subject' + (blur ? ' blurred' : '');
        subject.textContent = email.subject || '(No Subject)';

        const meta = document.createElement('div');
        meta.className = 'email-item-meta' + (blur ? ' blurred' : '');
        const date = email.date_sent || email.date_received || '';
        const dateStr = date ? new Date(date).toLocaleDateString() : '';

        // Show attachment info if present
        let attachmentInfo = '';
        if (email.has_attachments && email.attachments) {
          attachmentInfo = ` |  ${email.attachments.substring(0, 30)}${email.attachments.length > 30 ? '...' : ''}`;
        } else if (email.has_attachments) {
          attachmentInfo = ' |  Attachment';
        }

        meta.textContent = `From: ${email.from || 'Unknown'} | ${dateStr}${attachmentInfo}`;

        item.appendChild(subject);
        item.appendChild(meta);
        emailList.appendChild(item);
      });

      emailResults.style.display = 'block';
    }

    // Privacy blur toggle
    emailBlurToggle.addEventListener('change', () => {
      if (emailResults.style.display !== 'none') {
        performEmailSearch(); // Re-render with blur
      }
    });

    emailRetryBtn.addEventListener('click', () => {
      emailData = [];
      emailCsvPath = null;
      emailCsvSelected.textContent = '';
      emailCsvDrop.classList.remove('selected');
      emailStats.style.display = 'none';
      searchModeToggle.style.display = 'none';
      emailSearchBox.style.display = 'none';
      emailFilters.style.display = 'none';
      emailResults.style.display = 'none';
      emailPrivacyToggle.style.display = 'none';
      // Reset AI search
      aiSearchPanel.classList.remove('visible');
      aiSearchLoading.style.display = 'none';
      aiAnswerBox.style.display = 'none';
      aiSearchInput.value = '';
      currentSearchMode = 'keyword';
      keywordSearchMode.classList.add('active');
      aiSearchMode.classList.remove('active');
      clearEmailFilters();
      showEmailState('idle');
    });

    // Clear filters function
    function clearEmailFilters() {
      emailSearchInput.value = '';
      emailFilterSender.value = '';
      emailFilterSubject.value = '';
      emailFilterAttachment.value = '';
      emailFilterDateFrom.value = '';
      emailFilterDateTo.value = '';
      emailFilterHasAttachment.checked = false;
    }

    // Clear filters button handler
    emailClearFilters.addEventListener('click', () => {
      clearEmailFilters();
      if (emailResults.style.display !== 'none') {
        performEmailSearch(); // Re-run search with cleared filters
      }
    });

    // Allow Enter key on filter inputs to trigger search
    [emailFilterSender, emailFilterSubject, emailFilterAttachment].forEach(input => {
      input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          performEmailSearch();
        }
      });
    });

    // Auto-search on date change
    [emailFilterDateFrom, emailFilterDateTo].forEach(input => {
      input.addEventListener('change', () => {
        if (emailData.length > 0) {
          performEmailSearch();
        }
      });
    });

    // Auto-search on has attachment checkbox change
    emailFilterHasAttachment.addEventListener('change', () => {
      if (emailData.length > 0) {
        performEmailSearch();
      }
    });

    // Listen for email progress
    ipcRenderer.on('email-progress', (event, data) => {
      emailProgressText.textContent = data.message;
      emailProgressFill.style.width = data.percent + '%';
    });

    // ========== AI SEARCH FUNCTIONALITY ==========

    // Toggle between keyword and AI search modes
    keywordSearchMode.addEventListener('click', () => {
      currentSearchMode = 'keyword';
      keywordSearchMode.classList.add('active');
      aiSearchMode.classList.remove('active');

      emailSearchBox.style.display = 'flex';
      emailFilters.style.display = 'grid';
      aiSearchPanel.classList.remove('visible');
      aiSearchLoading.style.display = 'none';
      aiAnswerBox.style.display = 'none';
    });

    aiSearchMode.addEventListener('click', () => {
      currentSearchMode = 'ai';
      aiSearchMode.classList.add('active');
      keywordSearchMode.classList.remove('active');

      emailSearchBox.style.display = 'none';
      emailFilters.style.display = 'none';
      emailResults.style.display = 'none';
      aiSearchPanel.classList.add('visible');
    });

    // AI Search handler
    aiSearchBtn.addEventListener('click', async () => {
      const query = aiSearchInput.value.trim();
      if (!query || emailData.length === 0) return;

      // Check if API key is configured
      const apiKeyResult = await ipcRenderer.invoke('get-api-key');
      if (!apiKeyResult.hasKey) {
        alert('Please configure your Claude API key in Settings first.');
        settingsModal.classList.add('visible');
        await checkApiKeyStatus();
        return;
      }

      // Show loading
      aiSearchLoading.style.display = 'flex';
      aiSearchLoadingText.textContent = 'Analyzing emails with AI...';
      aiAnswerBox.style.display = 'none';
      aiSearchBtn.disabled = true;

      const startTime = Date.now();

      try {
        const result = await ipcRenderer.invoke('nl-search-emails', {
          emails: emailData,
          query: query
        });

        aiSearchLoading.style.display = 'none';
        aiSearchBtn.disabled = false;

        if (result.success) {
          // Show the answer
          aiAnswerBox.style.display = 'block';
          aiAnswerText.textContent = result.answer;

          // Show confidence
          const confidencePercent = Math.round((result.confidence || 0.5) * 100);
          aiAnswerConfidence.textContent = `Confidence: ${confidencePercent}%`;

          // Show relevant emails if any
          const relevantIndices = result.relevant_email_indices || [];
          if (relevantIndices.length > 0) {
            aiRelevantEmails.style.display = 'block';
            const blur = emailBlurToggle.checked;

            aiEmailList.innerHTML = relevantIndices.slice(0, 10).map(idx => {
              const email = emailData[idx];
              if (!email) return '';

              const date = email.date_sent || email.date_received || '';
              const dateStr = date ? new Date(date).toLocaleDateString() : '';

              return `
                <div class="email-item">
                  <div class="email-item-subject${blur ? ' blurred' : ''}">${email.subject || '(No Subject)'}</div>
                  <div class="email-item-meta${blur ? ' blurred' : ''}">From: ${email.from || 'Unknown'} | ${dateStr}</div>
                </div>
              `;
            }).join('');
          } else {
            aiRelevantEmails.style.display = 'none';
          }

          // Log usage
          await logUsage('email', 'ai_search', 1, relevantIndices.length, Date.now() - startTime);
        } else {
          aiAnswerBox.style.display = 'block';
          aiAnswerText.textContent = result.error || 'Failed to get AI response. Please check your API key.';
          aiAnswerConfidence.textContent = '';
          aiRelevantEmails.style.display = 'none';
        }
      } catch (err) {
        aiSearchLoading.style.display = 'none';
        aiSearchBtn.disabled = false;
        aiAnswerBox.style.display = 'block';
        aiAnswerText.textContent = `Error: ${err.message}`;
        aiAnswerConfidence.textContent = '';
        aiRelevantEmails.style.display = 'none';
      }
    });

    // Allow Enter key (Ctrl+Enter) in AI search textarea
    aiSearchInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
        e.preventDefault();
        aiSearchBtn.click();
      }
    });

    // Listen for NL search progress
    ipcRenderer.on('nl-search-progress', (event, data) => {
      aiSearchLoadingText.textContent = data.message || 'Processing...';
    });

    // ========== TIME TRACKING TAB ==========
    const timetrackEmailDrop = document.getElementById('timetrackEmailDrop');
    const timetrackEmailSelected = document.getElementById('timetrackEmailSelected');
    const timetrackCalendarDrop = document.getElementById('timetrackCalendarDrop');
    const timetrackCalendarSelected = document.getElementById('timetrackCalendarSelected');
    const timetrackGenerateBtn = document.getElementById('timetrackGenerateBtn');
    const timetrackSetup = document.getElementById('timetrackSetup');
    const timetrackProcessing = document.getElementById('timetrackProcessing');
    const timetrackResults = document.getElementById('timetrackResults');
    const timetrackError = document.getElementById('timetrackError');
    const timetrackProgressText = document.getElementById('timetrackProgressText');
    const timetrackProgressFill = document.getElementById('timetrackProgressFill');
    const timetrackErrorText = document.getElementById('timetrackErrorText');
    const timetrackRetryBtn = document.getElementById('timetrackRetryBtn');
    const timetrackResetBtn = document.getElementById('timetrackResetBtn');
    const timetrackResultsTitle = document.getElementById('timetrackResultsTitle');
    const timetrackMatters = document.getElementById('timetrackMatters');
    const timetrackTimeline = document.getElementById('timetrackTimeline');
    const ttTotalHours = document.getElementById('ttTotalHours');
    const ttTotalMeetings = document.getElementById('ttTotalMeetings');
    const ttTotalEmails = document.getElementById('ttTotalEmails');

    let ttEmailData = [];
    let ttEmailPath = null;
    let ttCalendarPath = null;

    function showTimetrackState(state) {
      timetrackSetup.style.display = state === 'idle' ? 'block' : 'none';
      timetrackProcessing.classList.toggle('visible', state === 'processing');
      timetrackResults.style.display = state === 'results' ? 'block' : 'none';
      timetrackError.classList.toggle('visible', state === 'error');
    }

    function updateTimetrackButton() {
      timetrackGenerateBtn.disabled = ttEmailData.length === 0;
    }

    // Email drop for time tracking
    timetrackEmailDrop.addEventListener('click', async () => {
      const result = await ipcRenderer.invoke('select-file', {
        title: 'Select Email CSV',
        filters: [{ name: 'CSV Files', extensions: ['csv'] }]
      });
      if (result) {
        ttEmailPath = result;
        timetrackEmailSelected.textContent = result.split(/[/\\]/).pop();
        timetrackEmailDrop.classList.add('selected');

        // Parse emails
        try {
          const parseResult = await ipcRenderer.invoke('parse-email-csv', result);
          if (parseResult.success) {
            ttEmailData = parseResult.emails;
            updateTimetrackButton();
          }
        } catch (e) {
          console.error('Failed to parse emails:', e);
        }
      }
    });

    // Calendar drop
    timetrackCalendarDrop.addEventListener('click', async () => {
      const result = await ipcRenderer.invoke('select-file', {
        title: 'Select Calendar File',
        filters: [{ name: 'Calendar Files', extensions: ['ics', 'csv'] }]
      });
      if (result) {
        ttCalendarPath = result;
        timetrackCalendarSelected.textContent = result.split(/[/\\]/).pop();
        timetrackCalendarDrop.classList.add('selected');
      }
    });

    // Generate summary
    timetrackGenerateBtn.addEventListener('click', async () => {
      if (ttEmailData.length === 0) return;

      showTimetrackState('processing');
      const startTime = Date.now();

      const period = document.querySelector('input[name="timetrackPeriod"]:checked').value;

      try {
        const result = await ipcRenderer.invoke('generate-time-summary', {
          emails: ttEmailData,
          calendar_path: ttCalendarPath,
          period: period
        });

        if (result.success) {
          const summary = result.summary;

          // Update title
          const dateStr = new Date(summary.date).toLocaleDateString('en-US', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
          });
          timetrackResultsTitle.textContent = period === 'week' ? `Week of ${dateStr}` : dateStr;

          // Update stats
          ttTotalHours.textContent = summary.total_active_hours + 'h';
          ttTotalMeetings.textContent = summary.total_meetings;
          ttTotalEmails.textContent = summary.total_emails;

          // Render matters
          timetrackMatters.innerHTML = '';
          summary.by_matter.forEach(matter => {
            const item = document.createElement('div');
            item.className = 'matter-item';
            item.innerHTML = `
              <div class="matter-header">
                <span class="matter-name">${matter.name}</span>
                <span class="matter-hours">${matter.hours}h (${matter.percent}%)</span>
              </div>
              <div class="matter-bar">
                <div class="matter-bar-fill" style="width: ${matter.percent}%"></div>
              </div>
              <div class="matter-details">
                ${matter.emails_sent + matter.emails_received} emails  ${matter.meetings} meetings
              </div>
            `;
            timetrackMatters.appendChild(item);
          });

          // Render timeline
          timetrackTimeline.innerHTML = '';
          summary.timeline.forEach(item => {
            const el = document.createElement('div');
            el.className = 'timeline-item';
            const icon = item.type === 'meeting' ? '' : '';
            el.innerHTML = `
              <span class="timeline-time">${item.time}</span>
              <span class="timeline-icon">${icon}</span>
              <span class="timeline-desc">${item.description}</span>
            `;
            timetrackTimeline.appendChild(el);
          });

          // Log usage
          await logUsage('timetrack', 'generate', ttEmailData.length, 1, Date.now() - startTime);

          showTimetrackState('results');
        } else {
          timetrackErrorText.textContent = result.error || 'Failed to generate summary';
          showTimetrackState('error');
        }
      } catch (err) {
        timetrackErrorText.textContent = err.message;
        showTimetrackState('error');
      }
    });

    function resetTimetrackState() {
      ttEmailData = [];
      ttEmailPath = null;
      ttCalendarPath = null;
      timetrackEmailSelected.textContent = '';
      timetrackCalendarSelected.textContent = '';
      timetrackEmailDrop.classList.remove('selected');
      timetrackCalendarDrop.classList.remove('selected');
      updateTimetrackButton();
      showTimetrackState('idle');
    }

    timetrackResetBtn.addEventListener('click', resetTimetrackState);
    timetrackRetryBtn.addEventListener('click', resetTimetrackState);

    // Listen for timetrack progress
    ipcRenderer.on('timetrack-progress', (event, data) => {
      timetrackProgressText.textContent = data.message;
      timetrackProgressFill.style.width = data.percent + '%';
    });

    // ========== UPDATE CHECKLIST TAB ==========
    const checklistDocDrop = document.getElementById('checklistDocDrop');
    const checklistEmailDrop = document.getElementById('checklistEmailDrop');
    const checklistDocSelected = document.getElementById('checklistDocSelected');
    const checklistEmailSelected = document.getElementById('checklistEmailSelected');
    const clearChecklistDoc = document.getElementById('clearChecklistDoc');
    const clearChecklistEmail = document.getElementById('clearChecklistEmail');
    const updateChecklistBtn = document.getElementById('updateChecklistBtn');
    const checklistSetup = document.getElementById('checklistSetup');
    const checklistProcessing = document.getElementById('checklistProcessing');
    const checklistComplete = document.getElementById('checklistComplete');
    const checklistError = document.getElementById('checklistError');
    const checklistProgressText = document.getElementById('checklistProgressText');
    const checklistProgressFill = document.getElementById('checklistProgressFill');
    const checklistResultText = document.getElementById('checklistResultText');
    const checklistErrorText = document.getElementById('checklistErrorText');
    const downloadChecklistBtn = document.getElementById('downloadChecklistBtn');
    const checklistResetBtn = document.getElementById('checklistResetBtn');
    const checklistRetryBtn = document.getElementById('checklistRetryBtn');

    let checklistDocPath = null;
    let checklistEmailPath = null;
    let checklistOutputPath = null;

    function showChecklistState(state) {
      checklistSetup.style.display = state === 'idle' ? 'block' : 'none';
      checklistProcessing.classList.toggle('visible', state === 'processing');
      checklistComplete.classList.toggle('visible', state === 'complete');
      checklistError.classList.toggle('visible', state === 'error');
    }

    function updateChecklistButton() {
      updateChecklistBtn.disabled = !(checklistDocPath && checklistEmailPath);
    }

    // Checklist doc drop
    checklistDocDrop.addEventListener('click', async (e) => {
      if (e.target === clearChecklistDoc) return; // Don't open picker when clearing
      const result = await ipcRenderer.invoke('select-file', { filters: [{ name: 'Word Documents', extensions: ['docx'] }] });
      if (result) {
        checklistDocPath = result;
        checklistDocSelected.textContent = result.split(/[\\/]/).pop();
        checklistDocDrop.classList.add('selected');
        clearChecklistDoc.classList.add('visible');
        updateChecklistButton();
      }
    });

    checklistDocDrop.addEventListener('dragover', (e) => { e.preventDefault(); checklistDocDrop.classList.add('drag-over'); });
    checklistDocDrop.addEventListener('dragleave', () => { checklistDocDrop.classList.remove('drag-over'); });
    checklistDocDrop.addEventListener('drop', (e) => {
      e.preventDefault();
      checklistDocDrop.classList.remove('drag-over');
      const file = e.dataTransfer.files[0];
      if (file && file.name.toLowerCase().endsWith('.docx')) {
        checklistDocPath = file.path;
        checklistDocSelected.textContent = file.name;
        checklistDocDrop.classList.add('selected');
        clearChecklistDoc.classList.add('visible');
        updateChecklistButton();
      }
    });

    // Clear checklist doc
    clearChecklistDoc.addEventListener('click', (e) => {
      e.stopPropagation();
      checklistDocPath = null;
      checklistDocSelected.textContent = '';
      checklistDocDrop.classList.remove('selected');
      clearChecklistDoc.classList.remove('visible');
      updateChecklistButton();
    });

    // Checklist email drop
    checklistEmailDrop.addEventListener('click', async (e) => {
      if (e.target === clearChecklistEmail) return;
      const result = await ipcRenderer.invoke('select-file', { filters: [{ name: 'CSV Files', extensions: ['csv'] }] });
      if (result) {
        checklistEmailPath = result;
        checklistEmailSelected.textContent = result.split(/[\\/]/).pop();
        checklistEmailDrop.classList.add('selected');
        clearChecklistEmail.classList.add('visible');
        updateChecklistButton();
      }
    });

    checklistEmailDrop.addEventListener('dragover', (e) => { e.preventDefault(); checklistEmailDrop.classList.add('drag-over'); });
    checklistEmailDrop.addEventListener('dragleave', () => { checklistEmailDrop.classList.remove('drag-over'); });
    checklistEmailDrop.addEventListener('drop', (e) => {
      e.preventDefault();
      checklistEmailDrop.classList.remove('drag-over');
      const file = e.dataTransfer.files[0];
      if (file && file.name.toLowerCase().endsWith('.csv')) {
        checklistEmailPath = file.path;
        checklistEmailSelected.textContent = file.name;
        checklistEmailDrop.classList.add('selected');
        clearChecklistEmail.classList.add('visible');
        updateChecklistButton();
      }
    });

    // Clear checklist email
    clearChecklistEmail.addEventListener('click', (e) => {
      e.stopPropagation();
      checklistEmailPath = null;
      checklistEmailSelected.textContent = '';
      checklistEmailDrop.classList.remove('selected');
      clearChecklistEmail.classList.remove('visible');
      updateChecklistButton();
    });

    // Update checklist button
    updateChecklistBtn.addEventListener('click', async () => {
      if (!checklistDocPath || !checklistEmailPath) return;

      showChecklistState('processing');
      checklistProgressFill.style.width = '0%';
      checklistProgressText.textContent = 'Analyzing emails...';

      try {
        const result = await ipcRenderer.invoke('update-checklist', {
          checklistPath: checklistDocPath,
          emailPath: checklistEmailPath
        });

        if (result.success) {
          checklistOutputPath = result.outputPath;
          checklistResultText.textContent = `Updated ${result.itemsUpdated || 0} checklist items based on email activity`;
          showChecklistState('complete');
          logUsage('update_checklist', 'complete', 2, result.itemsUpdated || 0);
        } else {
          checklistErrorText.textContent = result.error || 'Failed to update checklist';
          showChecklistState('error');
        }
      } catch (err) {
        checklistErrorText.textContent = err.message || 'An error occurred';
        showChecklistState('error');
      }
    });

    downloadChecklistBtn.addEventListener('click', async () => {
      if (checklistOutputPath) {
        await ipcRenderer.invoke('open-file', checklistOutputPath);
      }
    });

    function resetChecklistState() {
      checklistDocPath = null;
      checklistEmailPath = null;
      checklistOutputPath = null;
      checklistDocSelected.textContent = '';
      checklistEmailSelected.textContent = '';
      checklistDocDrop.classList.remove('selected');
      checklistEmailDrop.classList.remove('selected');
      clearChecklistDoc.classList.remove('visible');
      clearChecklistEmail.classList.remove('visible');
      updateChecklistButton();
      showChecklistState('idle');
    }

    checklistResetBtn.addEventListener('click', resetChecklistState);
    checklistRetryBtn.addEventListener('click', resetChecklistState);

    ipcRenderer.on('checklist-progress', (event, data) => {
      checklistProgressText.textContent = data.message;
      checklistProgressFill.style.width = data.percent + '%';
    });

    // ========== GENERATE PUNCHLIST TAB ==========
    const punchlistChecklistDrop = document.getElementById('punchlistChecklistDrop');
    const punchlistChecklistSelected = document.getElementById('punchlistChecklistSelected');
    const clearPunchlistChecklist = document.getElementById('clearPunchlistChecklist');
    const generatePunchlistBtn = document.getElementById('generatePunchlistBtn');
    const punchlistSetup = document.getElementById('punchlistSetup');
    const punchlistProcessing = document.getElementById('punchlistProcessing');
    const punchlistComplete = document.getElementById('punchlistComplete');
    const punchlistError = document.getElementById('punchlistError');
    const punchlistProgressText = document.getElementById('punchlistProgressText');
    const punchlistProgressFill = document.getElementById('punchlistProgressFill');
    const punchlistResultText = document.getElementById('punchlistResultText');
    const punchlistErrorText = document.getElementById('punchlistErrorText');
    const downloadPunchlistBtn = document.getElementById('downloadPunchlistBtn');
    const punchlistResetBtn = document.getElementById('punchlistResetBtn');
    const punchlistRetryBtn = document.getElementById('punchlistRetryBtn');

    let punchlistChecklistPath = null;
    let punchlistOutputPath = null;

    function showPunchlistState(state) {
      punchlistSetup.style.display = state === 'idle' ? 'block' : 'none';
      punchlistProcessing.classList.toggle('visible', state === 'processing');
      punchlistComplete.classList.toggle('visible', state === 'complete');
      punchlistError.classList.toggle('visible', state === 'error');
    }

    function updatePunchlistButton() {
      generatePunchlistBtn.disabled = !punchlistChecklistPath;
    }

    // Punchlist checklist drop
    punchlistChecklistDrop.addEventListener('click', async (e) => {
      if (e.target === clearPunchlistChecklist) return;
      const result = await ipcRenderer.invoke('select-file', { filters: [{ name: 'Word Documents', extensions: ['docx'] }] });
      if (result) {
        punchlistChecklistPath = result;
        punchlistChecklistSelected.textContent = result.split(/[\\/]/).pop();
        punchlistChecklistDrop.classList.add('selected');
        clearPunchlistChecklist.classList.add('visible');
        updatePunchlistButton();
      }
    });

    punchlistChecklistDrop.addEventListener('dragover', (e) => { e.preventDefault(); punchlistChecklistDrop.classList.add('drag-over'); });
    punchlistChecklistDrop.addEventListener('dragleave', () => { punchlistChecklistDrop.classList.remove('drag-over'); });
    punchlistChecklistDrop.addEventListener('drop', (e) => {
      e.preventDefault();
      punchlistChecklistDrop.classList.remove('drag-over');
      const file = e.dataTransfer.files[0];
      if (file && file.name.toLowerCase().endsWith('.docx')) {
        punchlistChecklistPath = file.path;
        punchlistChecklistSelected.textContent = file.name;
        punchlistChecklistDrop.classList.add('selected');
        clearPunchlistChecklist.classList.add('visible');
        updatePunchlistButton();
      }
    });

    // Clear punchlist checklist
    clearPunchlistChecklist.addEventListener('click', (e) => {
      e.stopPropagation();
      punchlistChecklistPath = null;
      punchlistChecklistSelected.textContent = '';
      punchlistChecklistDrop.classList.remove('selected');
      clearPunchlistChecklist.classList.remove('visible');
      updatePunchlistButton();
    });

    // Generate punchlist button
    generatePunchlistBtn.addEventListener('click', async () => {
      if (!punchlistChecklistPath) return;

      // Get selected status filters
      const statusCheckboxes = document.querySelectorAll('input[name="punchlistStatus"]:checked');
      const selectedStatuses = Array.from(statusCheckboxes).map(cb => cb.value);

      showPunchlistState('processing');
      punchlistProgressFill.style.width = '0%';
      punchlistProgressText.textContent = 'Analyzing checklist...';

      try {
        const result = await ipcRenderer.invoke('generate-punchlist', {
          checklistPath: punchlistChecklistPath,
          statusFilters: selectedStatuses
        });

        if (result.success) {
          punchlistOutputPath = result.outputPath;
          punchlistResultText.textContent = `Generated punchlist with ${result.itemCount || 0} open items`;
          showPunchlistState('complete');
          logUsage('generate_punchlist', 'complete', 1, result.itemCount || 0);
        } else {
          punchlistErrorText.textContent = result.error || 'Failed to generate punchlist';
          showPunchlistState('error');
        }
      } catch (err) {
        punchlistErrorText.textContent = err.message || 'An error occurred';
        showPunchlistState('error');
      }
    });

    downloadPunchlistBtn.addEventListener('click', async () => {
      if (punchlistOutputPath) {
        await ipcRenderer.invoke('open-file', punchlistOutputPath);
      }
    });

    function resetPunchlistState() {
      punchlistChecklistPath = null;
      punchlistOutputPath = null;
      punchlistChecklistSelected.textContent = '';
      punchlistChecklistDrop.classList.remove('selected');
      clearPunchlistChecklist.classList.remove('visible');
      updatePunchlistButton();
      showPunchlistState('idle');
    }

    punchlistResetBtn.addEventListener('click', resetPunchlistState);
    punchlistRetryBtn.addEventListener('click', resetPunchlistState);

    ipcRenderer.on('punchlist-progress', (event, data) => {
      punchlistProgressText.textContent = data.message;
      punchlistProgressFill.style.width = data.percent + '%';
    });
  </script>
</body>
</html>
